{% extends "base.html" %}

{% block title %}任务管理 - MAA 任务调度器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-list-task"></i> 任务管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="createTask()">
                <i class="bi bi-plus-circle"></i> 新建任务
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadTasks()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>
    </div>
</div>

<!-- 任务过滤器 -->
<div class="row mb-3">
    <div class="col-md-4">
        <input type="text" class="form-control" id="task-search" placeholder="搜索任务名称...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="status-filter">
            <option value="">所有状态</option>
            <option value="pending">待执行</option>
            <option value="running">执行中</option>
            <option value="completed">已完成</option>
            <option value="failed">失败</option>
            <option value="cancelled">已取消</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="group-filter">
            <option value="">所有资源分组</option>
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
            <i class="bi bi-x-circle"></i> 清除
        </button>
    </div>
</div>

<!-- 任务列表 -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>任务名称</th>
                        <th>状态</th>
                        <th>优先级</th>
                        <th>资源分组</th>
                        <th>触发类型</th>
                        <th>下次执行</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="tasks-table-body">
                    <!-- 任务数据将动态加载 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 创建任务模态框 -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新建任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="task-form">
                <div class="modal-body">
                    <!-- 基本信息 -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">任务名称 *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">优先级</label>
                            <select class="form-select" name="priority">
                                <option value="1">1 (最高)</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5" selected>5 (默认)</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 (最低)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">任务描述</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">资源分组 *</label>
                            <select class="form-select" name="resource_group" id="resource-group-select" required>
                                <!-- 动态加载 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">触发类型 *</label>
                            <select class="form-select" name="trigger_type" id="trigger-type-select" required>
                                <option value="cron">Cron 定时</option>
                                <option value="interval">间隔执行</option>
                                <option value="random">随机时间</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 触发配置 -->
                    <div id="trigger-config">
                        <!-- Cron 触发器 -->
                        <div id="cron-config" class="trigger-config mb-3">
                            <label class="form-label">Cron 表达式</label>
                            <input type="text" class="form-control" name="cron_expression" placeholder="例如: 0 9 * * * (每天9点)">
                            <small class="form-text text-muted">
                                格式: 秒 分 时 日 月 周年 
                                <a href="https://crontab.guru/" target="_blank">在线生成器</a>
                            </small>
                        </div>
                        
                        <!-- 间隔触发器 -->
                        <div id="interval-config" class="trigger-config mb-3" style="display: none;">
                            <label class="form-label">间隔时间 (秒)</label>
                            <input type="number" class="form-control" name="interval_seconds" min="60" placeholder="3600">
                            <small class="form-text text-muted">最小间隔 60 秒</small>
                        </div>
                        
                        <!-- 随机触发器 -->
                        <div id="random-config" class="trigger-config mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">开始时间</label>
                                    <input type="time" class="form-control" name="random_start_time">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">结束时间</label>
                                    <input type="time" class="form-control" name="random_end_time">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 模拟器任务配置 -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_emulator_task" id="is-emulator-task">
                            <label class="form-check-label" for="is-emulator-task">
                                这是一个模拟器任务
                            </label>
                        </div>
                    </div>
                    
                    <div id="emulator-config" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">设备 ID</label>
                                <input type="text" class="form-control" name="emulator_device_id" placeholder="模拟器设备ID">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">目标分辨率</label>
                                <input type="text" class="form-control" name="target_resolution" placeholder="1920x1080">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">启动应用</label>
                                <input type="text" class="form-control" name="startup_app" placeholder="应用包名">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 任务命令 -->
                    <div class="mb-3">
                        <label class="form-label">执行命令 *</label>
                        <input type="text" class="form-control" name="main_command" required placeholder="要执行的命令">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">工作目录</label>
                        <input type="text" class="form-control" name="working_directory" placeholder="留空使用当前目录">
                    </div>
                    
                    <!-- 日志配置 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="enable_global_log" id="enable-global-log" checked>
                                <label class="form-check-label" for="enable-global-log">
                                    启用全局日志
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="enable_temp_log" id="enable-temp-log">
                                <label class="form-check-label" for="enable-temp-log">
                                    启用临时日志
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 通知配置 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="notify_on_success" id="notify-on-success">
                                <label class="form-check-label" for="notify-on-success">
                                    成功时通知
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="notify_on_failure" id="notify-on-failure" checked>
                                <label class="form-check-label" for="notify-on-failure">
                                    失败时通知
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">创建任务</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="task-detail-content">
                <!-- 任务详情内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="run-task-btn" style="display: none;">立即执行</button>
                <button type="button" class="btn btn-warning" id="cancel-task-btn" style="display: none;">取消任务</button>
            </div>
        </div>
    </div>
</div>

<!-- 任务创建/编辑模态框 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">创建任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId" name="id">
                    
                    <!-- 基本信息 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">任务名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="taskName" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">任务类型</label>
                            <select class="form-select" id="taskType" name="task_type" onchange="toggleAdbOption()">
                                <option value="console">控制台任务</option>
                                <option value="maa">MAA 任务</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">任务描述</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <!-- 执行配置 -->
                    <h6 class="mb-3"><i class="bi bi-terminal"></i> 执行配置</h6>
                    <div class="mb-3">
                        <label class="form-label">命令 <span class="text-danger">*</span></label>
                        <textarea class="form-control font-monospace" id="mainCommand" name="main_command" 
                                  rows="3" placeholder="输入要执行的完整命令" required></textarea>
                        <small class="form-text text-muted">支持复杂的 MAA 命令，请手动输入完整的命令行</small>
                    </div>
                    
                    <!-- ADB唤醒选项（仅MAA任务显示） -->
                    <div id="adbWakeupOption" style="display: none;">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="enableAdbWakeup" name="enable_adb_wakeup">
                            <label class="form-check-label" for="enableAdbWakeup">
                                启用 ADB 唤醒屏幕
                            </label>
                            <small class="form-text text-muted d-block">执行任务前自动唤醒模拟器屏幕</small>
                        </div>
                        <div id="emulatorConfig" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">模拟器设备ID</label>
                                    <input type="text" class="form-control" id="emulatorDeviceId" name="emulator_device_id" 
                                           placeholder="127.0.0.1:5555">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">目标分辨率</label>
                                    <input type="text" class="form-control" id="targetResolution" name="target_resolution" 
                                           placeholder="1920x1080">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 调度配置 -->
                    <h6 class="mb-3"><i class="bi bi-clock"></i> 调度配置</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">触发类型</label>
                            <select class="form-select" id="triggerType" name="trigger_type" onchange="changeTriggerType()">
                                <option value="timed">定时执行</option>
                                <option value="interval">间隔执行</option>
                                <option value="random">随机时间执行</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">优先级</label>
                            <select class="form-select" id="taskPriority" name="priority">
                                <option value="1">低 (1)</option>
                                <option value="5" selected>正常 (5)</option>
                                <option value="10">高 (10)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">资源分组</label>
                            <select class="form-select" id="resourceGroup" name="resource_group">
                                <option value="default">默认分组</option>
                                <option value="general">通用任务分组</option>
                                <option value="camera">摄像头设备分组</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 触发器配置 -->
                    <div id="timedConfig" class="trigger-config">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 定时执行：支持在用户设定的固定时间段内执行任务（例如，每天 9:00-18:00）
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="useCronExpression" name="use_cron" onchange="toggleCronExpression()">
                            <label class="form-check-label" for="useCronExpression">
                                使用精确的 Cron 表达式
                            </label>
                        </div>
                        <div id="timeRangeDiv">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">开始时间</label>
                                    <input type="time" class="form-control" id="timedStartTime" name="start_time" value="09:00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">结束时间</label>
                                    <input type="time" class="form-control" id="timedEndTime" name="end_time" value="18:00">
                                </div>
                            </div>
                        </div>
                        <div id="cronExpressionDiv" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Cron 表达式</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cronExpression" name="cron_expression" placeholder="0 9 * * *">
                                    <button class="btn btn-outline-secondary" type="button" onclick="showCronHelper()">
                                        <i class="bi bi-question-circle"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">格式: 分 时 日 月 周 (例: 0 9 * * * 表示每天9点)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="intervalConfig" class="trigger-config" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 间隔执行：基于上次执行完成时间，在设定的间隔后再次执行（例如，每 2 小时执行一次）
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">间隔小时数</label>
                                <input type="number" class="form-control" id="intervalHours" name="interval_hours" value="2" min="1" max="168">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">时间单位</label>
                                <select class="form-select" id="intervalUnit" name="interval_unit">
                                    <option value="seconds">秒</option>
                                    <option value="minutes">分钟</option>
                                    <option value="hours">小时</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="random_timeConfig" class="trigger-config" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 随机时间：在指定时间段内随机选择一个时间点执行（如10:00-12:00内随机执行）。
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">开始时间</label>
                                <input type="time" class="form-control" id="randomStartTime" name="random_start_time" value="10:00">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">结束时间</label>
                                <input type="time" class="form-control" id="randomEndTime" name="random_end_time" value="12:00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 执行配置 -->
                    <h6 class="mb-3"><i class="bi bi-play-circle"></i> 执行配置</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">MAA 配置文件</label>
                            <input type="text" class="form-control" id="maaConfig" name="maa_config" placeholder="config.json">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">任务参数</label>
                            <input type="text" class="form-control" id="taskArgs" name="task_args" placeholder="启动 刷理智">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="taskEnabled" name="enabled" checked>
                                <label class="form-check-label" for="taskEnabled">启用任务</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="allowConcurrent" name="allow_concurrent">
                                <label class="form-check-label" for="allowConcurrent">允许并发</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableNotification" name="enable_notification">
                                <label class="form-check-label" for="enableNotification">启用通知</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 高级配置 -->
                    <div class="accordion mb-3" id="advancedConfig">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="advancedHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#advancedCollapse" aria-expanded="false">
                                    <i class="bi bi-gear me-2"></i> 高级配置
                                </button>
                            </h2>
                            <div id="advancedCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedConfig">
                                <div class="accordion-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">超时时间 (秒)</label>
                                            <input type="number" class="form-control" id="taskTimeout" name="timeout" value="3600" min="60">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">重试次数</label>
                                            <input type="number" class="form-control" id="retryCount" name="retry_count" value="0" min="0" max="5">
                                        </div>
                                    </div>
                                    
                                    <!-- 日志配置 -->
                                    <h6 class="mt-4 mb-3"><i class="bi bi-file-text"></i> 日志配置</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableGlobalLog" name="enable_global_log" checked>
                                                <label class="form-check-label" for="enableGlobalLog">
                                                    启用全局日志
                                                </label>
                                                <small class="form-text text-muted d-block">将任务日志实时输出到程序的统一日志中</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="enableTempLog" name="enable_temp_log" onchange="toggleTempLogOptions()">
                                                <label class="form-check-label" for="enableTempLog">
                                                    启用临时日志
                                                </label>
                                                <small class="form-text text-muted d-block">暂时记录日志到独立文件，供后续分析</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 后置任务配置 -->
                                    <h6 class="mt-4 mb-3"><i class="bi bi-arrow-right-circle"></i> 后置任务配置</h6>
                                    
                                    <!-- 基本通知配置 -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="notifyOnSuccess" name="notify_on_success" onchange="toggleNotificationConfig('success')">
                                                <label class="form-check-label" for="notifyOnSuccess">
                                                    <strong>成功时推送通知</strong>
                                                </label>
                                                <small class="form-text text-muted d-block">当任务返回"成功"状态时触发推送</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="notifyOnFailure" name="notify_on_failure" onchange="toggleNotificationConfig('failure')">
                                                <label class="form-check-label" for="notifyOnFailure">
                                                    <strong>失败时推送通知</strong>
                                                </label>
                                                <small class="form-text text-muted d-block">当任务返回"失败"状态时触发推送</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 成功通知配置 -->
                                    <div id="successNotificationConfig" style="display: none;" class="border rounded p-3 mb-3">
                                        <h6 class="text-success mb-3"><i class="bi bi-check-circle"></i> 成功通知配置</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">推送标题</label>
                                                <input type="text" class="form-control" id="successTitle" name="success_title" 
                                                       placeholder="任务执行成功 - {task_name}">
                                                <small class="form-text text-muted">支持变量: {task_name}, {timestamp}</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">推送标签</label>
                                                <input type="text" class="form-control" id="successTag" name="success_tag" 
                                                       placeholder="MAA,任务,成功">
                                                <small class="form-text text-muted">用逗号分隔多个标签</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">推送内容</label>
                                            <textarea class="form-control" id="successContent" name="success_content" rows="3"
                                                      placeholder="任务 {task_name} 于 {timestamp} 执行成功。&#10;执行时长: {duration}&#10;状态: 正常完成"></textarea>
                                            <small class="form-text text-muted">支持变量: {task_name}, {timestamp}, {duration}, {output}</small>
                                        </div>
                                    </div>
                                    
                                    <!-- 失败通知配置 -->
                                    <div id="failureNotificationConfig" style="display: none;" class="border rounded p-3 mb-3">
                                        <h6 class="text-danger mb-3"><i class="bi bi-x-circle"></i> 失败通知配置</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">推送标题</label>
                                                <input type="text" class="form-control" id="failureTitle" name="failure_title" 
                                                       placeholder="任务执行失败 - {task_name}">
                                                <small class="form-text text-muted">支持变量: {task_name}, {timestamp}</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">推送标签</label>
                                                <input type="text" class="form-control" id="failureTag" name="failure_tag" 
                                                       placeholder="MAA,任务,失败">
                                                <small class="form-text text-muted">用逗号分隔多个标签</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">推送内容</label>
                                            <textarea class="form-control" id="failureContent" name="failure_content" rows="3"
                                                      placeholder="任务 {task_name} 于 {timestamp} 执行失败。&#10;错误信息: {error_message}&#10;请检查配置和日志"></textarea>
                                            <small class="form-text text-muted">支持变量: {task_name}, {timestamp}, {duration}, {error_message}, {output}</small>
                                        </div>
                                    </div>
                                    
                                    <!-- 关键词监控配置 -->
                                    <div id="tempLogOptions" style="display: none;">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableKeywordMonitoring" name="enable_keyword_monitoring" onchange="toggleKeywordConfig()">
                                            <label class="form-check-label" for="enableKeywordMonitoring">
                                                <strong>启用日志关键词监控</strong>
                                            </label>
                                            <small class="form-text text-muted d-block">抓取日志中的关键词，匹配时触发自定义推送</small>
                                        </div>
                                        
                                        <div id="keywordMonitoringConfig" style="display: none;" class="border rounded p-3 mb-3">
                                            <h6 class="text-warning mb-3"><i class="bi bi-search"></i> 关键词监控配置</h6>
                                            <div class="mb-3">
                                                <label class="form-label">监控关键词</label>
                                                <input type="text" class="form-control" id="logKeywords" name="log_keywords" 
                                                       placeholder="错误,完成,timeout,success (用逗号分隔)">
                                                <small class="form-text text-muted">在临时日志中查找这些关键词，匹配时触发通知</small>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">推送标题</label>
                                                    <input type="text" class="form-control" id="keywordTitle" name="keyword_title" 
                                                           placeholder="关键词触发 - {task_name}">
                                                    <small class="form-text text-muted">支持变量: {task_name}, {keywords}</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">推送标签</label>
                                                    <input type="text" class="form-control" id="keywordTag" name="keyword_tag" 
                                                           placeholder="MAA,关键词,监控">
                                                    <small class="form-text text-muted">用逗号分隔多个标签</small>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">推送内容</label>
                                                <textarea class="form-control" id="keywordContent" name="keyword_content" rows="3"
                                                          placeholder="任务 {task_name} 的日志中发现关键词: {matched_keywords}&#10;匹配行: {matched_lines}&#10;时间: {timestamp}"></textarea>
                                                <small class="form-text text-muted">支持变量: {task_name}, {matched_keywords}, {matched_lines}, {timestamp}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">保存任务</button>
            </div>
        </div>
    </div>
</div>

<!-- Cron 表达式帮助模态框 -->
<div class="modal fade" id="cronHelperModal" tabindex="-1" aria-labelledby="cronHelperModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cronHelperModalLabel">Cron 表达式帮助</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>字段</th>
                                <th>说明</th>
                                <th>值域</th>
                                <th>特殊字符</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>分钟</td>
                                <td>分钟</td>
                                <td>0-59</td>
                                <td>, - * /</td>
                            </tr>
                            <tr>
                                <td>小时</td>
                                <td>小时</td>
                                <td>0-23</td>
                                <td>, - * /</td>
                            </tr>
                            <tr>
                                <td>日期</td>
                                <td>月份中的日期</td>
                                <td>1-31</td>
                                <td>, - * / ? L W</td>
                            </tr>
                            <tr>
                                <td>月份</td>
                                <td>月份</td>
                                <td>1-12 或 JAN-DEC</td>
                                <td>, - * /</td>
                            </tr>
                            <tr>
                                <td>星期</td>
                                <td>星期几</td>
                                <td>0-6 或 SUN-SAT</td>
                                <td>, - * / ? L #</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h6>常用示例：</h6>
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action" onclick="setCronExpression('0 9 * * *')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">0 9 * * *</h6>
                        </div>
                        <p class="mb-1">每天上午9点执行</p>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="setCronExpression('0 */2 * * *')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">0 */2 * * *</h6>
                        </div>
                        <p class="mb-1">每2小时执行一次</p>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="setCronExpression('0 9 * * 1-5')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">0 9 * * 1-5</h6>
                        </div>
                        <p class="mb-1">工作日上午9点执行</p>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="setCronExpression('0 0 */3 * *')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">0 0 */3 * *</h6>
                        </div>
                        <p class="mb-1">每3天午夜执行</p>
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let tasks = [];
    let resourceGroups = {};
    let filteredTasks = [];
    let currentTaskId = null;

    const escapeHtml = (value) => {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    };

    function getStatusColor(status) {
        const colors = {
            pending: 'secondary',
            running: 'success',
            completed: 'primary',
            failed: 'danger',
            cancelled: 'warning'
        };
        return colors[status] || 'secondary';
    }

    function getStatusText(status) {
        const texts = {
            pending: '待执行',
            running: '执行中',
            completed: '已完成',
            failed: '失败',
            cancelled: '已取消'
        };
        return texts[status] || status || '-';
    }

    function formatDateTime(value) {
        if (!value) {
            return '-';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return '-';
        }
        return date.toLocaleString();
    }

    // 加载任务列表
    async function loadTasks() {
        try {
            tasks = await apiRequest('/api/tasks');
            filteredTasks = tasks;
            updateTasksTable();
        } catch (error) {
            console.error('加载任务列表失败:', error);
        }
    }

    // 加载资源分组
    async function loadResourceGroups() {
        try {
            resourceGroups = await apiRequest('/api/resource-groups');
            updateResourceGroupSelects();
        } catch (error) {
            console.error('加载资源分组失败:', error);
        }
    }

    // 更新资源分组选择器
    function updateResourceGroupSelects() {
        const selects = document.querySelectorAll('#resource-group-select, #group-filter');
        selects.forEach(select => {
            if (select.id === 'group-filter') {
                select.innerHTML = '<option value="">所有资源分组</option>';
            } else {
                select.innerHTML = '';
            }
            
            Object.values(resourceGroups).forEach(group => {
                const option = document.createElement('option');
                option.value = group.name;
                option.textContent = `${group.name} (${group.description})`;
                select.appendChild(option);
            });
        });
    }

    // 更新任务表格
    function updateTasksTable() {
        const tbody = document.getElementById('tasks-table-body');
        
        if (filteredTasks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">暂无任务</td>
                </tr>
            `;
            return;
        }

        let html = '';
        filteredTasks.forEach(task => {
            const statusColor = getStatusColor(task.status);
            const statusText = getStatusText(task.status);
            const triggerType = task.trigger?.trigger_type || task.trigger_type;
            const nextRunTime = formatDateTime(task.next_run_time);

            html += `
                <tr>
                    <td>
                        <div>
                            <strong>${escapeHtml(task.name)}</strong>
                            ${task.description ? `<br><small class="text-muted">${escapeHtml(task.description)}</small>` : ''}
                        </div>
                    </td>
                    <td><span class="badge bg-${statusColor}">${statusText}</span></td>
                    <td><span class="badge bg-secondary">${task.priority}</span></td>
                    <td><span class="badge bg-info">${escapeHtml(task.resource_group)}</span></td>
                    <td>${getTriggerTypeText(triggerType)}</td>
                    <td><small>${nextRunTime}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewTask('${task.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${task.status === 'running' 
                                ? `<button class="btn btn-outline-warning" onclick="cancelTask('${task.id}')">
                                     <i class="bi bi-stop"></i>
                                   </button>`
                                : `<button class="btn btn-outline-success" onclick="runTask('${task.id}')" ${systemStatus.mode !== 'single_task' ? 'disabled' : ''}>
                                     <i class="bi bi-play"></i>
                                   </button>`
                            }
                            <button class="btn btn-outline-secondary" onclick="editTask('${task.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteTask('${task.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // 获取触发器类型文本
    function getTriggerTypeText(type) {
        const types = {
            'scheduled': '定时执行',
            'interval': '间隔执行',
            'random_time': '随机时间'
        };
        return types[type] || type || '-';
    }

    // 过滤任务
    function filterTasks() {
        const search = document.getElementById('task-search').value.toLowerCase();
        const status = document.getElementById('status-filter').value;
        const group = document.getElementById('group-filter').value;

        filteredTasks = tasks.filter(task => {
            let match = true;
            
            if (search && !task.name.toLowerCase().includes(search)) {
                match = false;
            }
            
            if (status && task.status !== status) {
                match = false;
            }
            
            if (group && task.resource_group !== group) {
                match = false;
            }
            
            return match;
        });

        updateTasksTable();
    }

    // 清除过滤器
    function clearFilters() {
        document.getElementById('task-search').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('group-filter').value = '';
        filteredTasks = tasks;
        updateTasksTable();
    }

    // 查看任务详情
    async function viewTask(taskId) {
        try {
            const taskConfig = await apiRequest(`/api/tasks/${taskId}`);
            const taskFromList = tasks.find(t => t.id === taskId);
            const status = taskFromList ? taskFromList.status : 'pending';
            const trigger = taskConfig.trigger || {};

            currentTaskId = taskId;

            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><th>名称</th><td>${escapeHtml(taskConfig.name)}</td></tr>
                            <tr><th>描述</th><td>${escapeHtml(taskConfig.description) || '-'}</td></tr>
                            <tr><th>优先级</th><td>${taskConfig.priority}</td></tr>
                            <tr><th>资源分组</th><td>${escapeHtml(taskConfig.resource_group)}</td></tr>
                            <tr><th>状态</th><td><span class="badge bg-${getStatusColor(status)}">${getStatusText(status)}</span></td></tr>
                            <tr><th>下次执行</th><td>${taskFromList ? formatDateTime(taskFromList.next_run_time) : '-'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>触发配置</h6>
                        <table class="table table-sm">
                            <tr><th>触发类型</th><td>${getTriggerTypeText(trigger.trigger_type)}</td></tr>
            `;

            if (trigger.trigger_type === 'scheduled') {
                html += `<tr><th>开始时间</th><td>${trigger.start_time || '-'}</td></tr>`;
                html += `<tr><th>结束时间</th><td>${trigger.end_time || '-'}</td></tr>`;
            } else if (trigger.trigger_type === 'interval') {
                html += `<tr><th>间隔分钟</th><td>${trigger.interval_minutes ?? '-'} 分钟</td></tr>`;
            } else if (trigger.trigger_type === 'random_time') {
                html += `<tr><th>随机范围</th><td>${trigger.random_start_time || '-'} ~ ${trigger.random_end_time || '-'}</td></tr>`;
            }

            html += `
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>执行配置</h6>
                        <table class="table table-sm">
                            <tr><th>执行命令</th><td><code>${escapeHtml(taskConfig.main_command)}</code></td></tr>
                            <tr><th>启用ADB唤醒</th><td>${taskConfig.enable_adb_wakeup ? '是' : '否'}</td></tr>
                            <tr><th>ADB设备ID</th><td>${escapeHtml(taskConfig.adb_device_id) || '-'}</td></tr>
                            <tr><th>全局日志</th><td>${taskConfig.enable_global_log ? '是' : '否'}</td></tr>
                            <tr><th>临时日志</th><td>${taskConfig.enable_temp_log ? '是' : '否'}</td></tr>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('task-detail-content').innerHTML = html;

            const runBtn = document.getElementById('run-task-btn');
            const cancelBtn = document.getElementById('cancel-task-btn');

            if (status === 'running') {
                runBtn.style.display = 'none';
                cancelBtn.style.display = 'inline-block';
            } else if (systemStatus.mode === 'single_task') {
                runBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'none';
            } else {
                runBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            }

            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();

        } catch (error) {
            console.error('加载任务详情失败:', error);
        }
    }

    // 执行任务
    async function runTask(taskId) {
        if (systemStatus.mode !== 'single_task') {
            showToast('必须在单任务模式下才能手动执行任务', 'warning');
            return;
        }

        try {
            await apiRequest(`/api/tasks/${taskId}/run`, { method: 'POST' });
            showToast('任务开始执行', 'success');
            loadTasks();
        } catch (error) {
            console.error('执行任务失败:', error);
        }
    }

    // 取消任务
    async function cancelTask(taskId) {
        if (confirm('确定要取消这个任务吗？')) {
            try {
                await apiRequest(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
                showToast('任务已取消', 'success');
                loadTasks();
            } catch (error) {
                console.error('取消任务失败:', error);
            }
        }
    }

    // 删除任务
    async function deleteTask(taskId) {
        if (confirm('确定要删除这个任务吗？此操作不可恢复。')) {
            try {
                await apiRequest(`/api/tasks/${taskId}`, { method: 'DELETE' });
                showToast('任务已删除', 'success');
                loadTasks();
            } catch (error) {
                console.error('删除任务失败:', error);
            }
        }
    }

    // 编辑任务
    function editTask(taskId) {
        // 从任务列表中找到对应任务并填充表单
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            populateTaskForm(task);
            document.getElementById('taskModalLabel').textContent = '编辑任务';
            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }
    }

    // 创建新任务
    function createTask() {
        resetTaskForm();
        document.getElementById('taskModalLabel').textContent = '创建任务';
        const modal = new bootstrap.Modal(document.getElementById('taskModal'));
        modal.show();
    }

    // 重置任务表单
    function resetTaskForm() {
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskEnabled').checked = true;
        showTriggerConfig('scheduled');
        
        // 隐藏所有通知配置
        showNotificationConfig('success', false);
        showNotificationConfig('failure', false);
        showNotificationConfig('keywordMonitoring', false);
        
        // 隐藏Cron表达式
        document.getElementById('cronExpressionDiv').style.display = 'none';
        document.getElementById('useCronExpression').checked = false;
    }

    // 填充任务表单
    function populateTaskForm(task) {
        document.getElementById('taskId').value = task.id;
        document.getElementById('taskName').value = task.name;
        document.getElementById('taskDescription').value = task.description || '';
        document.getElementById('taskType').value = task.type || 'maa_task';
        document.getElementById('triggerType').value = task.trigger_type;
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('resourceGroup').value = task.resource_group || 'default';
        document.getElementById('taskEnabled').checked = task.enabled;
        
        // 根据触发类型显示相应配置
        showTriggerConfig(task.trigger_type);
        
        // 填充触发器配置
        if (task.trigger_type === 'cron') {
            document.getElementById('cronExpression').value = task.cron_expression || '';
        } else if (task.trigger_type === 'interval') {
            document.getElementById('intervalTime').value = task.interval_time || 60;
            document.getElementById('intervalUnit').value = task.interval_unit || 'minutes';
        } else if (task.trigger_type === 'random') {
            document.getElementById('minInterval').value = task.min_interval || 30;
            document.getElementById('maxInterval').value = task.max_interval || 120;
        }
        
        // 填充执行配置
        document.getElementById('maaConfig').value = task.maa_config || '';
        document.getElementById('taskArgs').value = task.task_args || '';
        document.getElementById('allowConcurrent').checked = task.allow_concurrent || false;
        document.getElementById('notifyOnComplete').checked = task.notify_on_complete || false;
        
        // 填充高级配置
        document.getElementById('taskTimeout').value = task.timeout || 3600;
        document.getElementById('retryCount').value = task.retry_count || 0;
        document.getElementById('preCommands').value = task.pre_commands ? task.pre_commands.join('\n') : '';
        document.getElementById('postCommands').value = task.post_commands ? task.post_commands.join('\n') : '';
    }

    // 显示对应的触发器配置
    function showTriggerConfig(triggerType) {
        const configs = document.querySelectorAll('.trigger-config');
        configs.forEach(config => {
            config.style.display = 'none';
        });
        
        const targetConfig = document.getElementById(triggerType + 'Config');
        if (targetConfig) {
            targetConfig.style.display = 'block';
        }
    }
    
    // 显示通知配置
    function showNotificationConfig(type, show) {
        const configDiv = document.getElementById(type + 'NotificationConfig');
        if (configDiv) {
            configDiv.style.display = show ? 'block' : 'none';
        }
    }

    // 保存任务
    async function saveTask() {
        const form = document.getElementById('taskForm');
        const formData = new FormData(form);
        const taskData = {};
        
        // 转换表单数据
        for (const [key, value] of formData.entries()) {
            if (value !== '') {
                if (key.includes('_') && (key.endsWith('count') || key.endsWith('time') || key.endsWith('interval') || key === 'priority' || key === 'timeout')) {
                    taskData[key] = parseInt(value);
                } else if (key === 'enabled' || key === 'allow_concurrent' || key === 'notify_on_complete') {
                    taskData[key] = true;
                } else {
                    taskData[key] = value;
                }
            }
        }
        
        // 处理未选中的复选框
        const checkboxes = ['enabled', 'allow_concurrent', 'notify_on_complete'];
        checkboxes.forEach(checkbox => {
            if (!formData.has(checkbox)) {
                taskData[checkbox] = false;
            }
        });
        
        // 处理命令列表
        if (taskData.pre_commands) {
            taskData.pre_commands = taskData.pre_commands.split('\n').filter(cmd => cmd.trim());
        }
        if (taskData.post_commands) {
            taskData.post_commands = taskData.post_commands.split('\n').filter(cmd => cmd.trim());
        }
        
        try {
            const taskId = document.getElementById('taskId').value;
            const url = taskId ? `/api/tasks/${taskId}` : '/api/tasks';
            const method = taskId ? 'PUT' : 'POST';
            
            await apiRequest(url, {
                method: method,
                body: JSON.stringify(taskData)
            });
            
            showToast(taskId ? '任务更新成功' : '任务创建成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            loadTasks();
        } catch (error) {
            console.error('保存任务失败:', error);
        }
    }

    // 显示 Cron 帮助
    function showCronHelper() {
        const modal = new bootstrap.Modal(document.getElementById('cronHelperModal'));
        modal.show();
    }

    // 设置 Cron 表达式
    function setCronExpression(expression) {
        document.getElementById('cronExpression').value = expression;
        bootstrap.Modal.getInstance(document.getElementById('cronHelperModal')).hide();
    }

    // 切换ADB选项显示
    function toggleAdbOption() {
        const taskType = document.getElementById('taskType').value;
        const adbOption = document.getElementById('adbWakeupOption');
        if (taskType === 'maa') {
            adbOption.style.display = 'block';
        } else {
            adbOption.style.display = 'none';
            document.getElementById('enableAdbWakeup').checked = false;
            toggleEmulatorConfig();
        }
    }

    // 切换模拟器配置显示
    function toggleEmulatorConfig() {
        const enableAdb = document.getElementById('enableAdbWakeup').checked;
        const emulatorConfig = document.getElementById('emulatorConfig');
        emulatorConfig.style.display = enableAdb ? 'block' : 'none';
    }

    // 切换触发器类型
    function changeTriggerType() {
        const triggerType = document.getElementById('triggerType').value;
        showTriggerConfig(triggerType);
    }

    // 切换Cron表达式显示
    function toggleCronExpression() {
        const useCron = document.getElementById('useCronExpression').checked;
        const timeRangeDiv = document.getElementById('timeRangeDiv');
        const cronExpressionDiv = document.getElementById('cronExpressionDiv');
        
        if (useCron) {
            timeRangeDiv.style.display = 'none';
            cronExpressionDiv.style.display = 'block';
        } else {
            timeRangeDiv.style.display = 'block';
            cronExpressionDiv.style.display = 'none';
        }
    }

    // 切换临时日志选项
    function toggleTempLogOptions() {
        const enableTempLog = document.getElementById('enableTempLog').checked;
        const tempLogOptions = document.getElementById('tempLogOptions');
        tempLogOptions.style.display = enableTempLog ? 'block' : 'none';
        
        if (!enableTempLog) {
            document.getElementById('enableKeywordMonitoring').checked = false;
            toggleKeywordConfig();
        }
    }

    // 切换通知配置显示
    function toggleNotificationConfig(type) {
        const checkbox = document.getElementById(`notifyOn${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const configDiv = document.getElementById(`${type}NotificationConfig`);
        configDiv.style.display = checkbox.checked ? 'block' : 'none';
    }

    // 切换关键词配置显示
    function toggleKeywordConfig() {
        const enableKeyword = document.getElementById('enableKeywordMonitoring').checked;
        const keywordConfig = document.getElementById('keywordMonitoringConfig');
        keywordConfig.style.display = enableKeyword ? 'block' : 'none';
    }

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        loadResourceGroups();
        
        // 绑定ADB唤醒选项变化事件
        document.getElementById('enableAdbWakeup').addEventListener('change', toggleEmulatorConfig);

        // 绑定过滤器事件
        document.getElementById('task-search').addEventListener('input', filterTasks);
        document.getElementById('status-filter').addEventListener('change', filterTasks);
        document.getElementById('group-filter').addEventListener('change', filterTasks);

        // 绑定新任务模态框的触发器类型变化事件
        document.getElementById('triggerType').addEventListener('change', function() {
            showTriggerConfig(this.value);
        });
        
        // 绑定Cron表达式选择框
        document.getElementById('useCronExpression').addEventListener('change', function() {
            document.getElementById('cronExpressionDiv').style.display = this.checked ? 'block' : 'none';
        });
        
        // 绑定通知配置显示控制
        document.getElementById('notifyOnSuccess').addEventListener('change', function() {
            showNotificationConfig('success', this.checked);
        });
        
        document.getElementById('notifyOnFailure').addEventListener('change', function() {
            showNotificationConfig('failure', this.checked);
        });
        
        document.getElementById('keywordNotification').addEventListener('change', function() {
            showNotificationConfig('keywordMonitoring', this.checked);
        });

        // 触发器类型切换
        document.getElementById('trigger-type-select').addEventListener('change', function() {
            const triggerType = this.value;
            document.querySelectorAll('.trigger-config').forEach(el => el.style.display = 'none');
            document.getElementById(`${triggerType}-config`).style.display = 'block';
        });

        // 模拟器任务切换
        document.getElementById('is-emulator-task').addEventListener('change', function() {
            document.getElementById('emulator-config').style.display = this.checked ? 'block' : 'none';
        });

        // 任务表单提交
        document.getElementById('task-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const taskData = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'priority' || key === 'interval_seconds') {
                    taskData[key] = parseInt(value);
                } else if (key === 'is_emulator_task' || key === 'enable_global_log' || 
                          key === 'enable_temp_log' || key === 'notify_on_success' || 
                          key === 'notify_on_failure') {
                    taskData[key] = true;  // 只有选中的checkbox会被发送
                } else {
                    taskData[key] = value;
                }
            }
            
            // 设置未选中的checkbox为false
            ['is_emulator_task', 'enable_global_log', 'enable_temp_log', 'notify_on_success', 'notify_on_failure'].forEach(field => {
                if (!(field in taskData)) {
                    taskData[field] = false;
                }
            });

            try {
                await apiRequest('/api/tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
                
                showToast('任务创建成功', 'success');
                
                // 关闭模态框并重置表单
                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                this.reset();
                
                loadTasks();
                
            } catch (error) {
                console.error('创建任务失败:', error);
            }
        });

        // 任务详情按钮事件
        document.getElementById('run-task-btn').addEventListener('click', function() {
            if (currentTaskId) {
                runTask(currentTaskId);
                bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
            }
        });

        document.getElementById('cancel-task-btn').addEventListener('click', function() {
            if (currentTaskId) {
                cancelTask(currentTaskId);
                bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
            }
        });

        // 定时刷新
        setInterval(loadTasks, 10000);
    });
</script>
{% endblock %}