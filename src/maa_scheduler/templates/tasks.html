{% extends "base.html" %}

{% block title %}任务管理 - MAA 任务调度器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
	<h1 class="h2"><i class="bi bi-list-task me-2"></i><span data-i18n="tasks.title">任务管理</span></h1>
	<div class="btn-toolbar mb-2 mb-md-0">
		<div class="btn-group">
			<button type="button" class="btn btn-sm btn-primary" id="create-task-btn">
				<i class="bi bi-plus-circle"></i> <span data-i18n="tasks.create">新建任务</span>
			</button>
			<button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-task-btn">
				<i class="bi bi-arrow-clockwise"></i> <span data-i18n="tasks.refresh">刷新</span>
			</button>
		</div>
	</div>

	<style>
		.task-modal-body {
			max-height: calc(100vh - 220px);
			overflow-y: auto;
		}

		#taskLogContent {
			background-color: #1e1e1e;
			color: #dcdcdc;
			font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
			font-size: 0.85rem;
			white-space: pre-wrap;
			word-break: break-word;
			max-height: calc(100vh - 200px);
			overflow-y: auto;
			padding: 1rem;
			border-radius: 0.5rem;
		}

		#taskLogHeader small {
			font-size: 0.8rem;
		}
	</style>
</div>

<div class="row g-3 mb-4">
	<div class="col-md-4">
		<div class="input-group">
			<span class="input-group-text"><i class="bi bi-search"></i></span>
			<input type="text" class="form-control" id="task-search" data-i18n-placeholder="tasks.searchPlaceholder" placeholder="搜索任务名称或描述...">
		</div>
	</div>
	<div class="col-md-3">
		<select class="form-select" id="status-filter">
			<option value="" data-i18n="tasks.statusFilter">所有状态</option>
			<option value="pending" data-i18n="status.pending">待执行</option>
			<option value="running" data-i18n="status.running">执行中</option>
			<option value="completed" data-i18n="status.completed">已完成</option>
			<option value="failed" data-i18n="status.failed">失败</option>
			<option value="cancelled" data-i18n="status.cancelled">已取消</option>
		</select>
	</div>
	<div class="col-md-3">
		<select class="form-select" id="group-filter">
			<option value="" data-i18n="tasks.groupFilter">所有资源分组</option>
		</select>
	</div>
	<div class="col-md-2 d-grid">
		<button class="btn btn-outline-secondary" id="clear-filter-btn">
			<i class="bi bi-x-circle"></i> <span data-i18n="tasks.clearFilters">清除筛选</span>
		</button>
	</div>
</div>

<div class="card shadow-sm mb-4">
	<div class="card-body">
		<div class="table-responsive">
			<table class="table table-hover align-middle mb-0">
				<thead class="table-light">
					<tr>
						<th data-i18n="tasks.table.headers.name">任务名称</th>
						<th class="text-center" data-i18n="tasks.table.headers.status">状态</th>
						<th class="text-center" data-i18n="tasks.table.headers.priority">优先级</th>
						<th class="text-center" data-i18n="tasks.table.headers.group">资源分组</th>
						<th class="text-center" data-i18n="tasks.table.headers.trigger">触发类型</th>
						<th class="text-center" data-i18n="tasks.table.headers.next">下次执行</th>
						<th class="text-end" data-i18n="tasks.table.headers.actions">操作</th>
					</tr>
				</thead>
				<tbody id="tasks-table-body">
					<tr>
						<td colspan="7" class="text-center text-muted py-4" data-i18n="tasks.table.loading">正在加载任务...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="taskLogOffcanvas" data-bs-scroll="true">
	<div class="offcanvas-header">
		<div>
			<h5 class="offcanvas-title" id="taskLogTitle">任务实时日志</h5>
			<small class="text-muted" id="taskLogSubtitle"></small>
		</div>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="关闭"></button>
	</div>
	<div class="offcanvas-body">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div>
				<span class="badge bg-primary" id="taskLogStatus">-</span>
			</div>
			<div class="btn-group btn-group-sm">
				<button class="btn btn-outline-secondary" id="taskLogRefreshBtn">
					<i class="bi bi-arrow-clockwise"></i> 手动刷新
				</button>
				<button class="btn btn-outline-danger" id="taskLogClearBtn">
					<i class="bi bi-x-circle"></i> 清屏
				</button>
			</div>
		</div>
		<div id="taskLogContent" class="border"></div>
	</div>
</div>

<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">任务详情</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
			</div>
			<div class="modal-body" id="task-detail-content">
				<div class="text-center text-muted py-4">
					<div class="spinner-border text-primary" role="status"></div>
					<p class="mt-3 mb-0">加载中...</p>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
				<button type="button" class="btn btn-success" id="run-task-btn" style="display: none;">
					<i class="bi bi-play"></i> 立即执行
				</button>
				<button type="button" class="btn btn-warning" id="cancel-task-btn" style="display: none;">
					<i class="bi bi-stop"></i> 取消任务
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-scrollable">
		<div class="modal-content">
			<form id="taskForm">
				<div class="modal-header">
					<h5 class="modal-title" id="taskModalLabel">创建任务</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
				</div>
				<div class="modal-body task-modal-body">
					<input type="hidden" id="taskId">

					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label">任务名称 <span class="text-danger">*</span></label>
							<input type="text" class="form-control" id="taskName" required maxlength="100">
						</div>
						<div class="col-md-3">
							<label class="form-label">优先级</label>
							<input type="number" class="form-control" id="taskPriority" min="1" max="10" value="5" required>
							<small class="text-muted">1 为最高优先级，10 为最低</small>
						</div>
						<div class="col-md-3">
							<label class="form-label">资源分组</label>
							<select class="form-select" id="resourceGroupSelect" required></select>
							<small class="text-muted">任务将在所选分组的执行器上运行</small>
						</div>
						<div class="col-12">
							<label class="form-label">任务描述</label>
							<textarea class="form-control" id="taskDescription" rows="2" maxlength="300" placeholder="可选，描述任务用途"></textarea>
						</div>
						<div class="col-12">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" id="taskEnabled" checked>
								<label class="form-check-label" for="taskEnabled">启用该任务</label>
							</div>
						</div>
					</div>

					<div class="card mt-4">
						<div class="card-header bg-light d-flex justify-content-between align-items-center">
							<div><i class="bi bi-clock me-2"></i> 调度配置</div>
							<button type="button" class="btn btn-sm btn-outline-primary" id="addTriggerBtn">
								<i class="bi bi-plus-circle"></i> 添加触发器
							</button>
						</div>
						<div class="card-body">
							<div id="triggerList" class="d-flex flex-column gap-3"></div>
							<div id="noTriggerHint" class="text-muted small">请至少添加一个触发器。</div>
						</div>
					</div>

					<template id="trigger-item-template">
						<div class="trigger-item card border-secondary">
							<div class="card-body">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<h6 class="mb-0">触发器</h6>
									<div class="btn-group btn-group-sm">
										<button type="button" class="btn btn-outline-secondary trigger-duplicate-btn">
											<i class="bi bi-files"></i> 复制
										</button>
										<button type="button" class="btn btn-outline-danger trigger-remove-btn">
											<i class="bi bi-x-circle"></i> 移除
										</button>
									</div>
								</div>
								<div class="row g-3 align-items-center">
									<div class="col-md-4">
										<label class="form-label">触发类型</label>
										<select class="form-select trigger-type-select">
											<option value="scheduled">定时执行</option>
											<option value="interval">间隔执行</option>
											<option value="random_time">随机时间</option>
											<option value="weekly">按周执行</option>
											<option value="monthly">按月执行</option>
											<option value="specific_date">指定日期</option>
										</select>
									</div>
									<div class="col-md-4">
										<label class="form-label">开始时间</label>
										<input type="time" class="form-control trigger-start-time" value="09:00">
									</div>
									<div class="col-md-4">
										<label class="form-label">结束时间</label>
										<input type="time" class="form-control trigger-end-time" value="18:00">
									</div>
								</div>
								<div class="row g-3 mt-2 trigger-section trigger-interval d-none">
									<div class="col-md-4">
										<label class="form-label">间隔时间（分钟）</label>
										<input type="number" class="form-control trigger-interval-minutes" min="1" value="30">
									</div>
								</div>
								<div class="row g-3 mt-2 trigger-section trigger-random-time d-none">
									<div class="col-md-4">
										<label class="form-label">随机开始</label>
										<input type="time" class="form-control trigger-random-start" value="09:00">
									</div>
									<div class="col-md-4">
										<label class="form-label">随机结束</label>
										<input type="time" class="form-control trigger-random-end" value="18:00">
									</div>
								</div>
								<div class="trigger-section trigger-weekly d-none mt-3">
									<label class="form-label">每周执行星期</label>
									<div class="d-flex flex-wrap gap-2 trigger-weekly-days"></div>
								</div>
								<div class="trigger-section trigger-monthly d-none mt-3">
									<label class="form-label">执行日期</label>
									<input type="text" class="form-control trigger-days-of-month" placeholder="例如: 1, 15, 30">
									<small class="text-muted">使用逗号分隔 1-31 之间的数字。</small>
								</div>
								<div class="trigger-section trigger-specific-date d-none mt-3">
									<label class="form-label">指定日期时间</label>
									<textarea class="form-control trigger-specific-datetimes" rows="3" placeholder="2024-10-01 08:30"></textarea>
									<small class="text-muted">每行一个日期时间，格式 YYYY-MM-DD HH:MM。</small>
								</div>
							</div>
						</div>
					</template>

					<div class="card mt-4">
						<div class="card-header bg-light">
							<i class="bi bi-play-circle me-2"></i> 执行配置
						</div>
						<div class="card-body">
							<div class="mb-3">
								<label class="form-label">执行命令 <span class="text-danger">*</span></label>
								<textarea class="form-control font-monospace" id="mainCommand" rows="3" placeholder="输入完整的命令" required></textarea>
								<small class="text-muted">命令将在调度器所在机器执行，建议使用绝对路径或明确的环境变量。</small>
							</div>
							<div class="form-check mb-2">
								<input class="form-check-input" type="checkbox" id="enableAdbWakeup">
								<label class="form-check-label" for="enableAdbWakeup">启用 ADB 唤醒设备</label>
							</div>
							<div id="adbConfigSection" class="row g-3 d-none">
								<div class="col-md-6">
									<label class="form-label">ADB 设备 ID</label>
									<input type="text" class="form-control" id="adbDeviceId" placeholder="127.0.0.1:5555">
								</div>
								<div class="form-check mb-2">
									<input class="form-check-input" type="checkbox" id="enableResolutionSwitch">
									<label class="form-check-label" for="enableResolutionSwitch">执行前调整设备分辨率</label>
								</div>
								<div id="resolutionConfigSection" class="row g-3 d-none">
									<div class="col-md-6">
										<label class="form-label">目标分辨率</label>
										<input type="text" class="form-control" id="targetResolution" placeholder="1920x1080">
										<small class="text-muted">格式为 宽x高，示例：1920x1080。需要配置 ADB 设备 ID。</small>
									</div>
								</div>
								<div class="col-md-6">
									<label class="form-label">启动延迟（秒）</label>
									<input type="number" class="form-control" id="adbLaunchDelay" min="0" placeholder="0">
								</div>
								<div class="col-md-6">
									<label class="form-label">应用包名</label>
									<input type="text" class="form-control" id="adbLaunchPackage" placeholder="com.example.app">
								</div>
								<div class="col-md-6">
									<label class="form-label">启动 Activity</label>
									<input type="text" class="form-control" id="adbLaunchActivity" placeholder="com.example.app/.MainActivity">
									<small class="text-muted">可选，未填写时将使用 monkey 根据包名启动。</small>
								</div>
							</div>
							<div class="row g-3 mt-1">
								<div class="col-md-6">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="enableGlobalLog" checked>
										<label class="form-check-label" for="enableGlobalLog">启用全局日志</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="enableTempLog">
										<label class="form-check-label" for="enableTempLog">启用临时日志</label>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="card mt-4">
						<div class="card-header bg-light">
							<i class="bi bi-arrow-counterclockwise me-2"></i> 失败重试策略
						</div>
						<div class="card-body">
							<div class="form-check mb-3">
								<input class="form-check-input" type="checkbox" id="retryEnabled">
								<label class="form-check-label" for="retryEnabled">启用自动重试</label>
							</div>
							<div id="retryConfigSection" class="row g-3 d-none">
								<div class="col-md-4">
									<label class="form-label">最大重试次数</label>
									<input type="number" class="form-control" id="retryMax" min="0" value="0">
								</div>
								<div class="col-md-4">
									<label class="form-label">重试延迟（秒）</label>
									<input type="number" class="form-control" id="retryDelay" min="1" value="60">
								</div>
								<div class="col-md-4">
									<label class="form-label">通知阈值</label>
									<input type="number" class="form-control" id="retryNotify" min="1" placeholder="可选">
									<small class="text-muted">达到指定失败次数时发送通知</small>
								</div>
								<div class="col-12">
									<div class="form-check mt-2">
										<input class="form-check-input" type="checkbox" id="retryRerunPreTasks" checked>
										<label class="form-check-label" for="retryRerunPreTasks">重试时重新执行前置任务</label>
										<small class="text-muted d-block">关闭后重试会跳过ADB唤醒、分辨率调整等前置流程。</small>
									</div>
								</div>
								<div class="col-12">
									<div class="form-check mt-2">
										<input class="form-check-input" type="checkbox" id="retrySuccessWindow">
										<label class="form-check-label" for="retrySuccessWindow">成功后在时间窗口内继续运行</label>
										<small class="text-muted d-block">仅适用于定时触发的任务，用于在时间段内多次执行。</small>
									</div>
								</div>
							</div>
							<div id="successRetryConfig" class="row g-3 mt-2 d-none">
								<div class="col-md-4">
									<label class="form-label" for="successRetryDelay">成功重试延迟（秒）</label>
									<input type="number" class="form-control" id="successRetryDelay" min="0" placeholder="默认同失败重试延迟">
								</div>
								<div class="col-md-4">
									<label class="form-label" for="successRetryMax">成功重试次数上限</label>
									<input type="number" class="form-control" id="successRetryMax" min="1" placeholder="留空表示不限次数">
									<small class="text-muted">用于限制同一时间窗口内的额外执行次数。</small>
								</div>
							</div>
						</div>
					</div>

					<div class="card mt-4">
						<div class="card-header bg-light">
							<i class="bi bi-arrow-repeat me-2"></i> 后置任务配置
						</div>
						<div class="card-body">
							<div class="form-check mb-3">
								<input class="form-check-input" type="checkbox" id="pushNotificationEnabled">
								<label class="form-check-label" for="pushNotificationEnabled">任务结束时发送推送通知</label>
							</div>
							<div id="pushNotificationConfig" class="border rounded p-3 mb-4 d-none">
								<div class="row g-3 mb-3">
									<div class="col-md-6">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="pushNotifySuccess" checked>
											<label class="form-check-label" for="pushNotifySuccess">任务成功时发送</label>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="pushNotifyFailure" checked>
											<label class="form-check-label" for="pushNotifyFailure">任务失败时发送</label>
										</div>
									</div>
								</div>
								<div class="row g-3 mb-3">
									<div class="col-md-6">
										<label class="form-label">通知标题</label>
										<input type="text" class="form-control" id="pushTitle" placeholder="任务 {task_name} {status}">
									</div>
									<div class="col-md-6">
										<label class="form-label">通知标签</label>
										<input type="text" class="form-control" id="pushTag" placeholder="task-status">
									</div>
								</div>
								<div>
									<label class="form-label">通知内容</label>
									<textarea class="form-control" id="pushContent" rows="3" placeholder="任务 {task_name} 已{status}，耗时 {duration} 秒"></textarea>
									<small class="text-muted">支持变量: {task_name}, {status}, {duration}, {start_time}, {end_time}</small>
								</div>
							</div>

							<div id="keywordSection" class="d-none">
								<hr>
								<div class="form-check mb-3">
									<input class="form-check-input" type="checkbox" id="keywordMonitoringEnabled">
									<label class="form-check-label" for="keywordMonitoringEnabled">启用日志关键词监控并推送</label>
									<small class="text-muted d-block">关键词监控依赖临时日志功能，请确保已启用。</small>
								</div>
								<div id="keywordConfig" class="border rounded p-3 d-none">
									<div class="mb-3">
										<label class="form-label">监控关键词</label>
										<input type="text" class="form-control" id="keywordList" placeholder="错误,失败,timeout">
										<small class="text-muted">使用逗号或换行分隔多个关键词，匹配任意一个即触发。</small>
									</div>
									<div class="row g-3 mb-3">
										<div class="col-md-6">
											<label class="form-label">通知标题</label>
											<input type="text" class="form-control" id="keywordTitle" placeholder="检测到关键词: {keywords}">
										</div>
										<div class="col-md-6">
											<label class="form-label">通知标签</label>
											<input type="text" class="form-control" id="keywordTag" placeholder="keyword-alert">
										</div>
									</div>
									<div>
										<label class="form-label">通知内容</label>
										<textarea class="form-control" id="keywordContent" rows="3" placeholder="任务 {task_name} 日志出现: {keywords}"></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
					<button type="submit" class="btn btn-primary" id="saveTaskBtn">
						<span class="save-text">保存任务</span>
						<span class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
					</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	let tasks = [];
	let filteredTasks = [];
	let resourceGroups = {};
	let editingTaskId = null;
	let currentTaskId = null;
	let taskModalInstance = null;
	let taskFormElement = null;
	let logPollingTimer = null;
	let activeLogTaskId = null;
	let logOffcanvasInstance = null;

	const statusColors = {
		pending: 'secondary',
		running: 'success',
		completed: 'primary',
		failed: 'danger',
		cancelled: 'warning'
	};

	const statusTexts = {
		pending: '待执行',
		running: '执行中',
		completed: '已完成',
		failed: '失败',
		cancelled: '已取消'
	};

	const triggerTypeTexts = {
		scheduled: '定时执行',
		interval: '间隔执行',
		random_time: '随机时间',
		weekly: '按周执行',
		monthly: '按月执行',
		specific_date: '指定日期'
	};

	function escapeHtml(value) {
		if (value === null || value === undefined) {
			return '';
		}
		return String(value)
			.replace(/&/g, '&amp;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;')
			.replace(/"/g, '&quot;')
			.replace(/'/g, '&#39;');
	}

	function formatDateTime(value) {
		if (!value) {
			return '-';
		}
		const date = new Date(value);
		if (Number.isNaN(date.getTime())) {
			return '-';
		}
		return date.toLocaleString();
	}

	const weekdayNames = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];

	function describeTrigger(trigger) {
		if (!trigger) {
			return '-';
		}
		switch (trigger.trigger_type) {
			case 'scheduled':
				return `每天 ${escapeHtml(trigger.start_time || '--')} ~ ${escapeHtml(trigger.end_time || '--')}`;
			case 'interval':
				return `每隔 ${trigger.interval_minutes ?? '?'} 分钟执行`;
			case 'random_time':
				return `每天随机时间 ${escapeHtml(trigger.random_start_time || '--')} ~ ${escapeHtml(trigger.random_end_time || '--')}`;
			case 'weekly': {
				const days = Array.isArray(trigger.days_of_week)
					? trigger.days_of_week.map(day => weekdayNames[day] ?? day).join('、')
					: '-';
				return `每周 ${escapeHtml(days)} 的 ${escapeHtml(trigger.start_time || '--')}`;
			}
			case 'monthly': {
				const days = Array.isArray(trigger.days_of_month)
					? trigger.days_of_month.join('、')
					: '-';
				return `每月 ${escapeHtml(days)} 日 ${escapeHtml(trigger.start_time || '--')}`;
			}
			case 'specific_date': {
				const dates = Array.isArray(trigger.specific_datetimes) ? trigger.specific_datetimes : [];
				if (!dates.length) return '指定日期执行';
				const preview = dates.slice(0, 3).map(escapeHtml).join('、');
				return dates.length > 3 ? `${preview} 等 ${dates.length} 个时间点` : preview;
			}
			default:
				return escapeHtml(trigger.trigger_type || '-');
		}
	}

	function clearTriggers() {
		const list = document.getElementById('triggerList');
		if (list) {
			list.innerHTML = '';
		}
		updateTriggerIndices();
		updateTriggerEmptyHint();
	}

	function updateTriggerEmptyHint() {
		const hint = document.getElementById('noTriggerHint');
		if (!hint) return;
		const hasTrigger = document.querySelectorAll('#triggerList .trigger-item').length > 0;
		hint.classList.toggle('d-none', hasTrigger);
	}

	function updateTriggerIndices() {
		const items = document.querySelectorAll('#triggerList .trigger-item');
		items.forEach((item, index) => {
			const title = item.querySelector('h6');
			if (title) {
				title.textContent = `触发器 ${index + 1}`;
			}
			const removeBtn = item.querySelector('.trigger-remove-btn');
			if (removeBtn) {
				removeBtn.classList.toggle('d-none', items.length === 1);
			}
		});
	}

	function setupWeeklyCheckboxes(triggerElement, selected = []) {
		const container = triggerElement.querySelector('.trigger-weekly-days');
		if (!container || container.childElementCount) {
			return;
		}
		const weekdays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
		weekdays.forEach((label, index) => {
			const wrapper = document.createElement('div');
			wrapper.className = 'form-check form-check-inline';
			const input = document.createElement('input');
			input.type = 'checkbox';
			input.className = 'form-check-input';
			input.value = index;
			if (selected.includes(index)) {
				input.checked = true;
			}
			const text = document.createElement('label');
			text.className = 'form-check-label';
			text.textContent = label;
			wrapper.appendChild(input);
			wrapper.appendChild(text);
			container.appendChild(wrapper);
		});
	}

	function updateTriggerSections(triggerElement) {
		const typeSelect = triggerElement.querySelector('.trigger-type-select');
		if (!typeSelect) return;
		const type = typeSelect.value;
		const startGroup = triggerElement.querySelector('.trigger-start-time')?.closest('.col-md-4');
		const endGroup = triggerElement.querySelector('.trigger-end-time')?.closest('.col-md-4');
		triggerElement.querySelectorAll('.trigger-section').forEach(section => {
			section.classList.add('d-none');
		});

		if (startGroup) {
			startGroup.classList.remove('d-none');
		}
		if (endGroup) {
			endGroup.classList.remove('d-none');
		}

		switch (type) {
			case 'scheduled':
				break;
			case 'interval':
				if (startGroup) startGroup.classList.add('d-none');
				if (endGroup) endGroup.classList.add('d-none');
				triggerElement.querySelector('.trigger-interval')?.classList.remove('d-none');
				break;
			case 'random_time':
				if (startGroup) startGroup.classList.add('d-none');
				if (endGroup) endGroup.classList.add('d-none');
				triggerElement.querySelector('.trigger-random-time')?.classList.remove('d-none');
				break;
			case 'weekly':
				if (endGroup) endGroup.classList.add('d-none');
				triggerElement.querySelector('.trigger-weekly')?.classList.remove('d-none');
				break;
			case 'monthly':
				if (endGroup) endGroup.classList.add('d-none');
				triggerElement.querySelector('.trigger-monthly')?.classList.remove('d-none');
				break;
			case 'specific_date':
				if (startGroup) startGroup.classList.add('d-none');
				if (endGroup) endGroup.classList.add('d-none');
				triggerElement.querySelector('.trigger-specific-date')?.classList.remove('d-none');
				break;
			default:
				break;
		}
	}

	function extractTriggerData(triggerElement, { validate = false } = {}) {
		const type = triggerElement.querySelector('.trigger-type-select')?.value || 'scheduled';
		const trigger = { trigger_type: type };
		const startTime = triggerElement.querySelector('.trigger-start-time')?.value || null;
		const endTime = triggerElement.querySelector('.trigger-end-time')?.value || null;

		if (type === 'scheduled') {
			trigger.start_time = startTime;
			trigger.end_time = endTime;
		} else if (type === 'interval') {
			const interval = Number(triggerElement.querySelector('.trigger-interval-minutes')?.value);
			if (Number.isFinite(interval) && interval > 0) {
				trigger.interval_minutes = interval;
			} else if (validate) {
				throw new Error('请为间隔触发配置有效的间隔分钟数');
			}
		} else if (type === 'random_time') {
			const randomStart = triggerElement.querySelector('.trigger-random-start')?.value || null;
			const randomEnd = triggerElement.querySelector('.trigger-random-end')?.value || null;
			if (validate && (!randomStart || !randomEnd)) {
				throw new Error('请为随机时间触发配置开始和结束时间');
			}
			trigger.random_start_time = randomStart;
			trigger.random_end_time = randomEnd;
		} else if (type === 'weekly') {
			const selectedDays = Array.from(triggerElement.querySelectorAll('.trigger-weekly-days input:checked')).map(input => Number(input.value));
			if (validate && !selectedDays.length) {
				throw new Error('请至少选择一个星期用于按周触发');
			}
			trigger.start_time = startTime;
			trigger.days_of_week = selectedDays;
		} else if (type === 'monthly') {
			const raw = triggerElement.querySelector('.trigger-days-of-month')?.value || '';
			const days = raw.split(/[,，\s]+/)
				.map(item => Number(item.trim()))
				.filter(num => Number.isInteger(num) && num >= 1 && num <= 31);
			if (validate && !days.length) {
				throw new Error('请至少指定一个有效的日期 (1-31)');
			}
			trigger.start_time = startTime;
			trigger.days_of_month = days;
		} else if (type === 'specific_date') {
			const lines = (triggerElement.querySelector('.trigger-specific-datetimes')?.value || '')
				.split(/\n+/)
				.map(item => item.trim())
				.filter(Boolean);
			if (validate && !lines.length) {
				throw new Error('请至少填写一个指定的日期时间');
			}
			trigger.specific_datetimes = lines;
		}

		return trigger;
	}

	function collectTriggerConfigs() {
		const triggerItems = document.querySelectorAll('#triggerList .trigger-item');
		const triggers = [];
		try {
			triggerItems.forEach(item => {
				const trigger = extractTriggerData(item, { validate: true });
				triggers.push(trigger);
			});
		} catch (error) {
			showToast(error.message || AppI18n.t('tasks.toast.invalidTrigger', '触发器配置无效'), 'warning');
			return null;
		}
		return triggers;
	}

	function addTrigger(triggerData = {}) {
		const template = document.getElementById('trigger-item-template');
		if (!template) return;
		const clone = template.content.firstElementChild.cloneNode(true);
		const typeSelect = clone.querySelector('.trigger-type-select');
		const startInput = clone.querySelector('.trigger-start-time');
		const endInput = clone.querySelector('.trigger-end-time');
		const intervalInput = clone.querySelector('.trigger-interval-minutes');
		const randomStartInput = clone.querySelector('.trigger-random-start');
		const randomEndInput = clone.querySelector('.trigger-random-end');
		const monthlyInput = clone.querySelector('.trigger-days-of-month');
		const specificTextarea = clone.querySelector('.trigger-specific-datetimes');

		const type = triggerData.trigger_type || 'scheduled';
		typeSelect.value = type;
		if (startInput) {
			startInput.value = triggerData.start_time || '09:00';
		}
		if (endInput) {
			endInput.value = triggerData.end_time || '18:00';
		}
		if (intervalInput && typeof triggerData.interval_minutes === 'number') {
			intervalInput.value = triggerData.interval_minutes;
		}
		if (randomStartInput) {
			randomStartInput.value = triggerData.random_start_time || triggerData.start_time || '09:00';
		}
		if (randomEndInput) {
			randomEndInput.value = triggerData.random_end_time || triggerData.end_time || '18:00';
		}
		if (monthlyInput && Array.isArray(triggerData.days_of_month)) {
			monthlyInput.value = triggerData.days_of_month.join(', ');
		}
		if (specificTextarea && Array.isArray(triggerData.specific_datetimes)) {
			specificTextarea.value = triggerData.specific_datetimes.join('\n');
		}

		setupWeeklyCheckboxes(clone, Array.isArray(triggerData.days_of_week) ? triggerData.days_of_week : []);
		updateTriggerSections(clone);

		typeSelect.addEventListener('change', () => updateTriggerSections(clone));
		clone.querySelector('.trigger-remove-btn')?.addEventListener('click', () => {
			clone.remove();
			updateTriggerIndices();
			updateTriggerEmptyHint();
		});
		clone.querySelector('.trigger-duplicate-btn')?.addEventListener('click', () => {
			const data = extractTriggerData(clone, { validate: false });
			addTrigger(data);
		});

		document.getElementById('triggerList')?.appendChild(clone);
		updateTriggerIndices();
		updateTriggerEmptyHint();
	}

	async function loadTasks() {
		try {
			const result = await apiRequest('/api/tasks');
			tasks = Array.isArray(result) ? result : [];
			filterTasks();
		} catch (error) {
			console.error('加载任务列表失败:', error);
			showToast(error.message || AppI18n.t('tasks.toast.loadTasksFailed', '加载任务列表失败'), 'danger');
		}
	}

	async function loadResourceGroups() {
		try {
			const result = await apiRequest('/api/resource-groups');
			resourceGroups = result || {};
			updateResourceGroupSelects();
		} catch (error) {
			console.error('加载资源分组失败:', error);
			showToast(error.message || AppI18n.t('tasks.toast.loadGroupsFailed', '加载资源分组失败'), 'danger');
		}
	}

	function updateResourceGroupSelects() {
		const filterSelect = document.getElementById('group-filter');
		const formSelect = document.getElementById('resourceGroupSelect');
		const currentValue = formSelect.value;

		filterSelect.innerHTML = '<option value="">所有资源分组</option>';
		formSelect.innerHTML = '';

		const groups = Object.values(resourceGroups);
		if (!groups.length) {
			const option = document.createElement('option');
			option.value = 'default';
			option.textContent = 'default (默认)';
			formSelect.appendChild(option);
		} else {
			groups.forEach(groupStatus => {
				const option = document.createElement('option');
				option.value = groupStatus.name;
				option.textContent = `${groupStatus.name} (${groupStatus.description || '无描述'})`;
				formSelect.appendChild(option);

				const filterOption = document.createElement('option');
				filterOption.value = groupStatus.name;
				filterOption.textContent = groupStatus.name;
				filterSelect.appendChild(filterOption);
			});
		}

		if (currentValue) {
			ensureResourceGroupOption(currentValue);
			formSelect.value = currentValue;
		}
	}

	function ensureResourceGroupOption(groupName) {
		if (!groupName) {
			return;
		}
		const formSelect = document.getElementById('resourceGroupSelect');
		const exists = Array.from(formSelect.options).some(option => option.value === groupName);
		if (!exists) {
			const option = document.createElement('option');
			option.value = groupName;
			option.textContent = `${groupName} (未在资源组配置中)`;
			formSelect.appendChild(option);
		}
	}

	function updateTasksTable() {
		const tbody = document.getElementById('tasks-table-body');
		if (!filteredTasks.length) {
			tbody.innerHTML = `
				<tr>
					<td colspan="7" class="text-center text-muted py-4">暂无匹配的任务</td>
				</tr>
			`;
			return;
		}

		const schedulerRunning = systemStatus?.is_running ?? true;
		const manualAllowed = !schedulerRunning || systemStatus?.mode === 'single_task';
		tbody.innerHTML = filteredTasks.map(task => {
			const status = task.status || 'pending';
			const statusBadge = statusColors[status] || 'secondary';
			const statusText = statusTexts[status] || status;
			const triggerList = Array.isArray(task.triggers) && task.triggers.length
				? task.triggers
				: (task.trigger ? [task.trigger] : []);
			const triggerSummary = triggerList.length
				? triggerList.map(t => triggerTypeTexts[t.trigger_type] || t.trigger_type || '-').join(' / ')
				: '-';
			const nextRunTime = formatDateTime(task.next_run_time);
			const resourceGroup = task.resource_group || '-';
			const canManualRun = manualAllowed && status !== 'running';

			const descriptionLine = task.description
				? `<small class="text-muted">${escapeHtml(task.description)}</small>`
				: '';

			const runBtn = canManualRun
				? `<button class="btn btn-outline-success" onclick="runTask('${task.id}')" title="立即执行">
						<i class="bi bi-play"></i>
				   </button>`
				: '';

			const cancelBtn = status === 'running'
				? `<button class="btn btn-outline-warning" onclick="cancelTask('${task.id}')" title="取消任务">
						<i class="bi bi-stop"></i>
				   </button>`
				: '';

			const logBtn = task.enable_global_log
				? `<button class="btn btn-outline-dark" onclick="openTaskLogs('${task.id}')" title="实时日志">
						<i class="bi bi-terminal"></i>
				   </button>`
				: '';

			return `
				<tr>
					<td>
						<div class="fw-semibold">${escapeHtml(task.name)}</div>
						${descriptionLine}
					</td>
					<td class="text-center"><span class="badge bg-${statusBadge}">${statusText}</span></td>
					<td class="text-center"><span class="badge bg-secondary">${task.priority}</span></td>
					<td class="text-center">${escapeHtml(resourceGroup)}</td>
					<td class="text-center">${triggerSummary}</td>
					<td class="text-center"><small>${nextRunTime}</small></td>
					<td class="text-end">
						<div class="btn-group btn-group-sm" role="group">
							<button class="btn btn-outline-primary" onclick="viewTask('${task.id}')" title="查看详情">
								<i class="bi bi-eye"></i>
							</button>
							${logBtn}
							${runBtn}
							${cancelBtn}
							<button class="btn btn-outline-secondary" onclick="editTask('${task.id}')" title="编辑">
								<i class="bi bi-pencil"></i>
							</button>
							<button class="btn btn-outline-danger" onclick="deleteTask('${task.id}')" title="删除">
								<i class="bi bi-trash"></i>
							</button>
						</div>
					</td>
				</tr>
			`;
		}).join('');
	}

	function filterTasks() {
		const searchText = document.getElementById('task-search').value.trim().toLowerCase();
		const statusFilter = document.getElementById('status-filter').value;
		const groupFilter = document.getElementById('group-filter').value;

		filteredTasks = tasks.filter(task => {
			const name = (task.name || '').toLowerCase();
			const description = (task.description || '').toLowerCase();
			const matchesSearch = !searchText || name.includes(searchText) || description.includes(searchText);
			const matchesStatus = !statusFilter || task.status === statusFilter;
			const matchesGroup = !groupFilter || task.resource_group === groupFilter;
			return matchesSearch && matchesStatus && matchesGroup;
		});

		updateTasksTable();
	}

	function clearFilters() {
		document.getElementById('task-search').value = '';
		document.getElementById('status-filter').value = '';
		document.getElementById('group-filter').value = '';
		filteredTasks = tasks;
		updateTasksTable();
	}

	function resetTaskForm() {
		editingTaskId = null;
		document.getElementById('taskModalLabel').textContent = '创建任务';
		taskFormElement.reset();

		document.getElementById('taskPriority').value = 5;
		document.getElementById('taskEnabled').checked = true;
		document.getElementById('enableAdbWakeup').checked = false;
		document.getElementById('enableGlobalLog').checked = true;
		document.getElementById('enableTempLog').checked = false;
	document.getElementById('enableResolutionSwitch').checked = false;
	document.getElementById('targetResolution').value = '';
		document.getElementById('pushNotificationEnabled').checked = false;
		document.getElementById('keywordMonitoringEnabled').checked = false;
		document.getElementById('retryEnabled').checked = false;
		document.getElementById('retryMax').value = 0;
		document.getElementById('retryDelay').value = 60;
		document.getElementById('retryNotify').value = '';
	document.getElementById('retryRerunPreTasks').checked = true;
		document.getElementById('retrySuccessWindow').checked = false;
		document.getElementById('successRetryDelay').value = '';
		document.getElementById('successRetryMax').value = '';
		document.getElementById('adbLaunchDelay').value = '';
		document.getElementById('adbLaunchPackage').value = '';
		document.getElementById('adbLaunchActivity').value = '';

		toggleAdbConfig();
	toggleResolutionConfig();
		togglePushNotificationConfig();
		syncKeywordSectionVisibility();
		toggleKeywordConfig();
		toggleRetryConfig();
		toggleSuccessRetryConfig();

		clearTriggers();
		addTrigger();

		const groupSelect = document.getElementById('resourceGroupSelect');
		if (groupSelect.options.length > 0) {
			groupSelect.selectedIndex = 0;
		}
	}

	function toggleAdbConfig() {
		const enableAdb = document.getElementById('enableAdbWakeup').checked;
		document.getElementById('adbConfigSection').classList.toggle('d-none', !enableAdb);
		if (!enableAdb) {
			document.getElementById('adbDeviceId').value = '';
			document.getElementById('adbLaunchDelay').value = '';
			document.getElementById('adbLaunchPackage').value = '';
			document.getElementById('adbLaunchActivity').value = '';
		}
	}

	function toggleResolutionConfig() {
		const enabled = document.getElementById('enableResolutionSwitch').checked;
		document.getElementById('resolutionConfigSection').classList.toggle('d-none', !enabled);
		if (!enabled) {
			document.getElementById('targetResolution').value = '';
		}
	}

	function togglePushNotificationConfig() {
		const enabled = document.getElementById('pushNotificationEnabled').checked;
		document.getElementById('pushNotificationConfig').classList.toggle('d-none', !enabled);
	}

	function syncKeywordSectionVisibility() {
		const enableTemp = document.getElementById('enableTempLog').checked;
		const section = document.getElementById('keywordSection');
		section.classList.toggle('d-none', !enableTemp);
		if (!enableTemp) {
			document.getElementById('keywordMonitoringEnabled').checked = false;
			toggleKeywordConfig();
		}
	}

	function toggleKeywordConfig() {
		const enabled = document.getElementById('keywordMonitoringEnabled').checked;
		document.getElementById('keywordConfig').classList.toggle('d-none', !enabled);
	}

	function toggleRetryConfig() {
		const enabled = document.getElementById('retryEnabled').checked;
		document.getElementById('retryConfigSection').classList.toggle('d-none', !enabled);
		toggleSuccessRetryConfig();
	}

	function toggleSuccessRetryConfig() {
		const retryEnabled = document.getElementById('retryEnabled').checked;
		const successEnabled = document.getElementById('retrySuccessWindow').checked;
		const shouldShow = retryEnabled && successEnabled;
		document.getElementById('successRetryConfig').classList.toggle('d-none', !shouldShow);
	}

	function buildPostTaskConfig() {
		const pushEnabled = document.getElementById('pushNotificationEnabled').checked;
		const pushConfig = {
			enabled: pushEnabled,
			on_success: pushEnabled ? document.getElementById('pushNotifySuccess').checked : false,
			on_failure: pushEnabled ? document.getElementById('pushNotifyFailure').checked : false
		};

		if (pushEnabled) {
			const title = document.getElementById('pushTitle').value.trim();
			const tag = document.getElementById('pushTag').value.trim();
			const content = document.getElementById('pushContent').value.trim();
			if (title) pushConfig.title = title;
			if (tag) pushConfig.tag = tag;
			if (content) pushConfig.content = content;
		}

		const enableTemp = document.getElementById('enableTempLog').checked;
		const keywordEnabled = enableTemp && document.getElementById('keywordMonitoringEnabled').checked;

		const rawKeywords = document.getElementById('keywordList').value;
		const keywordList = rawKeywords
			.split(/[\n,]/)
			.map(item => item.trim())
			.filter(Boolean);

		let keywordNotification = null;
		if (keywordEnabled) {
			keywordNotification = {};
			const title = document.getElementById('keywordTitle').value.trim();
			const tag = document.getElementById('keywordTag').value.trim();
			const content = document.getElementById('keywordContent').value.trim();
			if (title) keywordNotification.title = title;
			if (tag) keywordNotification.tag = tag;
			if (content) keywordNotification.content = content;
			if (!Object.keys(keywordNotification).length) {
				keywordNotification = null;
			}
		}

		return {
			log_keywords: keywordEnabled ? keywordList : [],
			keyword_notification: keywordEnabled ? keywordNotification : null,
			push_notification: pushConfig
		};
	}

	function buildRetryPolicy() {
		const enabled = document.getElementById('retryEnabled').checked;
		const maxRetriesValue = Number(document.getElementById('retryMax').value);
		const delayValue = Number(document.getElementById('retryDelay').value);
		const notifyValue = Number(document.getElementById('retryNotify').value);
		const rerunPreTasks = document.getElementById('retryRerunPreTasks').checked;
		const successRetryEnabled = document.getElementById('retrySuccessWindow').checked;
		const successDelayValue = Number(document.getElementById('successRetryDelay').value);
		const successMaxValue = Number(document.getElementById('successRetryMax').value);

		const policy = {
			enabled,
			max_retries: enabled && Number.isFinite(maxRetriesValue) && maxRetriesValue >= 0 ? maxRetriesValue : 0,
			delay_seconds: enabled && Number.isFinite(delayValue) && delayValue > 0 ? delayValue : 60,
			notify_after_retries: null,
			rerun_pre_tasks: enabled ? rerunPreTasks : true,
			retry_on_success_within_window: enabled ? successRetryEnabled : false,
			success_retry_delay_seconds: null,
			success_retry_max: null
		};

		if (enabled && Number.isFinite(notifyValue) && notifyValue > 0) {
			policy.notify_after_retries = notifyValue;
		}

		if (enabled && successRetryEnabled && Number.isFinite(successDelayValue) && successDelayValue >= 0) {
			policy.success_retry_delay_seconds = successDelayValue;
		}

		if (enabled && successRetryEnabled && Number.isFinite(successMaxValue) && successMaxValue > 0) {
			policy.success_retry_max = successMaxValue;
		}

		return policy;
	}

	function collectTaskPayload() {
		const enableAdb = document.getElementById('enableAdbWakeup').checked;
		const adbDeviceId = document.getElementById('adbDeviceId').value.trim();
		const triggers = collectTriggerConfigs();
		if (!triggers) {
			return null;
		}
		if (!triggers.length) {
			showToast(AppI18n.t('tasks.toast.missingTrigger', '请至少配置一个触发器'), 'warning');
			return null;
		}

		const payload = {
			name: document.getElementById('taskName').value.trim(),
			description: document.getElementById('taskDescription').value.trim(),
			enabled: document.getElementById('taskEnabled').checked,
			priority: Number(document.getElementById('taskPriority').value) || 5,
			resource_group: document.getElementById('resourceGroupSelect').value,
			main_command: document.getElementById('mainCommand').value.trim(),
			enable_adb_wakeup: enableAdb,
			adb_device_id: enableAdb && adbDeviceId ? adbDeviceId : null,
			enable_global_log: document.getElementById('enableGlobalLog').checked,
			enable_temp_log: document.getElementById('enableTempLog').checked,
			enable_resolution_switch: document.getElementById('enableResolutionSwitch').checked,
			target_resolution: document.getElementById('enableResolutionSwitch').checked
				? (document.getElementById('targetResolution').value.trim() || null)
				: null,
			triggers,
			trigger: triggers[0],
			retry_policy: buildRetryPolicy(),
			post_task: buildPostTaskConfig()
		};

		if (enableAdb) {
			const delayValue = Number(document.getElementById('adbLaunchDelay').value);
			payload.adb_launch_delay_seconds = Number.isFinite(delayValue) && delayValue >= 0 ? delayValue : null;
			const launchPackage = document.getElementById('adbLaunchPackage').value.trim();
			const launchActivity = document.getElementById('adbLaunchActivity').value.trim();
			payload.adb_launch_package = launchPackage || null;
			payload.adb_launch_activity = launchActivity || null;
		} else {
			payload.adb_launch_delay_seconds = null;
			payload.adb_launch_package = null;
			payload.adb_launch_activity = null;
		}

		if (editingTaskId) {
			payload.id = editingTaskId;
		}

		return payload;
	}

	async function saveTask() {
		const submitButton = document.getElementById('saveTaskBtn');
		const spinner = document.getElementById('saveSpinner');
		submitButton.disabled = true;
		spinner.classList.remove('d-none');

		try {
			const payload = collectTaskPayload();
			if (!payload) {
				return;
			}
			if (!payload.name) {
				showToast(AppI18n.t('tasks.toast.nameRequired', '任务名称不能为空'), 'warning');
				return;
			}
			if (!payload.main_command) {
				showToast(AppI18n.t('tasks.toast.commandRequired', '执行命令不能为空'), 'warning');
				return;
			}

			const isEdit = Boolean(editingTaskId);
			const url = isEdit ? `/api/tasks/${editingTaskId}` : '/api/tasks';
			const method = isEdit ? 'PUT' : 'POST';

			await apiRequest(url, {
				method,
				body: JSON.stringify(payload)
			});

			const successMessage = isEdit
				? AppI18n.t('tasks.toast.updateSuccess', '任务更新成功')
				: AppI18n.t('tasks.toast.createSuccess', '任务创建成功');
			showToast(successMessage, 'success');
			taskModalInstance.hide();
			await loadTasks();
		} catch (error) {
			console.error('保存任务失败:', error);
			showToast(error.message || AppI18n.t('tasks.toast.saveFailed', '保存任务失败'), 'danger');
		} finally {
			spinner.classList.add('d-none');
			submitButton.disabled = false;
		}
	}

	async function viewTask(taskId) {
		const detailModalElement = document.getElementById('taskDetailModal');
		const modal = bootstrap.Modal.getOrCreateInstance(detailModalElement);
		const detailContainer = document.getElementById('task-detail-content');

		detailContainer.innerHTML = `
			<div class="text-center text-muted py-4">
				<div class="spinner-border text-primary" role="status"></div>
				<p class="mt-3 mb-0">加载中...</p>
			</div>
		`;

		try {
			const taskConfig = await apiRequest(`/api/tasks/${taskId}`);
			currentTaskId = taskId;
			renderTaskDetail(taskConfig);
			updateTaskDetailActions(taskId);
			modal.show();
		} catch (error) {
			console.error('加载任务详情失败:', error);
			showToast(error.message || AppI18n.t('tasks.toast.loadDetailFailed', '加载任务详情失败'), 'danger');
		}
	}

	function renderTaskDetail(taskConfig) {
		const listTask = tasks.find(task => task.id === taskConfig.id);
		const status = listTask ? listTask.status : 'pending';
		const statusBadge = statusColors[status] || 'secondary';
		const statusText = statusTexts[status] || status;
		const nextRunTime = listTask ? formatDateTime(listTask.next_run_time) : '-';
		const triggerList = Array.isArray(taskConfig.triggers) && taskConfig.triggers.length
			? taskConfig.triggers
			: (taskConfig.trigger ? [taskConfig.trigger] : []);
		const triggerListHtml = triggerList.length
			? `<ul class="list-group list-group-flush">${triggerList.map((tr, index) => `
				<li class="list-group-item px-0">
					<div class="fw-semibold">${index + 1}. ${triggerTypeTexts[tr.trigger_type] || tr.trigger_type || '-'}</div>
					<small class="text-muted">${describeTrigger(tr)}</small>
				</li>
			`).join('')}</ul>`
			: '<span class="text-muted">未配置触发器</span>';
		const postTask = taskConfig.post_task || {};
		const push = postTask.push_notification || {};
		const keywords = postTask.log_keywords || [];
		const keywordNotification = postTask.keyword_notification || {};
		const retryPolicy = taskConfig.retry_policy || {};
		const retryRows = retryPolicy.enabled ? `
			<tr><th>启用状态</th><td>启用</td></tr>
			<tr><th>最大重试</th><td>${retryPolicy.max_retries ?? 0} 次</td></tr>
			<tr><th>重试间隔</th><td>${retryPolicy.delay_seconds ?? 60} 秒</td></tr>
			<tr><th>通知阈值</th><td>${retryPolicy.notify_after_retries ?? '未设置'}</td></tr>
		` : '<tr><th>启用状态</th><td>未启用</td></tr>';

		const keywordBadges = keywords.length
			? keywords.map(word => `<span class="badge bg-warning text-dark me-1 mb-1">${escapeHtml(word)}</span>`).join('')
			: '<span class="text-muted">未配置关键词</span>';

		const detailHtml = `
			<div class="row g-4">
				<div class="col-md-6">
					<h6 class="text-muted mb-2">基本信息</h6>
					<table class="table table-sm">
						<tr><th>名称</th><td>${escapeHtml(taskConfig.name)}</td></tr>
						<tr><th>描述</th><td>${escapeHtml(taskConfig.description) || '-'}</td></tr>
						<tr><th>状态</th><td><span class="badge bg-${statusBadge}">${statusText}</span></td></tr>
						<tr><th>下次执行</th><td>${nextRunTime}</td></tr>
						<tr><th>优先级</th><td>${taskConfig.priority}</td></tr>
						<tr><th>资源分组</th><td>${escapeHtml(taskConfig.resource_group || '-')}</td></tr>
						<tr><th>启用</th><td>${taskConfig.enabled ? '是' : '否'}</td></tr>
					</table>
				</div>
				<div class="col-md-6">
					<h6 class="text-muted mb-2">触发配置</h6>
					${triggerListHtml}
				</div>
				<div class="col-md-6">
					<h6 class="text-muted mb-2">执行配置</h6>
					<table class="table table-sm">
						<tr><th>执行命令</th><td><code>${escapeHtml(taskConfig.main_command)}</code></td></tr>
						<tr><th>ADB 唤醒</th><td>${taskConfig.enable_adb_wakeup ? '是' : '否'}</td></tr>
						<tr><th>ADB 设备</th><td>${escapeHtml(taskConfig.adb_device_id) || '-'}</td></tr>
						<tr><th>启动延迟</th><td>${taskConfig.adb_launch_delay_seconds ?? '-'} 秒</td></tr>
						<tr><th>启动包名</th><td>${escapeHtml(taskConfig.adb_launch_package) || '-'}</td></tr>
						<tr><th>启动 Activity</th><td>${escapeHtml(taskConfig.adb_launch_activity) || '-'}</td></tr>
						<tr><th>全局日志</th><td>${taskConfig.enable_global_log ? '启用' : '关闭'}</td></tr>
						<tr><th>临时日志</th><td>${taskConfig.enable_temp_log ? '启用' : '关闭'}</td></tr>
					</table>
					<h6 class="text-muted mb-2">失败重试</h6>
					<table class="table table-sm">
						${retryRows}
					</table>
				</div>
				<div class="col-md-6">
					<h6 class="text-muted mb-2">后置通知</h6>
					<table class="table table-sm">
						<tr><th>推送通知</th><td>${push.enabled ? '启用' : '关闭'}</td></tr>
						<tr><th>成功时发送</th><td>${push.on_success ? '是' : '否'}</td></tr>
						<tr><th>失败时发送</th><td>${push.on_failure ? '是' : '否'}</td></tr>
						<tr><th>标题</th><td>${escapeHtml(push.title) || '-'}</td></tr>
						<tr><th>标签</th><td>${escapeHtml(push.tag) || '-'}</td></tr>
						<tr><th>内容</th><td>${escapeHtml(push.content) || '-'}</td></tr>
					</table>
					<h6 class="text-muted mb-2">关键词监控</h6>
					<div class="mb-2">${keywordBadges}</div>
					<table class="table table-sm">
						<tr><th>标题</th><td>${escapeHtml(keywordNotification.title) || '-'}</td></tr>
						<tr><th>标签</th><td>${escapeHtml(keywordNotification.tag) || '-'}</td></tr>
						<tr><th>内容</th><td>${escapeHtml(keywordNotification.content) || '-'}</td></tr>
					</table>
				</div>
			</div>
		`;

		document.getElementById('task-detail-content').innerHTML = detailHtml;
	}

	function updateTaskDetailActions(taskId) {
		const listTask = tasks.find(task => task.id === taskId);
		const status = listTask ? listTask.status : 'pending';
		const schedulerRunning = systemStatus?.is_running ?? true;
		const manualAllowed = !schedulerRunning || systemStatus?.mode === 'single_task';

		const runBtn = document.getElementById('run-task-btn');
		const cancelBtn = document.getElementById('cancel-task-btn');

		if (status === 'running') {
			runBtn.style.display = 'none';
			cancelBtn.style.display = 'inline-block';
		} else if (manualAllowed) {
			runBtn.style.display = 'inline-block';
			cancelBtn.style.display = 'none';
		} else {
			runBtn.style.display = 'none';
			cancelBtn.style.display = 'none';
		}
	}

	async function runTask(taskId) {
		const schedulerRunning = systemStatus?.is_running ?? true;
		const manualAllowed = !schedulerRunning || systemStatus?.mode === 'single_task';
		if (!manualAllowed) {
			showToast(AppI18n.t('tasks.toast.manualRunBlocked', '请先停止调度器或切换到单任务模式后再手动执行任务'), 'warning');
			return;
		}

		try {
			await apiRequest(`/api/tasks/${taskId}/run`, { method: 'POST' });
			showToast('任务已开始执行', 'success');
			await loadTasks();
		} catch (error) {
			console.error('执行任务失败:', error);
			showToast(error.message || '执行任务失败', 'danger');
		}
	}

	async function cancelTask(taskId) {
		if (!confirm('确定要取消该任务吗？')) {
			return;
		}
		try {
			await apiRequest(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
			showToast('取消任务请求已发送', 'success');
			await loadTasks();
		} catch (error) {
			console.error('取消任务失败:', error);
			showToast(error.message || '取消任务失败', 'danger');
		}
	}

	async function deleteTask(taskId) {
		if (!confirm('删除后不可恢复，确定要删除该任务吗？')) {
			return;
		}

		try {
			await apiRequest(`/api/tasks/${taskId}`, { method: 'DELETE' });
			showToast('任务已删除', 'success');
			await loadTasks();
		} catch (error) {
			console.error('删除任务失败:', error);
			showToast(error.message || '删除任务失败', 'danger');
		}
	}

	async function editTask(taskId) {
		try {
			const taskConfig = await apiRequest(`/api/tasks/${taskId}`);
			populateTaskForm(taskConfig);
			document.getElementById('taskModalLabel').textContent = '编辑任务';
			taskModalInstance.show();
		} catch (error) {
			console.error('加载任务配置失败:', error);
			showToast(error.message || '加载任务配置失败', 'danger');
		}
	}

	function populateTaskForm(taskConfig) {
		editingTaskId = taskConfig.id;
		document.getElementById('taskId').value = taskConfig.id;
		document.getElementById('taskName').value = taskConfig.name || '';
		document.getElementById('taskDescription').value = taskConfig.description || '';
		document.getElementById('taskEnabled').checked = Boolean(taskConfig.enabled);
		document.getElementById('taskPriority').value = taskConfig.priority;

		ensureResourceGroupOption(taskConfig.resource_group);
		document.getElementById('resourceGroupSelect').value = taskConfig.resource_group || 'default';

		document.getElementById('mainCommand').value = taskConfig.main_command || '';
		document.getElementById('enableAdbWakeup').checked = Boolean(taskConfig.enable_adb_wakeup);
		document.getElementById('adbDeviceId').value = taskConfig.adb_device_id || '';
		document.getElementById('adbLaunchDelay').value = taskConfig.adb_launch_delay_seconds ?? '';
		document.getElementById('adbLaunchPackage').value = taskConfig.adb_launch_package || '';
		document.getElementById('adbLaunchActivity').value = taskConfig.adb_launch_activity || '';
		document.getElementById('enableGlobalLog').checked = Boolean(taskConfig.enable_global_log);
		document.getElementById('enableTempLog').checked = Boolean(taskConfig.enable_temp_log);
	document.getElementById('enableResolutionSwitch').checked = Boolean(taskConfig.enable_resolution_switch);
	document.getElementById('targetResolution').value = taskConfig.target_resolution || '';

		clearTriggers();
		const triggerList = Array.isArray(taskConfig.triggers) && taskConfig.triggers.length
			? taskConfig.triggers
			: (taskConfig.trigger ? [taskConfig.trigger] : []);
		if (triggerList.length) {
			triggerList.forEach(trigger => addTrigger(trigger));
		} else {
			addTrigger();
		}

		const postTask = taskConfig.post_task || {};
		const push = postTask.push_notification || {};
		document.getElementById('pushNotificationEnabled').checked = Boolean(push.enabled);
		document.getElementById('pushNotifySuccess').checked = push.on_success !== false;
		document.getElementById('pushNotifyFailure').checked = push.on_failure !== false;
		document.getElementById('pushTitle').value = push.title || '';
		document.getElementById('pushTag').value = push.tag || '';
		document.getElementById('pushContent').value = push.content || '';

		const keywords = postTask.log_keywords || [];
		document.getElementById('keywordList').value = keywords.join(', ');
		const keywordNotification = postTask.keyword_notification || {};
		const keywordEnabled = Boolean(keywords.length || Object.keys(keywordNotification).length);
		document.getElementById('keywordMonitoringEnabled').checked = keywordEnabled;
		document.getElementById('keywordTitle').value = keywordNotification.title || '';
		document.getElementById('keywordTag').value = keywordNotification.tag || '';
		document.getElementById('keywordContent').value = keywordNotification.content || '';

		const retryPolicy = taskConfig.retry_policy || {};
		const retryEnabled = Boolean(retryPolicy.enabled);
		document.getElementById('retryEnabled').checked = retryEnabled;
		document.getElementById('retryMax').value = retryPolicy.max_retries ?? 0;
		document.getElementById('retryDelay').value = retryPolicy.delay_seconds ?? 60;
		document.getElementById('retryNotify').value = retryPolicy.notify_after_retries ?? '';
	document.getElementById('retryRerunPreTasks').checked = retryPolicy.rerun_pre_tasks !== false;
		document.getElementById('retrySuccessWindow').checked = Boolean(retryPolicy.retry_on_success_within_window);
		document.getElementById('successRetryDelay').value = retryPolicy.success_retry_delay_seconds ?? '';
		document.getElementById('successRetryMax').value = retryPolicy.success_retry_max ?? '';

		toggleAdbConfig();
	toggleResolutionConfig();
		togglePushNotificationConfig();
		syncKeywordSectionVisibility();
		toggleKeywordConfig();
		toggleRetryConfig();
		toggleSuccessRetryConfig();
	}

	function createTask() {
		resetTaskForm();
		taskModalInstance.show();
	}

	function clearLogViewerContent() {
		const contentEl = document.getElementById('taskLogContent');
		if (contentEl) {
			contentEl.textContent = '';
		}
	}

	function updateLogStatusBadge(status) {
		const badge = document.getElementById('taskLogStatus');
		const color = statusColors[status] || 'secondary';
		const text = statusTexts[status] || status || '-';
		if (badge) {
			badge.textContent = text;
			badge.className = `badge bg-${color}`;
		}
	}

	async function loadTaskLogs(taskId, manual = false) {
		if (!taskId) {
			return;
		}
		try {
			const data = await apiRequest(`/api/tasks/${taskId}/logs/live?limit=200`);
			const lines = Array.isArray(data?.lines) ? data.lines : [];
			const contentElement = document.getElementById('taskLogContent');
			if (contentElement) {
				contentElement.textContent = lines.length ? lines.join('\n') : '暂无日志输出';
				contentElement.scrollTop = contentElement.scrollHeight;
			}

			updateLogStatusBadge(data?.status);

			const subtitleElement = document.getElementById('taskLogSubtitle');
			if (subtitleElement) {
				const timestamp = new Date().toLocaleTimeString();
				subtitleElement.textContent = `更新于 ${timestamp} · 最新 ${lines.length} 行`;
			}

			if (manual) {
				showToast('日志已刷新', 'info');
			}
		} catch (error) {
			console.error('刷新实时日志失败:', error);
		}
	}

	function stopLogPolling() {
		if (logPollingTimer) {
			clearInterval(logPollingTimer);
			logPollingTimer = null;
		}
	}

	function startLogPolling() {
		stopLogPolling();
		logPollingTimer = setInterval(() => {
			if (activeLogTaskId) {
				loadTaskLogs(activeLogTaskId);
			}
		}, 3000);
	}

	function openTaskLogs(taskId) {
		const task = tasks.find(item => item.id === taskId);
		if (!task) {
			showToast('无法找到该任务的配置', 'warning');
			return;
		}

		activeLogTaskId = taskId;
		if (!logOffcanvasInstance) {
			logOffcanvasInstance = new bootstrap.Offcanvas(document.getElementById('taskLogOffcanvas'));
		}

		const titleElement = document.getElementById('taskLogTitle');
		const subtitleElement = document.getElementById('taskLogSubtitle');
		if (titleElement) {
			titleElement.textContent = `${task.name} - 实时日志`;
		}
		if (subtitleElement) {
			subtitleElement.textContent = '正在加载日志...';
		}

		updateLogStatusBadge(task.status);
		clearLogViewerContent();

		logOffcanvasInstance.show();
		loadTaskLogs(taskId);
		startLogPolling();
	}

	document.addEventListener('DOMContentLoaded', () => {
		taskFormElement = document.getElementById('taskForm');
		taskModalInstance = new bootstrap.Modal(document.getElementById('taskModal'));

		document.getElementById('create-task-btn').addEventListener('click', createTask);
		document.getElementById('refresh-task-btn').addEventListener('click', loadTasks);
		document.getElementById('clear-filter-btn').addEventListener('click', clearFilters);

		document.getElementById('task-search').addEventListener('input', filterTasks);
		document.getElementById('status-filter').addEventListener('change', filterTasks);
		document.getElementById('group-filter').addEventListener('change', filterTasks);

		document.getElementById('addTriggerBtn').addEventListener('click', () => addTrigger());
		document.getElementById('enableAdbWakeup').addEventListener('change', toggleAdbConfig);
		document.getElementById('pushNotificationEnabled').addEventListener('change', togglePushNotificationConfig);
		document.getElementById('enableTempLog').addEventListener('change', syncKeywordSectionVisibility);
		document.getElementById('keywordMonitoringEnabled').addEventListener('change', toggleKeywordConfig);
		document.getElementById('retryEnabled').addEventListener('change', toggleRetryConfig);
		document.getElementById('retrySuccessWindow').addEventListener('change', toggleSuccessRetryConfig);
	document.getElementById('enableResolutionSwitch').addEventListener('change', toggleResolutionConfig);

		document.getElementById('run-task-btn').addEventListener('click', () => {
			if (currentTaskId) {
				runTask(currentTaskId);
			}
		});
		document.getElementById('cancel-task-btn').addEventListener('click', () => {
			if (currentTaskId) {
				cancelTask(currentTaskId);
			}
		});

		document.getElementById('taskDetailModal').addEventListener('hidden.bs.modal', () => {
			currentTaskId = null;
		});

		const offcanvasElement = document.getElementById('taskLogOffcanvas');
		offcanvasElement.addEventListener('hidden.bs.offcanvas', () => {
			stopLogPolling();
			activeLogTaskId = null;
			clearLogViewerContent();
			updateLogStatusBadge(null);
			const subtitleElement = document.getElementById('taskLogSubtitle');
			if (subtitleElement) {
				subtitleElement.textContent = '';
			}
		});

		document.getElementById('taskLogRefreshBtn').addEventListener('click', () => {
			if (activeLogTaskId) {
				loadTaskLogs(activeLogTaskId, true);
			}
		});

		document.getElementById('taskLogClearBtn').addEventListener('click', () => {
			clearLogViewerContent();
		});

		taskFormElement.addEventListener('submit', event => {
			event.preventDefault();
			if (!taskFormElement.reportValidity()) {
				return;
			}
			saveTask();
		});

		resetTaskForm();
		loadResourceGroups();
		loadTasks();
		setInterval(loadTasks, 15000);
	});
</script>
{% endblock %}
