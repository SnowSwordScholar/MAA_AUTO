{% extends "base.html" %}

{% block title %}任务管理 - MAA 任务调度器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
	<h1 class="h2"><i class="bi bi-list-task me-2"></i>任务管理</h1>
	<div class="btn-toolbar mb-2 mb-md-0">
		<div class="btn-group">
			<button type="button" class="btn btn-sm btn-primary" id="create-task-btn">
				<i class="bi bi-plus-circle"></i> 新建任务
			</button>
			<button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-task-btn">
				<i class="bi bi-arrow-clockwise"></i> 刷新
			</button>
		</div>
	</div>

	<style>
		.task-modal-body {
			max-height: calc(100vh - 220px);
			overflow-y: auto;
		}

		#taskLogContent {
			background-color: #1e1e1e;
			color: #dcdcdc;
			font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
			font-size: 0.85rem;
			white-space: pre-wrap;
			word-break: break-word;
			max-height: calc(100vh - 200px);
			overflow-y: auto;
			padding: 1rem;
			border-radius: 0.5rem;
		}

		#taskLogHeader small {
			font-size: 0.8rem;
		}
	</style>
</div>

<div class="row g-3 mb-4">
	<div class="col-md-4">
		<div class="input-group">
			<span class="input-group-text"><i class="bi bi-search"></i></span>
			<input type="text" class="form-control" id="task-search" placeholder="搜索任务名称或描述...">
		</div>
	</div>
	<div class="col-md-3">
		<select class="form-select" id="status-filter">
			<option value="">所有状态</option>
			<option value="pending">待执行</option>
			<option value="running">执行中</option>
			<option value="completed">已完成</option>
			<option value="failed">失败</option>
			<option value="cancelled">已取消</option>
		</select>
	</div>
	<div class="col-md-3">
		<select class="form-select" id="group-filter">
			<option value="">所有资源分组</option>
		</select>
	</div>
	<div class="col-md-2 d-grid">
		<button class="btn btn-outline-secondary" id="clear-filter-btn">
			<i class="bi bi-x-circle"></i> 清除筛选
		</button>
	</div>
</div>

<div class="card shadow-sm mb-4">
	<div class="card-body">
		<div class="table-responsive">
			<table class="table table-hover align-middle mb-0">
				<thead class="table-light">
					<tr>
						<th>任务名称</th>
						<th class="text-center">状态</th>
						<th class="text-center">优先级</th>
						<th class="text-center">资源分组</th>
						<th class="text-center">触发类型</th>
						<th class="text-center">下次执行</th>
						<th class="text-end">操作</th>
					</tr>
				</thead>
				<tbody id="tasks-table-body">
					<tr>
						<td colspan="7" class="text-center text-muted py-4">正在加载任务...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="taskLogOffcanvas" data-bs-scroll="true">
	<div class="offcanvas-header">
		<div>
			<h5 class="offcanvas-title" id="taskLogTitle">任务实时日志</h5>
			<small class="text-muted" id="taskLogSubtitle"></small>
		</div>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="关闭"></button>
	</div>
	<div class="offcanvas-body">
		<div class="d-flex justify-content-between align-items-center mb-2">
			<div>
				<span class="badge bg-primary" id="taskLogStatus">-</span>
			</div>
			<div class="btn-group btn-group-sm">
				<button class="btn btn-outline-secondary" id="taskLogRefreshBtn">
					<i class="bi bi-arrow-clockwise"></i> 手动刷新
				</button>
				<button class="btn btn-outline-danger" id="taskLogClearBtn">
					<i class="bi bi-x-circle"></i> 清屏
				</button>
			</div>
		</div>
		<div id="taskLogContent" class="border"></div>
	</div>
</div>

<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">任务详情</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
			</div>
			<div class="modal-body" id="task-detail-content">
				<div class="text-center text-muted py-4">
					<div class="spinner-border text-primary" role="status"></div>
					<p class="mt-3 mb-0">加载中...</p>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
				<button type="button" class="btn btn-success" id="run-task-btn" style="display: none;">
					<i class="bi bi-play"></i> 立即执行
				</button>
				<button type="button" class="btn btn-warning" id="cancel-task-btn" style="display: none;">
					<i class="bi bi-stop"></i> 取消任务
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-scrollable">
		<div class="modal-content">
			<form id="taskForm">
				<div class="modal-header">
					<h5 class="modal-title" id="taskModalLabel">创建任务</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
				</div>
				<div class="modal-body task-modal-body">
					<input type="hidden" id="taskId">

					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label">任务名称 <span class="text-danger">*</span></label>
							<input type="text" class="form-control" id="taskName" required maxlength="100">
						</div>
						<div class="col-md-3">
							<label class="form-label">优先级</label>
							<input type="number" class="form-control" id="taskPriority" min="1" max="10" value="5" required>
							<small class="text-muted">1 为最高优先级，10 为最低</small>
						</div>
						<div class="col-md-3">
							<label class="form-label">资源分组</label>
							<select class="form-select" id="resourceGroupSelect" required></select>
							<small class="text-muted">任务将在所选分组的执行器上运行</small>
						</div>
						<div class="col-12">
							<label class="form-label">任务描述</label>
							<textarea class="form-control" id="taskDescription" rows="2" maxlength="300" placeholder="可选，描述任务用途"></textarea>
						</div>
						<div class="col-12">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" id="taskEnabled" checked>
								<label class="form-check-label" for="taskEnabled">启用该任务</label>
							</div>
						</div>
					</div>

					<div class="card mt-4">
						<div class="card-header bg-light">
							<i class="bi bi-clock me-2"></i> 调度配置
						</div>
						<div class="card-body">
							<div class="row g-3 align-items-center mb-3">
								<div class="col-md-4">
									<label class="form-label">触发类型</label>
									<select class="form-select" id="triggerType">
										<option value="scheduled">定时执行</option>
										<option value="interval">间隔执行</option>
										<option value="random_time">随机时间</option>
									</select>
								</div>
							</div>

							<div id="scheduledConfig" class="trigger-config">
								<div class="row g-3">
									<div class="col-md-6">
										<label class="form-label">开始时间</label>
										<input type="time" class="form-control" id="scheduledStart" value="09:00">
									</div>
									<div class="col-md-6">
										<label class="form-label">结束时间</label>
										<input type="time" class="form-control" id="scheduledEnd" value="18:00">
									</div>
								</div>
								<small class="text-muted">系统将在时间区间内按照调度策略执行任务。</small>
							</div>

							<div id="intervalConfig" class="trigger-config d-none">
								<label class="form-label">间隔时间（分钟）</label>
								<input type="number" class="form-control" id="intervalMinutes" min="1" value="30">
								<small class="text-muted">任务完成后等待指定分钟数再次执行。</small>
							</div>

							<div id="randomTimeConfig" class="trigger-config d-none">
								<div class="row g-3">
									<div class="col-md-6">
										<label class="form-label">随机开始时间</label>
										<input type="time" class="form-control" id="randomStart" value="09:00">
									</div>
									<div class="col-md-6">
										<label class="form-label">随机结束时间</label>
										<input type="time" class="form-control" id="randomEnd" value="18:00">
									</div>
								</div>
								<small class="text-muted">系统会在时间范围内随机选择执行时间。</small>
							</div>
						</div>
					</div>

					<div class="card mt-4">
						<div class="card-header bg-light">
							<i class="bi bi-play-circle me-2"></i> 执行配置
						</div>
						<div class="card-body">
							<div class="mb-3">
								<label class="form-label">执行命令 <span class="text-danger">*</span></label>
								<textarea class="form-control font-monospace" id="mainCommand" rows="3" placeholder="输入完整的命令" required></textarea>
								<small class="text-muted">命令将在调度器所在机器执行，建议使用绝对路径或明确的环境变量。</small>
							</div>
							<div class="form-check mb-2">
								<input class="form-check-input" type="checkbox" id="enableAdbWakeup">
								<label class="form-check-label" for="enableAdbWakeup">启用 ADB 唤醒设备</label>
							</div>
							<div id="adbConfigSection" class="row g-3 d-none">
								<div class="col-md-6">
									<label class="form-label">ADB 设备 ID</label>
									<input type="text" class="form-control" id="adbDeviceId" placeholder="127.0.0.1:5555">
								</div>
							</div>
							<div class="row g-3 mt-1">
								<div class="col-md-6">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="enableGlobalLog" checked>
										<label class="form-check-label" for="enableGlobalLog">启用全局日志</label>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="enableTempLog">
										<label class="form-check-label" for="enableTempLog">启用临时日志</label>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="card mt-4">
						<div class="card-header bg-light">
							<i class="bi bi-arrow-repeat me-2"></i> 后置任务配置
						</div>
						<div class="card-body">
							<div class="form-check mb-3">
								<input class="form-check-input" type="checkbox" id="pushNotificationEnabled">
								<label class="form-check-label" for="pushNotificationEnabled">任务结束时发送推送通知</label>
							</div>
							<div id="pushNotificationConfig" class="border rounded p-3 mb-4 d-none">
								<div class="row g-3 mb-3">
									<div class="col-md-6">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="pushNotifySuccess" checked>
											<label class="form-check-label" for="pushNotifySuccess">任务成功时发送</label>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="pushNotifyFailure" checked>
											<label class="form-check-label" for="pushNotifyFailure">任务失败时发送</label>
										</div>
									</div>
								</div>
								<div class="row g-3 mb-3">
									<div class="col-md-6">
										<label class="form-label">通知标题</label>
										<input type="text" class="form-control" id="pushTitle" placeholder="任务 {task_name} {status}">
									</div>
									<div class="col-md-6">
										<label class="form-label">通知标签</label>
										<input type="text" class="form-control" id="pushTag" placeholder="task-status">
									</div>
								</div>
								<div>
									<label class="form-label">通知内容</label>
									<textarea class="form-control" id="pushContent" rows="3" placeholder="任务 {task_name} 已{status}，耗时 {duration} 秒"></textarea>
									<small class="text-muted">支持变量: {task_name}, {status}, {duration}, {start_time}, {end_time}</small>
								</div>
							</div>

							<div id="keywordSection" class="d-none">
								<hr>
								<div class="form-check mb-3">
									<input class="form-check-input" type="checkbox" id="keywordMonitoringEnabled">
									<label class="form-check-label" for="keywordMonitoringEnabled">启用日志关键词监控并推送</label>
									<small class="text-muted d-block">关键词监控依赖临时日志功能，请确保已启用。</small>
								</div>
								<div id="keywordConfig" class="border rounded p-3 d-none">
									<div class="mb-3">
										<label class="form-label">监控关键词</label>
										<input type="text" class="form-control" id="keywordList" placeholder="错误,失败,timeout">
										<small class="text-muted">使用逗号或换行分隔多个关键词，匹配任意一个即触发。</small>
									</div>
									<div class="row g-3 mb-3">
										<div class="col-md-6">
											<label class="form-label">通知标题</label>
											<input type="text" class="form-control" id="keywordTitle" placeholder="检测到关键词: {keywords}">
										</div>
										<div class="col-md-6">
											<label class="form-label">通知标签</label>
											<input type="text" class="form-control" id="keywordTag" placeholder="keyword-alert">
										</div>
									</div>
									<div>
										<label class="form-label">通知内容</label>
										<textarea class="form-control" id="keywordContent" rows="3" placeholder="任务 {task_name} 日志出现: {keywords}"></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
					<button type="submit" class="btn btn-primary" id="saveTaskBtn">
						<span class="save-text">保存任务</span>
						<span class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
					</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	let tasks = [];
	let filteredTasks = [];
	let resourceGroups = {};
	let editingTaskId = null;
	let currentTaskId = null;
	let taskModalInstance = null;
	let taskFormElement = null;
	let logPollingTimer = null;
	let activeLogTaskId = null;
	let logOffcanvasInstance = null;

	const statusColors = {
		pending: 'secondary',
		running: 'success',
		completed: 'primary',
		failed: 'danger',
		cancelled: 'warning'
	};

	const statusTexts = {
		pending: '待执行',
		running: '执行中',
		completed: '已完成',
		failed: '失败',
		cancelled: '已取消'
	};

	const triggerTypeTexts = {
		scheduled: '定时执行',
		interval: '间隔执行',
		random_time: '随机时间'
	};

	function escapeHtml(value) {
		if (value === null || value === undefined) {
			return '';
		}
		return String(value)
			.replace(/&/g, '&amp;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;')
			.replace(/"/g, '&quot;')
			.replace(/'/g, '&#39;');
	}

	function formatDateTime(value) {
		if (!value) {
			return '-';
		}
		const date = new Date(value);
		if (Number.isNaN(date.getTime())) {
			return '-';
		}
		return date.toLocaleString();
	}

	async function loadTasks() {
		try {
			const result = await apiRequest('/api/tasks');
			tasks = Array.isArray(result) ? result : [];
			filterTasks();
		} catch (error) {
			console.error('加载任务列表失败:', error);
			showToast(error.message || '加载任务列表失败', 'danger');
		}
	}

	async function loadResourceGroups() {
		try {
			const result = await apiRequest('/api/resource-groups');
			resourceGroups = result || {};
			updateResourceGroupSelects();
		} catch (error) {
			console.error('加载资源分组失败:', error);
			showToast(error.message || '加载资源分组失败', 'danger');
		}
	}

	function updateResourceGroupSelects() {
		const filterSelect = document.getElementById('group-filter');
		const formSelect = document.getElementById('resourceGroupSelect');
		const currentValue = formSelect.value;

		filterSelect.innerHTML = '<option value="">所有资源分组</option>';
		formSelect.innerHTML = '';

		const groups = Object.values(resourceGroups);
		if (!groups.length) {
			const option = document.createElement('option');
			option.value = 'default';
			option.textContent = 'default (默认)';
			formSelect.appendChild(option);
		} else {
			groups.forEach(groupStatus => {
				const option = document.createElement('option');
				option.value = groupStatus.name;
				option.textContent = `${groupStatus.name} (${groupStatus.description || '无描述'})`;
				formSelect.appendChild(option);

				const filterOption = document.createElement('option');
				filterOption.value = groupStatus.name;
				filterOption.textContent = groupStatus.name;
				filterSelect.appendChild(filterOption);
			});
		}

		if (currentValue) {
			ensureResourceGroupOption(currentValue);
			formSelect.value = currentValue;
		}
	}

	function ensureResourceGroupOption(groupName) {
		if (!groupName) {
			return;
		}
		const formSelect = document.getElementById('resourceGroupSelect');
		const exists = Array.from(formSelect.options).some(option => option.value === groupName);
		if (!exists) {
			const option = document.createElement('option');
			option.value = groupName;
			option.textContent = `${groupName} (未在资源组配置中)`;
			formSelect.appendChild(option);
		}
	}

	function updateTasksTable() {
		const tbody = document.getElementById('tasks-table-body');
		if (!filteredTasks.length) {
			tbody.innerHTML = `
				<tr>
					<td colspan="7" class="text-center text-muted py-4">暂无匹配的任务</td>
				</tr>
			`;
			return;
		}

		const mode = systemStatus?.mode || 'scheduler';
		tbody.innerHTML = filteredTasks.map(task => {
			const status = task.status || 'pending';
			const statusBadge = statusColors[status] || 'secondary';
			const statusText = statusTexts[status] || status;
			const triggerType = task.trigger?.trigger_type || task.trigger_type || '-';
			const nextRunTime = formatDateTime(task.next_run_time);
			const resourceGroup = task.resource_group || '-';
			const canManualRun = mode === 'single_task' && status !== 'running';

			const descriptionLine = task.description
				? `<small class="text-muted">${escapeHtml(task.description)}</small>`
				: '';

			const runBtn = canManualRun
				? `<button class="btn btn-outline-success" onclick="runTask('${task.id}')" title="立即执行">
						<i class="bi bi-play"></i>
				   </button>`
				: '';

			const cancelBtn = status === 'running'
				? `<button class="btn btn-outline-warning" onclick="cancelTask('${task.id}')" title="取消任务">
						<i class="bi bi-stop"></i>
				   </button>`
				: '';

			const logBtn = task.enable_global_log
				? `<button class="btn btn-outline-dark" onclick="openTaskLogs('${task.id}')" title="实时日志">
						<i class="bi bi-terminal"></i>
				   </button>`
				: '';

			return `
				<tr>
					<td>
						<div class="fw-semibold">${escapeHtml(task.name)}</div>
						${descriptionLine}
					</td>
					<td class="text-center"><span class="badge bg-${statusBadge}">${statusText}</span></td>
					<td class="text-center"><span class="badge bg-secondary">${task.priority}</span></td>
					<td class="text-center">${escapeHtml(resourceGroup)}</td>
					<td class="text-center">${triggerTypeTexts[triggerType] || triggerType}</td>
					<td class="text-center"><small>${nextRunTime}</small></td>
					<td class="text-end">
						<div class="btn-group btn-group-sm" role="group">
							<button class="btn btn-outline-primary" onclick="viewTask('${task.id}')" title="查看详情">
								<i class="bi bi-eye"></i>
							</button>
							${logBtn}
							${runBtn}
							${cancelBtn}
							<button class="btn btn-outline-secondary" onclick="editTask('${task.id}')" title="编辑">
								<i class="bi bi-pencil"></i>
							</button>
							<button class="btn btn-outline-danger" onclick="deleteTask('${task.id}')" title="删除">
								<i class="bi bi-trash"></i>
							</button>
						</div>
					</td>
				</tr>
			`;
		}).join('');
	}

	function filterTasks() {
		const searchText = document.getElementById('task-search').value.trim().toLowerCase();
		const statusFilter = document.getElementById('status-filter').value;
		const groupFilter = document.getElementById('group-filter').value;

		filteredTasks = tasks.filter(task => {
			const name = (task.name || '').toLowerCase();
			const description = (task.description || '').toLowerCase();
			const matchesSearch = !searchText || name.includes(searchText) || description.includes(searchText);
			const matchesStatus = !statusFilter || task.status === statusFilter;
			const matchesGroup = !groupFilter || task.resource_group === groupFilter;
			return matchesSearch && matchesStatus && matchesGroup;
		});

		updateTasksTable();
	}

	function clearFilters() {
		document.getElementById('task-search').value = '';
		document.getElementById('status-filter').value = '';
		document.getElementById('group-filter').value = '';
		filteredTasks = tasks;
		updateTasksTable();
	}

	function resetTaskForm() {
		editingTaskId = null;
		document.getElementById('taskModalLabel').textContent = '创建任务';
		taskFormElement.reset();

		document.getElementById('taskPriority').value = 5;
		document.getElementById('triggerType').value = 'scheduled';
		document.getElementById('scheduledStart').value = '09:00';
		document.getElementById('scheduledEnd').value = '18:00';
		document.getElementById('intervalMinutes').value = 30;
		document.getElementById('randomStart').value = '09:00';
		document.getElementById('randomEnd').value = '18:00';

		document.getElementById('taskEnabled').checked = true;
		document.getElementById('enableAdbWakeup').checked = false;
		document.getElementById('enableGlobalLog').checked = true;
		document.getElementById('enableTempLog').checked = false;
		document.getElementById('pushNotificationEnabled').checked = false;
		document.getElementById('keywordMonitoringEnabled').checked = false;

		toggleAdbConfig();
		showTriggerConfig('scheduled');
		togglePushNotificationConfig();
		syncKeywordSectionVisibility();
		toggleKeywordConfig();

		const groupSelect = document.getElementById('resourceGroupSelect');
		if (groupSelect.options.length > 0) {
			groupSelect.selectedIndex = 0;
		}
	}

	function showTriggerConfig(type) {
		document.querySelectorAll('.trigger-config').forEach(section => {
			section.classList.add('d-none');
		});

		if (type === 'scheduled') {
			document.getElementById('scheduledConfig').classList.remove('d-none');
		} else if (type === 'interval') {
			document.getElementById('intervalConfig').classList.remove('d-none');
		} else if (type === 'random_time') {
			document.getElementById('randomTimeConfig').classList.remove('d-none');
		}
	}

	function toggleAdbConfig() {
		const enableAdb = document.getElementById('enableAdbWakeup').checked;
		document.getElementById('adbConfigSection').classList.toggle('d-none', !enableAdb);
		if (!enableAdb) {
			document.getElementById('adbDeviceId').value = '';
		}
	}

	function togglePushNotificationConfig() {
		const enabled = document.getElementById('pushNotificationEnabled').checked;
		document.getElementById('pushNotificationConfig').classList.toggle('d-none', !enabled);
	}

	function syncKeywordSectionVisibility() {
		const enableTemp = document.getElementById('enableTempLog').checked;
		const section = document.getElementById('keywordSection');
		section.classList.toggle('d-none', !enableTemp);
		if (!enableTemp) {
			document.getElementById('keywordMonitoringEnabled').checked = false;
			toggleKeywordConfig();
		}
	}

	function toggleKeywordConfig() {
		const enabled = document.getElementById('keywordMonitoringEnabled').checked;
		document.getElementById('keywordConfig').classList.toggle('d-none', !enabled);
	}

	function buildPostTaskConfig() {
		const pushEnabled = document.getElementById('pushNotificationEnabled').checked;
		const pushConfig = {
			enabled: pushEnabled,
			on_success: pushEnabled ? document.getElementById('pushNotifySuccess').checked : false,
			on_failure: pushEnabled ? document.getElementById('pushNotifyFailure').checked : false
		};

		if (pushEnabled) {
			const title = document.getElementById('pushTitle').value.trim();
			const tag = document.getElementById('pushTag').value.trim();
			const content = document.getElementById('pushContent').value.trim();
			if (title) pushConfig.title = title;
			if (tag) pushConfig.tag = tag;
			if (content) pushConfig.content = content;
		}

		const enableTemp = document.getElementById('enableTempLog').checked;
		const keywordEnabled = enableTemp && document.getElementById('keywordMonitoringEnabled').checked;

		const rawKeywords = document.getElementById('keywordList').value;
		const keywordList = rawKeywords
			.split(/[\n,]/)
			.map(item => item.trim())
			.filter(Boolean);

		let keywordNotification = null;
		if (keywordEnabled) {
			keywordNotification = {};
			const title = document.getElementById('keywordTitle').value.trim();
			const tag = document.getElementById('keywordTag').value.trim();
			const content = document.getElementById('keywordContent').value.trim();
			if (title) keywordNotification.title = title;
			if (tag) keywordNotification.tag = tag;
			if (content) keywordNotification.content = content;
			if (!Object.keys(keywordNotification).length) {
				keywordNotification = null;
			}
		}

		return {
			log_keywords: keywordEnabled ? keywordList : [],
			keyword_notification: keywordEnabled ? keywordNotification : null,
			push_notification: pushConfig
		};
	}

	function buildTriggerConfig() {
		const type = document.getElementById('triggerType').value;
		const trigger = { trigger_type: type };

		if (type === 'scheduled') {
			trigger.start_time = document.getElementById('scheduledStart').value || null;
			trigger.end_time = document.getElementById('scheduledEnd').value || null;
		} else if (type === 'interval') {
			const interval = Number(document.getElementById('intervalMinutes').value);
			trigger.interval_minutes = Number.isFinite(interval) && interval > 0 ? interval : null;
		} else if (type === 'random_time') {
			trigger.random_start_time = document.getElementById('randomStart').value || null;
			trigger.random_end_time = document.getElementById('randomEnd').value || null;
		}

		return trigger;
	}

	function collectTaskPayload() {
		const enableAdb = document.getElementById('enableAdbWakeup').checked;
		const adbDeviceId = document.getElementById('adbDeviceId').value.trim();

		const payload = {
			name: document.getElementById('taskName').value.trim(),
			description: document.getElementById('taskDescription').value.trim(),
			enabled: document.getElementById('taskEnabled').checked,
			priority: Number(document.getElementById('taskPriority').value) || 5,
			resource_group: document.getElementById('resourceGroupSelect').value,
			main_command: document.getElementById('mainCommand').value.trim(),
			enable_adb_wakeup: enableAdb,
			adb_device_id: enableAdb && adbDeviceId ? adbDeviceId : null,
			enable_global_log: document.getElementById('enableGlobalLog').checked,
			enable_temp_log: document.getElementById('enableTempLog').checked,
			trigger: buildTriggerConfig(),
			post_task: buildPostTaskConfig()
		};

		if (editingTaskId) {
			payload.id = editingTaskId;
		}

		return payload;
	}

	async function saveTask() {
		const submitButton = document.getElementById('saveTaskBtn');
		const spinner = document.getElementById('saveSpinner');
		submitButton.disabled = true;
		spinner.classList.remove('d-none');

		try {
			const payload = collectTaskPayload();
			if (!payload.name) {
				showToast('任务名称不能为空', 'warning');
				return;
			}
			if (!payload.main_command) {
				showToast('执行命令不能为空', 'warning');
				return;
			}

			const isEdit = Boolean(editingTaskId);
			const url = isEdit ? `/api/tasks/${editingTaskId}` : '/api/tasks';
			const method = isEdit ? 'PUT' : 'POST';

			await apiRequest(url, {
				method,
				body: JSON.stringify(payload)
			});

			showToast(isEdit ? '任务更新成功' : '任务创建成功', 'success');
			taskModalInstance.hide();
			await loadTasks();
		} catch (error) {
			console.error('保存任务失败:', error);
			showToast(error.message || '保存任务失败', 'danger');
		} finally {
			spinner.classList.add('d-none');
			submitButton.disabled = false;
		}
	}

	async function viewTask(taskId) {
		const detailModalElement = document.getElementById('taskDetailModal');
		const modal = bootstrap.Modal.getOrCreateInstance(detailModalElement);
		const detailContainer = document.getElementById('task-detail-content');

		detailContainer.innerHTML = `
			<div class="text-center text-muted py-4">
				<div class="spinner-border text-primary" role="status"></div>
				<p class="mt-3 mb-0">加载中...</p>
			</div>
		`;

		try {
			const taskConfig = await apiRequest(`/api/tasks/${taskId}`);
			currentTaskId = taskId;
			renderTaskDetail(taskConfig);
			updateTaskDetailActions(taskId);
			modal.show();
		} catch (error) {
			console.error('加载任务详情失败:', error);
			showToast(error.message || '加载任务详情失败', 'danger');
		}
	}

	function renderTaskDetail(taskConfig) {
		const listTask = tasks.find(task => task.id === taskConfig.id);
		const status = listTask ? listTask.status : 'pending';
		const statusBadge = statusColors[status] || 'secondary';
		const statusText = statusTexts[status] || status;
		const nextRunTime = listTask ? formatDateTime(listTask.next_run_time) : '-';
		const trigger = taskConfig.trigger || {};
		const postTask = taskConfig.post_task || {};
		const push = postTask.push_notification || {};
		const keywords = postTask.log_keywords || [];
		const keywordNotification = postTask.keyword_notification || {};

		const triggerDetails = (() => {
			if (trigger.trigger_type === 'scheduled') {
				return `
					<tr><th>开始时间</th><td>${escapeHtml(trigger.start_time || '-')}</td></tr>
					<tr><th>结束时间</th><td>${escapeHtml(trigger.end_time || '-')}</td></tr>
				`;
			}
			if (trigger.trigger_type === 'interval') {
				return `<tr><th>间隔分钟</th><td>${trigger.interval_minutes ?? '-'}</td></tr>`;
			}
			if (trigger.trigger_type === 'random_time') {
				return `<tr><th>随机区间</th><td>${escapeHtml(trigger.random_start_time || '-')} ~ ${escapeHtml(trigger.random_end_time || '-')}</td></tr>`;
			}
			return '';
		})();

		const keywordBadges = keywords.length
			? keywords.map(word => `<span class="badge bg-warning text-dark me-1 mb-1">${escapeHtml(word)}</span>`).join('')
			: '<span class="text-muted">未配置关键词</span>';

		const detailHtml = `
			<div class="row g-4">
				<div class="col-md-6">
					<h6 class="text-muted mb-2">基本信息</h6>
					<table class="table table-sm">
						<tr><th>名称</th><td>${escapeHtml(taskConfig.name)}</td></tr>
						<tr><th>描述</th><td>${escapeHtml(taskConfig.description) || '-'}</td></tr>
						<tr><th>状态</th><td><span class="badge bg-${statusBadge}">${statusText}</span></td></tr>
						<tr><th>下次执行</th><td>${nextRunTime}</td></tr>
						<tr><th>优先级</th><td>${taskConfig.priority}</td></tr>
						<tr><th>资源分组</th><td>${escapeHtml(taskConfig.resource_group || '-')}</td></tr>
						<tr><th>启用</th><td>${taskConfig.enabled ? '是' : '否'}</td></tr>
					</table>
				</div>
				<div class="col-md-6">
					<h6 class="text-muted mb-2">触发配置</h6>
					<table class="table table-sm">
						<tr><th>触发类型</th><td>${triggerTypeTexts[trigger.trigger_type] || trigger.trigger_type || '-'}</td></tr>
						${triggerDetails}
					</table>
				</div>
				<div class="col-md-6">
					<h6 class="text-muted mb-2">执行配置</h6>
					<table class="table table-sm">
						<tr><th>执行命令</th><td><code>${escapeHtml(taskConfig.main_command)}</code></td></tr>
						<tr><th>ADB 唤醒</th><td>${taskConfig.enable_adb_wakeup ? '是' : '否'}</td></tr>
						<tr><th>ADB 设备</th><td>${escapeHtml(taskConfig.adb_device_id) || '-'}</td></tr>
						<tr><th>全局日志</th><td>${taskConfig.enable_global_log ? '启用' : '关闭'}</td></tr>
						<tr><th>临时日志</th><td>${taskConfig.enable_temp_log ? '启用' : '关闭'}</td></tr>
					</table>
				</div>
				<div class="col-md-6">
					<h6 class="text-muted mb-2">后置通知</h6>
					<table class="table table-sm">
						<tr><th>推送通知</th><td>${push.enabled ? '启用' : '关闭'}</td></tr>
						<tr><th>成功时发送</th><td>${push.on_success ? '是' : '否'}</td></tr>
						<tr><th>失败时发送</th><td>${push.on_failure ? '是' : '否'}</td></tr>
						<tr><th>标题</th><td>${escapeHtml(push.title) || '-'}</td></tr>
						<tr><th>标签</th><td>${escapeHtml(push.tag) || '-'}</td></tr>
						<tr><th>内容</th><td>${escapeHtml(push.content) || '-'}</td></tr>
					</table>
					<h6 class="text-muted mb-2">关键词监控</h6>
					<div class="mb-2">${keywordBadges}</div>
					<table class="table table-sm">
						<tr><th>标题</th><td>${escapeHtml(keywordNotification.title) || '-'}</td></tr>
						<tr><th>标签</th><td>${escapeHtml(keywordNotification.tag) || '-'}</td></tr>
						<tr><th>内容</th><td>${escapeHtml(keywordNotification.content) || '-'}</td></tr>
					</table>
				</div>
			</div>
		`;

		document.getElementById('task-detail-content').innerHTML = detailHtml;
	}

	function updateTaskDetailActions(taskId) {
		const listTask = tasks.find(task => task.id === taskId);
		const status = listTask ? listTask.status : 'pending';
		const mode = systemStatus?.mode || 'scheduler';

		const runBtn = document.getElementById('run-task-btn');
		const cancelBtn = document.getElementById('cancel-task-btn');

		if (status === 'running') {
			runBtn.style.display = 'none';
			cancelBtn.style.display = 'inline-block';
		} else if (mode === 'single_task') {
			runBtn.style.display = 'inline-block';
			cancelBtn.style.display = 'none';
		} else {
			runBtn.style.display = 'none';
			cancelBtn.style.display = 'none';
		}
	}

	async function runTask(taskId) {
		if (systemStatus?.mode !== 'single_task') {
			showToast('需要在单任务模式下才能手动执行任务', 'warning');
			return;
		}

		try {
			await apiRequest(`/api/tasks/${taskId}/run`, { method: 'POST' });
			showToast('任务已开始执行', 'success');
			await loadTasks();
		} catch (error) {
			console.error('执行任务失败:', error);
			showToast(error.message || '执行任务失败', 'danger');
		}
	}

	async function cancelTask(taskId) {
		if (!confirm('确定要取消该任务吗？')) {
			return;
		}
		try {
			await apiRequest(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
			showToast('取消任务请求已发送', 'success');
			await loadTasks();
		} catch (error) {
			console.error('取消任务失败:', error);
			showToast(error.message || '取消任务失败', 'danger');
		}
	}

	async function deleteTask(taskId) {
		if (!confirm('删除后不可恢复，确定要删除该任务吗？')) {
			return;
		}

		try {
			await apiRequest(`/api/tasks/${taskId}`, { method: 'DELETE' });
			showToast('任务已删除', 'success');
			await loadTasks();
		} catch (error) {
			console.error('删除任务失败:', error);
			showToast(error.message || '删除任务失败', 'danger');
		}
	}

	async function editTask(taskId) {
		try {
			const taskConfig = await apiRequest(`/api/tasks/${taskId}`);
			populateTaskForm(taskConfig);
			document.getElementById('taskModalLabel').textContent = '编辑任务';
			taskModalInstance.show();
		} catch (error) {
			console.error('加载任务配置失败:', error);
			showToast(error.message || '加载任务配置失败', 'danger');
		}
	}

	function populateTaskForm(taskConfig) {
		editingTaskId = taskConfig.id;
		document.getElementById('taskId').value = taskConfig.id;
		document.getElementById('taskName').value = taskConfig.name || '';
		document.getElementById('taskDescription').value = taskConfig.description || '';
		document.getElementById('taskEnabled').checked = Boolean(taskConfig.enabled);
		document.getElementById('taskPriority').value = taskConfig.priority;

		ensureResourceGroupOption(taskConfig.resource_group);
		document.getElementById('resourceGroupSelect').value = taskConfig.resource_group || 'default';

		document.getElementById('mainCommand').value = taskConfig.main_command || '';
		document.getElementById('enableAdbWakeup').checked = Boolean(taskConfig.enable_adb_wakeup);
		document.getElementById('adbDeviceId').value = taskConfig.adb_device_id || '';
		document.getElementById('enableGlobalLog').checked = Boolean(taskConfig.enable_global_log);
		document.getElementById('enableTempLog').checked = Boolean(taskConfig.enable_temp_log);

		const trigger = taskConfig.trigger || { trigger_type: 'scheduled' };
		const triggerType = trigger.trigger_type || 'scheduled';
		document.getElementById('triggerType').value = triggerType;
		showTriggerConfig(triggerType);

		document.getElementById('scheduledStart').value = trigger.start_time || '09:00';
		document.getElementById('scheduledEnd').value = trigger.end_time || '18:00';
		document.getElementById('intervalMinutes').value = trigger.interval_minutes ?? 30;
		document.getElementById('randomStart').value = trigger.random_start_time || '09:00';
		document.getElementById('randomEnd').value = trigger.random_end_time || '18:00';

		const postTask = taskConfig.post_task || {};
		const push = postTask.push_notification || {};
		document.getElementById('pushNotificationEnabled').checked = Boolean(push.enabled);
		document.getElementById('pushNotifySuccess').checked = push.on_success !== false;
		document.getElementById('pushNotifyFailure').checked = push.on_failure !== false;
		document.getElementById('pushTitle').value = push.title || '';
		document.getElementById('pushTag').value = push.tag || '';
		document.getElementById('pushContent').value = push.content || '';

		const keywords = postTask.log_keywords || [];
		document.getElementById('keywordList').value = keywords.join(', ');
		const keywordNotification = postTask.keyword_notification || {};
		const keywordEnabled = Boolean(keywords.length || Object.keys(keywordNotification).length);
		document.getElementById('keywordMonitoringEnabled').checked = keywordEnabled;
		document.getElementById('keywordTitle').value = keywordNotification.title || '';
		document.getElementById('keywordTag').value = keywordNotification.tag || '';
		document.getElementById('keywordContent').value = keywordNotification.content || '';

		toggleAdbConfig();
		togglePushNotificationConfig();
		syncKeywordSectionVisibility();
		toggleKeywordConfig();
	}

	function createTask() {
		resetTaskForm();
		taskModalInstance.show();
	}

	function clearLogViewerContent() {
		const contentEl = document.getElementById('taskLogContent');
		if (contentEl) {
			contentEl.textContent = '';
		}
	}

	function updateLogStatusBadge(status) {
		const badge = document.getElementById('taskLogStatus');
		const color = statusColors[status] || 'secondary';
		const text = statusTexts[status] || status || '-';
		if (badge) {
			badge.textContent = text;
			badge.className = `badge bg-${color}`;
		}
	}

	async function loadTaskLogs(taskId, manual = false) {
		if (!taskId) {
			return;
		}
		try {
			const data = await apiRequest(`/api/tasks/${taskId}/logs/live?limit=200`);
			const lines = Array.isArray(data?.lines) ? data.lines : [];
			const contentElement = document.getElementById('taskLogContent');
			if (contentElement) {
				contentElement.textContent = lines.length ? lines.join('\n') : '暂无日志输出';
				contentElement.scrollTop = contentElement.scrollHeight;
			}

			updateLogStatusBadge(data?.status);

			const subtitleElement = document.getElementById('taskLogSubtitle');
			if (subtitleElement) {
				const timestamp = new Date().toLocaleTimeString();
				subtitleElement.textContent = `更新于 ${timestamp} · 最新 ${lines.length} 行`;
			}

			if (manual) {
				showToast('日志已刷新', 'info');
			}
		} catch (error) {
			console.error('刷新实时日志失败:', error);
		}
	}

	function stopLogPolling() {
		if (logPollingTimer) {
			clearInterval(logPollingTimer);
			logPollingTimer = null;
		}
	}

	function startLogPolling() {
		stopLogPolling();
		logPollingTimer = setInterval(() => {
			if (activeLogTaskId) {
				loadTaskLogs(activeLogTaskId);
			}
		}, 3000);
	}

	function openTaskLogs(taskId) {
		const task = tasks.find(item => item.id === taskId);
		if (!task) {
			showToast('无法找到该任务的配置', 'warning');
			return;
		}

		activeLogTaskId = taskId;
		if (!logOffcanvasInstance) {
			logOffcanvasInstance = new bootstrap.Offcanvas(document.getElementById('taskLogOffcanvas'));
		}

		const titleElement = document.getElementById('taskLogTitle');
		const subtitleElement = document.getElementById('taskLogSubtitle');
		if (titleElement) {
			titleElement.textContent = `${task.name} - 实时日志`;
		}
		if (subtitleElement) {
			subtitleElement.textContent = '正在加载日志...';
		}

		updateLogStatusBadge(task.status);
		clearLogViewerContent();

		logOffcanvasInstance.show();
		loadTaskLogs(taskId);
		startLogPolling();
	}

	document.addEventListener('DOMContentLoaded', () => {
		taskFormElement = document.getElementById('taskForm');
		taskModalInstance = new bootstrap.Modal(document.getElementById('taskModal'));

		document.getElementById('create-task-btn').addEventListener('click', createTask);
		document.getElementById('refresh-task-btn').addEventListener('click', loadTasks);
		document.getElementById('clear-filter-btn').addEventListener('click', clearFilters);

		document.getElementById('task-search').addEventListener('input', filterTasks);
		document.getElementById('status-filter').addEventListener('change', filterTasks);
		document.getElementById('group-filter').addEventListener('change', filterTasks);

		document.getElementById('triggerType').addEventListener('change', event => {
			showTriggerConfig(event.target.value);
		});
		document.getElementById('enableAdbWakeup').addEventListener('change', toggleAdbConfig);
		document.getElementById('pushNotificationEnabled').addEventListener('change', togglePushNotificationConfig);
		document.getElementById('enableTempLog').addEventListener('change', syncKeywordSectionVisibility);
		document.getElementById('keywordMonitoringEnabled').addEventListener('change', toggleKeywordConfig);

		document.getElementById('run-task-btn').addEventListener('click', () => {
			if (currentTaskId) {
				runTask(currentTaskId);
			}
		});
		document.getElementById('cancel-task-btn').addEventListener('click', () => {
			if (currentTaskId) {
				cancelTask(currentTaskId);
			}
		});

		document.getElementById('taskDetailModal').addEventListener('hidden.bs.modal', () => {
			currentTaskId = null;
		});

		const offcanvasElement = document.getElementById('taskLogOffcanvas');
		offcanvasElement.addEventListener('hidden.bs.offcanvas', () => {
			stopLogPolling();
			activeLogTaskId = null;
			clearLogViewerContent();
			updateLogStatusBadge(null);
			const subtitleElement = document.getElementById('taskLogSubtitle');
			if (subtitleElement) {
				subtitleElement.textContent = '';
			}
		});

		document.getElementById('taskLogRefreshBtn').addEventListener('click', () => {
			if (activeLogTaskId) {
				loadTaskLogs(activeLogTaskId, true);
			}
		});

		document.getElementById('taskLogClearBtn').addEventListener('click', () => {
			clearLogViewerContent();
		});

		taskFormElement.addEventListener('submit', event => {
			event.preventDefault();
			if (!taskFormElement.reportValidity()) {
				return;
			}
			saveTask();
		});

		resetTaskForm();
		loadResourceGroups();
		loadTasks();
		setInterval(loadTasks, 15000);
	});
</script>
{% endblock %}
