{% extends "base.html" %}

{% block title %}日志查看 - MAA 任务调度器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-file-text"></i> 日志查看</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" id="auto-refresh-logs">
                <i class="bi bi-pause-fill"></i> 暂停自动刷新
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearCurrentLog()">
                <i class="bi bi-trash"></i> 清空显示
            </button>
        </div>
    </div>
</div>

<!-- 日志类型选择 -->
<div class="row mb-3">
    <div class="col-md-3">
        <label class="form-label">日志类型</label>
        <select class="form-select" id="log-type-select">
            <option value="system">系统日志</option>
            <option value="task">任务日志</option>
        </select>
    </div>
    <div class="col-md-3" id="task-select-container" style="display: none;">
        <label class="form-label">选择任务</label>
        <select class="form-select" id="task-select">
            <option value="">选择任务...</option>
        </select>
    </div>
    <div class="col-md-3" id="execution-select-container" style="display: none;">
        <label class="form-label">执行记录</label>
        <select class="form-select" id="execution-select">
            <option value="">最近一次执行</option>
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">日志级别</label>
        <select class="form-select" id="log-level-filter">
            <option value="">所有级别</option>
            <option value="DEBUG">DEBUG</option>
            <option value="INFO">INFO</option>
            <option value="WARNING">WARNING</option>
            <option value="ERROR">ERROR</option>
            <option value="CRITICAL">CRITICAL</option>
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">显示行数</label>
        <select class="form-select" id="log-lines-limit">
            <option value="50">50 行</option>
            <option value="100" selected>100 行</option>
            <option value="200">200 行</option>
            <option value="500">500 行</option>
            <option value="1000">1000 行</option>
        </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="loadLogs()">
            <i class="bi bi-search"></i> 加载
        </button>
    </div>
</div>

<div class="row mb-3" id="execution-meta-row" style="display: none;">
    <div class="col-12">
        <div class="alert alert-secondary py-2 mb-0" id="execution-meta">
            <div class="d-flex flex-wrap gap-3 small" id="execution-meta-content"></div>
        </div>
    </div>
</div>

<!-- 搜索和过滤 -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="log-search" placeholder="搜索日志内容...">
            <button class="btn btn-outline-secondary" onclick="filterLogs()">搜索</button>
        </div>
    </div>
    <div class="col-md-3">
        <input type="datetime-local" class="form-control" id="time-filter-start" placeholder="开始时间">
    </div>
    <div class="col-md-3">
        <input type="datetime-local" class="form-control" id="time-filter-end" placeholder="结束时间">
    </div>
</div>

<!-- 日志统计 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="row text-center">
                    <div class="col-md-2">
                        <small class="text-muted">总行数</small>
                        <div class="fw-bold" id="log-total-lines">0</div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">DEBUG</small>
                        <div class="fw-bold text-secondary" id="log-debug-count">0</div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">INFO</small>
                        <div class="fw-bold text-info" id="log-info-count">0</div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">WARNING</small>
                        <div class="fw-bold text-warning" id="log-warning-count">0</div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">ERROR</small>
                        <div class="fw-bold text-danger" id="log-error-count">0</div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">最后更新</small>
                        <div class="fw-bold text-success" id="log-last-update">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 日志显示区域 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-0">日志内容</h6>
            <small class="text-muted" id="log-source-info">选择日志类型和来源</small>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="follow-log-switch">
            <label class="form-check-label" for="follow-log-switch">跟随最新</label>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="log-display" class="log-container" style="height: 600px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 13px; padding: 15px;">
            <div class="text-center text-muted" style="margin-top: 200px;">
                <i class="bi bi-file-text" style="font-size: 4rem; opacity: 0.5;"></i>
                <p style="font-size: 1.2rem; margin-top: 20px;">请选择日志类型并点击加载按钮</p>
            </div>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="scrollToTop()">
                <i class="bi bi-arrow-up"></i> 顶部
            </button>
            <button class="btn btn-outline-secondary" onclick="scrollToBottom()">
                <i class="bi bi-arrow-down"></i> 底部
            </button>
        </div>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="exportLogs()">
                <i class="bi bi-download"></i> 导出
            </button>
            <button class="btn btn-outline-info" onclick="copyLogs()">
                <i class="bi bi-clipboard"></i> 复制
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let autoRefreshLogsEnabled = true;
    let autoRefreshLogsTimer = null;
    let currentLogs = [];
    let filteredLogs = [];
    let currentLogType = 'system';
    let currentTaskId = null;
    let lastTaskLogSource = null;
    let taskLogRecords = [];
    let currentRunId = null;
    let taskSelectElement = null;
    let executionSelectElement = null;
    let executionSelectContainer = null;
    let executionMetaRow = null;
    let executionMetaContent = null;
    const logEventUnsubscribers = [];

    function getStatusText(status) {
        if (window.AppI18n && typeof AppI18n.statusText === 'function') {
            return AppI18n.statusText(status);
        }
        if (!status) {
            return 'pending';
        }
        const normalized = String(status).toLowerCase();
        const fallback = {
            pending: '待执行',
            running: '执行中',
            completed: '已完成',
            failed: '失败',
            cancelled: '已取消',
            preempted: '已抢占'
        };
        return fallback[normalized] || normalized;
    }

    function initializeLogElements() {
        taskSelectElement = document.getElementById('task-select');
        executionSelectElement = document.getElementById('execution-select');
        executionSelectContainer = document.getElementById('execution-select-container');
        executionMetaRow = document.getElementById('execution-meta-row');
        executionMetaContent = document.getElementById('execution-meta-content');
    }

    function registerLogEventHandlers() {
        if (!window.AppEvents) {
            return;
        }
        logEventUnsubscribers.push(
            AppEvents.on('task_log_record', handleTaskLogRecordEvent),
            AppEvents.on('task_status', handleTaskStatusEvent)
        );
    }

    function cleanupLogEventHandlers() {
        while (logEventUnsubscribers.length) {
            const unsubscribe = logEventUnsubscribers.pop();
            if (typeof unsubscribe === 'function') {
                unsubscribe();
            }
        }
    }

    function formatBytes(bytes) {
        if (typeof bytes !== 'number' || Number.isNaN(bytes) || bytes < 0) {
            return '未知';
        }
        if (bytes < 1024) {
            return `${bytes} B`;
        }
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let value = bytes;
        let unitIndex = 0;
        while (value >= 1024 && unitIndex < units.length - 1) {
            value /= 1024;
            unitIndex += 1;
        }
        return `${value.toFixed(1)} ${units[unitIndex]}`;
    }

    function formatExecutionLabel(record) {
        if (!record) {
            return '';
        }
        const start = record.start_time ? new Date(record.start_time).toLocaleString() : '未知时间';
        const status = getStatusText(record.status || 'pending');
        return `${start} · ${status}`;
    }

    function updateExecutionSelect(records, preferredRunId = null) {
        if (!executionSelectElement || !executionSelectContainer) {
            return null;
        }
        executionSelectElement.innerHTML = '<option value="">最近一次执行</option>';

        if (!Array.isArray(records) || records.length === 0) {
            executionSelectContainer.style.display = 'none';
            currentRunId = null;
            return null;
        }

    executionSelectContainer.style.display = currentLogType === 'task' ? 'block' : 'none';
        records.forEach(record => {
            if (!record || !record.run_id) {
                return;
            }
            const option = document.createElement('option');
            option.value = record.run_id;
            option.textContent = formatExecutionLabel(record);
            option.dataset.status = record.status || '';
            option.dataset.success = record.success ? 'true' : 'false';
            option.dataset.name = record.task_name || '';
            executionSelectElement.appendChild(option);
        });

        const availableRunIds = new Set(records.filter(item => item?.run_id).map(item => item.run_id));
        let targetValue = null;
        if (preferredRunId && availableRunIds.has(preferredRunId)) {
            targetValue = preferredRunId;
        } else if (currentRunId && availableRunIds.has(currentRunId)) {
            targetValue = currentRunId;
        } else {
            targetValue = records[0]?.run_id || '';
        }

        executionSelectElement.value = targetValue || '';
        currentRunId = executionSelectElement.value || null;
        return currentRunId;
    }

    function getSelectedExecutionRecord() {
        if (!Array.isArray(taskLogRecords) || taskLogRecords.length === 0) {
            return null;
        }
        if (currentRunId) {
            const match = taskLogRecords.find(record => record.run_id === currentRunId);
            if (match) {
                return match;
            }
        }
        return taskLogRecords[0];
    }

    function updateExecutionMeta(record) {
        if (!executionMetaRow || !executionMetaContent) {
            return;
        }
        if (!record) {
            executionMetaContent.innerHTML = '';
            executionMetaRow.style.display = 'none';
            return;
        }

        const statusText = getStatusText(record.status || 'pending');
        const startTime = record.start_time ? new Date(record.start_time).toLocaleString() : '未知';
        const endTime = record.end_time ? new Date(record.end_time).toLocaleString() : (record.status === 'running' ? '进行中' : '未知');
        const durationText = typeof record.duration === 'number' ? `${record.duration.toFixed(1)} 秒` : '未知';
        const runIdShort = record.run_id ? record.run_id.slice(0, 12) : '无';
        const logSize = typeof record.log_size === 'number' ? formatBytes(record.log_size) : '未知';

        executionMetaContent.innerHTML = `
            <span><strong>执行状态:</strong> ${statusText}</span>
            <span><strong>开始:</strong> ${startTime}</span>
            <span><strong>结束:</strong> ${endTime}</span>
            <span><strong>耗时:</strong> ${durationText}</span>
            <span><strong>运行ID:</strong> ${runIdShort}</span>
            <span><strong>日志大小:</strong> ${logSize}</span>
        `;
        executionMetaRow.style.display = currentLogType === 'task' ? 'block' : 'none';
    }

    async function loadTaskExecutions(taskId) {
        if (!taskId) {
            taskLogRecords = [];
            updateExecutionSelect([], null);
            updateExecutionMeta(null);
            return;
        }

        try {
            const response = await apiRequest(`/api/logs/${taskId}/executions?limit=50`);
            const records = Array.isArray(response?.records) ? response.records : [];
            taskLogRecords = records;
            const selectedRun = updateExecutionSelect(records, currentRunId);
            currentRunId = selectedRun;
            updateExecutionMeta(getSelectedExecutionRecord());
        } catch (error) {
            console.error('加载执行记录失败:', error);
        }
    }

    function handleTaskLogRecordEvent(record) {
        if (!record || !record.task_id) {
            return;
        }
        if (currentTaskId !== record.task_id) {
            return;
        }

        taskLogRecords = [record, ...taskLogRecords.filter(item => item.run_id !== record.run_id)];
        const selectedRun = updateExecutionSelect(taskLogRecords, record.run_id);
        currentRunId = selectedRun;
        updateExecutionMeta(getSelectedExecutionRecord());

        if (currentLogType === 'task' && (!currentRunId || currentRunId === record.run_id)) {
            loadLogs();
        }
    }

    function handleTaskStatusEvent(eventData) {
        if (!eventData || !eventData.task_id) {
            return;
        }

        if (taskSelectElement) {
            const option = Array.from(taskSelectElement.options).find(opt => opt.value === eventData.task_id);
            if (option) {
                const baseName = option.dataset.name || option.textContent.replace(/\s*\(.+\)$/, '').trim();
                option.textContent = `${baseName} (${getStatusText(eventData.status)})`;
            }
        }

        if (currentTaskId === eventData.task_id && Array.isArray(taskLogRecords)) {
            const record = taskLogRecords.find(item => item.run_id === eventData.run_id);
            if (record) {
                if (eventData.status) {
                    record.status = eventData.status;
                }
                if (eventData.history) {
                    if (eventData.history.end_time) {
                        record.end_time = eventData.history.end_time;
                    }
                    if (typeof eventData.history.duration === 'number') {
                        record.duration = eventData.history.duration;
                    }
                    if (typeof eventData.history.success === 'boolean') {
                        record.success = eventData.history.success;
                    }
                }
                updateExecutionMeta(getSelectedExecutionRecord());
            }
        }
    }

    // 初始化页面
    document.addEventListener('DOMContentLoaded', async function() {
        initializeLogElements();
        registerLogEventHandlers();
        await loadTaskList();
        setupEventListeners();
        startAutoRefreshLogs();
    });

    // 设置事件监听器
    function setupEventListeners() {
        // 日志类型切换
        document.getElementById('log-type-select').addEventListener('change', async function() {
            currentLogType = this.value;
            const taskContainer = document.getElementById('task-select-container');
            if (taskContainer) {
                taskContainer.style.display = this.value === 'task' ? 'block' : 'none';
            }
            if (executionSelectContainer) {
                executionSelectContainer.style.display = (this.value === 'task' && taskLogRecords.length) ? 'block' : 'none';
            }
            if (executionMetaRow) {
                executionMetaRow.style.display = (this.value === 'task' && taskLogRecords.length) ? 'block' : 'none';
            }

            if (this.value === 'system') {
                await loadLogs();
            } else if (this.value === 'task' && currentTaskId) {
                await loadTaskExecutions(currentTaskId);
                await loadLogs();
            }
        });

        // 任务选择
        if (taskSelectElement) {
            taskSelectElement.addEventListener('change', async function() {
                currentTaskId = this.value || null;
                currentRunId = null;
                if (currentTaskId) {
                    await loadTaskExecutions(currentTaskId);
                    await loadLogs();
                } else {
                    updateExecutionSelect([], null);
                    updateExecutionMeta(null);
                    clearCurrentLog();
                }
            });
        }

        if (executionSelectElement) {
            executionSelectElement.addEventListener('change', async function() {
                currentRunId = this.value || null;
                updateExecutionMeta(getSelectedExecutionRecord());
                if (currentTaskId) {
                    await loadLogs();
                }
            });
        }

        // 搜索框回车事件
        document.getElementById('log-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterLogs();
            }
        });

        // 自动刷新切换
        document.getElementById('auto-refresh-logs').addEventListener('click', toggleAutoRefreshLogs);

        // 跟随最新日志
        document.getElementById('follow-log-switch').addEventListener('change', function() {
            if (this.checked) {
                scrollToBottom();
            }
        });
    }

    // 加载任务列表
    async function loadTaskList() {
        try {
            const tasks = await apiRequest('/api/tasks');
            if (!taskSelectElement) {
                taskSelectElement = document.getElementById('task-select');
            }
            if (!taskSelectElement) {
                return;
            }

            const previousSelection = taskSelectElement.value || currentTaskId;
            taskSelectElement.innerHTML = '<option value="">选择任务...</option>';

            tasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.dataset.name = task.name;
                option.textContent = `${task.name} (${getStatusText(task.status)})`;
                taskSelectElement.appendChild(option);
            });

            if (previousSelection && tasks.some(task => task.id === previousSelection)) {
                taskSelectElement.value = previousSelection;
                currentTaskId = previousSelection;
            }
        } catch (error) {
            console.error('加载任务列表失败:', error);
        }
    }

    // 加载日志
    async function loadLogs() {
        const lines = parseInt(document.getElementById('log-lines-limit').value);
        
        try {
            let logs;
            if (currentLogType === 'system') {
                const response = await apiRequest(`/api/logs?limit=${lines}`);
                logs = response.lines || [];
                document.getElementById('log-source-info').textContent = '系统日志';
            } else if (currentLogType === 'task' && currentTaskId) {
                if (!taskLogRecords.length) {
                    await loadTaskExecutions(currentTaskId);
                }
                const runQuery = currentRunId ? `&run_id=${encodeURIComponent(currentRunId)}` : '';
                const response = await apiRequest(`/api/logs/${currentTaskId}?lines=${lines}${runQuery}`);
                logs = response.lines || [];
                lastTaskLogSource = response.source || null;
                if (Array.isArray(response.records)) {
                    taskLogRecords = response.records;
                    const selectedRun = updateExecutionSelect(taskLogRecords, response.run_id || currentRunId);
                    currentRunId = selectedRun;
                } else if (response.run_id && !currentRunId) {
                    currentRunId = response.run_id;
                    updateExecutionSelect(taskLogRecords, currentRunId);
                }
                updateExecutionMeta(getSelectedExecutionRecord());

                const taskOption = taskSelectElement?.selectedOptions?.[0];
                const taskName = taskOption?.dataset?.name || taskOption?.textContent || '';
                const sourceLabel = lastTaskLogSource === 'temp'
                    ? '（临时日志文件）'
                    : lastTaskLogSource === 'live'
                        ? '（实时日志缓存）'
                        : '';
                const executionRecord = getSelectedExecutionRecord();
                const executionLabel = executionRecord ? `执行: ${formatExecutionLabel(executionRecord)}` : '';
                const infoParts = [`任务日志: ${taskName}`];
                if (executionLabel) {
                    infoParts.push(executionLabel);
                }
                if (sourceLabel) {
                    infoParts.push(sourceLabel);
                }
                document.getElementById('log-source-info').textContent = infoParts.filter(Boolean).join(' · ');
            } else {
                logs = [];
                document.getElementById('log-source-info').textContent = '请选择任务';
            }
            
            currentLogs = logs.map(line => typeof line === 'string' ? line : String(line));
            filteredLogs = [...currentLogs];
            
            updateLogDisplay();
            updateLogStats();
            
        } catch (error) {
            console.error('加载日志失败:', error);
            showToast('加载日志失败', 'danger');
        }
    }

    // 过滤日志
    function filterLogs() {
        const searchTerm = document.getElementById('log-search').value.toLowerCase();
        const levelFilter = document.getElementById('log-level-filter').value;
        const startTime = document.getElementById('time-filter-start').value;
        const endTime = document.getElementById('time-filter-end').value;
        
        filteredLogs = currentLogs.filter(line => {
            // 搜索关键词过滤
            if (searchTerm && !line.toLowerCase().includes(searchTerm)) {
                return false;
            }
            
            // 日志级别过滤
            if (levelFilter && !line.includes(levelFilter)) {
                return false;
            }
            
            // 时间过滤（简单实现）
            if (startTime || endTime) {
                // 这里需要解析日志中的时间戳进行比较
                // 简化实现，实际项目中需要更精确的时间解析
            }
            
            return true;
        });
        
        updateLogDisplay();
        updateLogStats();
    }

    // 更新日志显示
    function updateLogDisplay() {
        const logDisplay = document.getElementById('log-display');
        
        if (filteredLogs.length === 0) {
            logDisplay.innerHTML = `
                <div class="text-center text-muted" style="margin-top: 200px;">
                    <i class="bi bi-search" style="font-size: 4rem; opacity: 0.5;"></i>
                    <p style="font-size: 1.2rem; margin-top: 20px;">未找到匹配的日志${lastTaskLogSource === 'none' ? '（该任务没有可用日志）' : ''}</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        filteredLogs.forEach((line, index) => {
            const coloredLine = colorizeLogLine(line);
            html += `<div class="log-line" data-line="${index}">${coloredLine}</div>`;
        });
        
        logDisplay.innerHTML = html;
        
        // 如果开启跟随最新，自动滚动到底部
        if (document.getElementById('follow-log-switch').checked) {
            scrollToBottom();
        }
    }

    // 给日志行着色
    function colorizeLogLine(line) {
        // 时间戳
        line = line.replace(/(\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}[^\s]*)/g, 
            '<span style="color: #569cd6;">$1</span>');
        
        // 日志级别
        line = line.replace(/ - (DEBUG) - /g, ' - <span style="color: #808080; font-weight: bold;">$1</span> - ');
        line = line.replace(/ - (INFO) - /g, ' - <span style="color: #4ec9b0; font-weight: bold;">$1</span> - ');
        line = line.replace(/ - (WARNING) - /g, ' - <span style="color: #dcdcaa; font-weight: bold;">$1</span> - ');
        line = line.replace(/ - (ERROR) - /g, ' - <span style="color: #f44747; font-weight: bold;">$1</span> - ');
        line = line.replace(/ - (CRITICAL) - /g, ' - <span style="color: #ff6b6b; font-weight: bold;">$1</span> - ');
        
        // 模块名
        line = line.replace(/ - ([a-zA-Z_][a-zA-Z0-9_.]*) - /g, ' - <span style="color: #ce9178;">$1</span> - ');
        
        return line;
    }

    // 更新日志统计
    function updateLogStats() {
        const stats = {
            total: filteredLogs.length,
            debug: 0,
            info: 0,
            warning: 0,
            error: 0
        };
        
        filteredLogs.forEach(line => {
            if (line.includes(' DEBUG ')) stats.debug++;
            else if (line.includes(' INFO ')) stats.info++;
            else if (line.includes(' WARNING ')) stats.warning++;
            else if (line.includes(' ERROR ') || line.includes(' CRITICAL ')) stats.error++;
        });
        
        document.getElementById('log-total-lines').textContent = stats.total;
        document.getElementById('log-debug-count').textContent = stats.debug;
        document.getElementById('log-info-count').textContent = stats.info;
        document.getElementById('log-warning-count').textContent = stats.warning;
        document.getElementById('log-error-count').textContent = stats.error;
        document.getElementById('log-last-update').textContent = new Date().toLocaleTimeString();
    }

    // 刷新日志
    async function refreshLogs() {
        if (currentLogType === 'task' && currentTaskId) {
            await loadTaskExecutions(currentTaskId);
        }
        await loadLogs();
    }

    // 清空当前显示
    function clearCurrentLog() {
        document.getElementById('log-display').innerHTML = `
            <div class="text-center text-muted" style="margin-top: 200px;">
                <i class="bi bi-file-text" style="font-size: 4rem; opacity: 0.5;"></i>
                <p style="font-size: 1.2rem; margin-top: 20px;">日志已清空，点击加载按钮重新加载</p>
            </div>
        `;
        currentLogs = [];
        filteredLogs = [];
        updateLogStats();
    }

    // 滚动到顶部
    function scrollToTop() {
        document.getElementById('log-display').scrollTop = 0;
    }

    // 滚动到底部
    function scrollToBottom() {
        const logDisplay = document.getElementById('log-display');
        logDisplay.scrollTop = logDisplay.scrollHeight;
    }

    // 导出日志
    function exportLogs() {
        if (filteredLogs.length === 0) {
            showToast('没有日志可导出', 'warning');
            return;
        }
        
        const content = filteredLogs.join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `maa-scheduler-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('日志导出成功', 'success');
    }

    // 复制日志
    async function copyLogs() {
        if (filteredLogs.length === 0) {
            showToast('没有日志可复制', 'warning');
            return;
        }
        
        try {
            const content = filteredLogs.join('\n');
            await navigator.clipboard.writeText(content);
            showToast('日志已复制到剪贴板', 'success');
        } catch (error) {
            console.error('复制日志失败:', error);
            showToast('复制失败，请手动选择文本', 'danger');
        }
    }

    // 启动自动刷新
    function startAutoRefreshLogs() {
        if (autoRefreshLogsTimer) {
            clearInterval(autoRefreshLogsTimer);
        }
        
        autoRefreshLogsTimer = setInterval(() => {
            if (autoRefreshLogsEnabled && (currentLogType === 'system' || currentTaskId)) {
                refreshLogs();
            }
        }, 20000); // 每20秒刷新一次，实时更新通过事件流驱动
    }

    // 切换自动刷新
    function toggleAutoRefreshLogs() {
        autoRefreshLogsEnabled = !autoRefreshLogsEnabled;
        const button = document.getElementById('auto-refresh-logs');
        
        if (autoRefreshLogsEnabled) {
            button.innerHTML = '<i class="bi bi-pause-fill"></i> 暂停自动刷新';
            button.className = 'btn btn-sm btn-outline-primary';
            showToast('日志自动刷新已启用', 'success');
        } else {
            button.innerHTML = '<i class="bi bi-play-fill"></i> 启用自动刷新';
            button.className = 'btn btn-sm btn-outline-warning';
            showToast('日志自动刷新已暂停', 'warning');
        }
    }

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        if (autoRefreshLogsTimer) {
            clearInterval(autoRefreshLogsTimer);
        }
        cleanupLogEventHandlers();
    });
</script>
{% endblock %}