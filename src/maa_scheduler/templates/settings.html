{% extends "base.html" %}

{% block title %}系统设置 - MAA 任务调度器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-gear"></i> 系统设置</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-success" onclick="saveAllSettings()">
                <i class="bi bi-check-circle"></i> 保存设置
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadSettings()">
                <i class="bi bi-arrow-clockwise"></i> 重新加载
            </button>
        </div>
    </div>
</div>

<!-- 设置选项卡 -->
<ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
            <i class="bi bi-gear-fill"></i> 基础设置
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler" type="button" role="tab">
            <i class="bi bi-clock"></i> 调度器设置
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification" type="button" role="tab">
            <i class="bi bi-bell"></i> 通知设置
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
            <i class="bi bi-diagram-3"></i> 资源分组
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
            <i class="bi bi-sliders"></i> 高级设置
        </button>
    </li>
</ul>

<div class="tab-content" id="settingsTabContent">
    <!-- 基础设置 -->
    <div class="tab-pane fade show active" id="general" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> 应用信息</h5>
                    </div>
                    <div class="card-body">
                        <form id="general-settings-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">应用名称</label>
                                    <input type="text" class="form-control" name="app_name" value="MAA Scheduler">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">版本号</label>
                                    <input type="text" class="form-control" name="version" value="0.1.0" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Web 服务主机</label>
                                    <input type="text" class="form-control" name="web_host" value="127.0.0.1">
                                    <small class="form-text text-muted">设置为 0.0.0.0 允许外部访问</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Web 服务端口</label>
                                    <input type="number" class="form-control" name="web_port" value="8080" min="1024" max="65535">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="debug" id="debug-mode">
                                    <label class="form-check-label" for="debug-mode">
                                        启用调试模式
                                    </label>
                                    <small class="form-text text-muted d-block">调试模式会显示更详细的日志信息</small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-square"></i> 系统信息</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td>Python 版本:</td>
                                <td id="python-version">--</td>
                            </tr>
                            <tr>
                                <td>操作系统:</td>
                                <td id="os-info">--</td>
                            </tr>
                            <tr>
                                <td>启动时间:</td>
                                <td id="start-time">--</td>
                            </tr>
                            <tr>
                                <td>运行时间:</td>
                                <td id="uptime">--</td>
                            </tr>
                            <tr>
                                <td>配置文件:</td>
                                <td><span class="badge bg-success">正常</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 调度器设置 -->
    <div class="tab-pane fade" id="scheduler" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock"></i> 调度器配置</h5>
            </div>
            <div class="card-body">
                <form id="scheduler-settings-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="scheduler_enabled" id="scheduler-enabled" checked>
                                <label class="form-check-label" for="scheduler-enabled">
                                    启用任务调度器
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">最大工作线程数</label>
                            <input type="number" class="form-control" name="max_workers" value="4" min="1" max="20">
                            <small class="form-text text-muted">建议设置为 CPU 核心数</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">任务超时时间 (秒)</label>
                            <input type="number" class="form-control" name="task_timeout" value="3600" min="60">
                            <small class="form-text text-muted">单个任务的最大执行时间</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">队列检查间隔 (秒)</label>
                            <input type="number" class="form-control" name="queue_check_interval" value="5" min="1" max="60">
                            <small class="form-text text-muted">调度器检查任务队列的间隔</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">默认执行模式</label>
                        <select class="form-select" name="default_mode">
                            <option value="scheduler">自动调度模式</option>
                            <option value="single_task">单任务模式</option>
                        </select>
                        <small class="form-text text-muted">系统启动时的默认模式</small>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 通知设置 -->
    <div class="tab-pane fade" id="notification" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bell"></i> 通知配置</h5>
            </div>
            <div class="card-body">
                <form id="notification-settings-form">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="notification_enabled" id="notification-enabled">
                                <label class="form-check-label" for="notification-enabled">启用通知</label>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Webhook URL</label>
                            <input type="text" class="form-control" name="webhook_base_url" placeholder="例如: https://wxpusher.zjiecode.com/api/send/message">
                        </div>
                    </div>
                     <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Webhook UID</label>
                            <input type="text" class="form-control" name="webhook_uid" placeholder="你的 WxPusher UID">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Webhook Token</label>
                            <input type="password" class="form-control" name="webhook_token" placeholder="你的 WxPusher App Token">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>通知事件</h6>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="notify_on_startup" id="notify-startup">
                                <label class="form-check-label" for="notify-startup">系统启动</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="notify_on_shutdown" id="notify-shutdown">
                                <label class="form-check-label" for="notify-shutdown">系统关闭</label>
                            </div>
                        </div>
                    </div>
                     <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="notify_on_task_success" id="notify-task-success">
                                <label class="form-check-label" for="notify-task-success">任务成功</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="notify_on_task_failure" id="notify-task-failure">
                                <label class="form-check-label" for="notify-task-failure">任务失败</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary" onclick="testNotification()">
                            <i class="bi bi-send"></i> 发送测试通知
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 资源分组 -->
    <div class="tab-pane fade" id="resources" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-diagram-3"></i> 资源分组管理</h5>
                <button type="button" class="btn btn-sm btn-primary" onclick="addResourceGroup()">
                    <i class="bi bi-plus-circle"></i> 添加分组
                </button>
            </div>
            <div class="card-body">
                <div id="resource-groups-list">
                    <!-- 动态加载资源分组 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 高级设置 -->
    <div class="tab-pane fade" id="advanced" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-file-text"></i> 日志设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="log-settings-form">
                            <div class="mb-3">
                                <label class="form-label">日志级别</label>
                                <select class="form-select" name="log_level">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="CRITICAL">CRITICAL</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">日志文件路径</label>
                                <input type="text" class="form-control" name="log_file" value="logs/maa_scheduler.log">
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">日志文件大小限制</label>
                                    <input type="text" class="form-control" name="log_max_size" value="10MB">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">备份文件数量</label>
                                    <input type="number" class="form-control" name="log_backup_count" value="5" min="0">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-shield-check"></i> 安全设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="security-settings-form">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="enable_api_auth" id="enable-api-auth">
                                    <label class="form-check-label" for="enable-api-auth">
                                        启用 API 认证
                                    </label>
                                </div>
                                <small class="form-text text-muted">开发中功能</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">允许的主机</label>
                                <textarea class="form-control" name="allowed_hosts" rows="3" placeholder="127.0.0.1&#10;localhost&#10;*.example.com">127.0.0.1
localhost</textarea>
                                <small class="form-text text-muted">每行一个主机名或IP</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">API 限流</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="rate_limit" value="100" min="1">
                                    <span class="input-group-text">次/分钟</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-usb-plug"></i> ADB 设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="adb-settings-form">
                            <div class="mb-3">
                                <label class="form-label">ADB 可执行文件路径</label>
                                <input type="text" class="form-control" name="adb_path" placeholder="例如: /usr/bin/adb 或 adb">
                                <small class="form-text text-muted">用于前置唤醒/解锁操作的 ADB 命令路径，留空则使用系统默认。</small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据管理 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-database"></i> 数据管理</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>配置备份</h6>
                                <p class="text-muted">备份当前配置文件</p>
                                <button class="btn btn-outline-primary" onclick="backupConfig()">
                                    <i class="bi bi-download"></i> 备份配置
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>配置恢复</h6>
                                <p class="text-muted">从备份文件恢复配置</p>
                                <input type="file" class="form-control mb-2" id="config-restore-file" accept=".yaml,.yml,.json">
                                <button class="btn btn-outline-warning" onclick="restoreConfig()">
                                    <i class="bi bi-upload"></i> 恢复配置
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>重置设置</h6>
                                <p class="text-muted">恢复默认设置</p>
                                <button class="btn btn-outline-danger" onclick="resetSettings()">
                                    <i class="bi bi-arrow-clockwise"></i> 重置设置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentConfig = {};

    const getInput = (selector) => document.querySelector(selector);

    const setInputValue = (selector, value) => {
        const element = getInput(selector);
        if (element) {
            element.value = value ?? '';
        }
    };

    const setCheckboxValue = (selector, checked) => {
        const element = getInput(selector);
        if (element) {
            element.checked = Boolean(checked);
        }
    };

    const setSelectValue = (selector, value) => {
        const element = getInput(selector);
        if (element && value !== undefined && value !== null) {
            element.value = value;
        }
    };

    const toInt = (value, defaultValue = 0) => {
        const parsed = parseInt(value, 10);
        return Number.isNaN(parsed) ? defaultValue : parsed;
    };

    const escapeHtml = (value) => {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    };

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        updateSystemInfo();
    });

    // 加载设置
    async function loadSettings() {
        try {
            currentConfig = await apiRequest('/api/config');
            populateSettings(currentConfig);
            await loadResourceGroups();
        } catch (error) {
            console.error('加载设置失败:', error);
            showToast('加载设置失败', 'danger');
        }
    }

    // 填充设置表单
    function populateSettings(config) {
        const app = config?.app ?? {};
        const web = config?.web ?? {};
        const logging = config?.logging ?? {};
        const notification = app?.notification ?? {};
        const scheduler = config?.scheduler ?? {};
        const webhook = config?.webhook ?? null;

        setInputValue('input[name="app_name"]', config.app_name ?? 'MAA Scheduler');
        setInputValue('input[name="version"]', config.version ?? '0.1.0');

        setInputValue('input[name="web_host"]', web.host ?? '127.0.0.1');
        setInputValue('input[name="web_port"]', web.port ?? 8080);
        setCheckboxValue('input[name="debug"]', web.debug ?? false);

    setInputValue('input[name="adb_path"]', app.adb_path ?? 'adb');

        const schedulerEnabled = scheduler.enabled !== undefined ? scheduler.enabled : app.mode !== 'single_task';
        setCheckboxValue('input[name="scheduler_enabled"]', schedulerEnabled);
        setInputValue('input[name="max_workers"]', scheduler.max_workers ?? 4);
        setSelectValue('select[name="default_mode"]', app.mode ?? 'scheduler');
        setInputValue('input[name="task_timeout"]', app.task_timeout ?? scheduler.task_timeout ?? 3600);
        setInputValue('input[name="queue_check_interval"]', scheduler.queue_check_interval ?? 5);

        setSelectValue('select[name="log_level"]', logging.level ?? 'INFO');
        setInputValue('input[name="log_file"]', logging.file ?? 'logs/maa_scheduler.log');
        setInputValue('input[name="log_max_size"]', logging.max_size ?? '10MB');
        setInputValue('input[name="log_backup_count"]', logging.backup_count ?? 5);

        setCheckboxValue('input[name="notification_enabled"]', Boolean(webhook));
        setInputValue('input[name="webhook_base_url"]', webhook?.base_url ?? '');
        setInputValue('input[name="webhook_uid"]', webhook?.uid ?? '');
        setInputValue('input[name="webhook_token"]', webhook?.token ?? '');

        setCheckboxValue('input[name="notify_on_startup"]', notification.notify_on_startup ?? false);
        setCheckboxValue('input[name="notify_on_shutdown"]', notification.notify_on_shutdown ?? false);
        setCheckboxValue('input[name="notify_on_task_success"]', notification.notify_on_task_success ?? false);
        setCheckboxValue('input[name="notify_on_task_failure"]', notification.notify_on_task_failure ?? false);
    }

    // 加载资源分组
    async function loadResourceGroups() {
        try {
            const groupsStatus = await apiRequest('/api/resource-groups');
            const container = document.getElementById('resource-groups-list');
            const configGroups = (currentConfig?.resource_groups ?? []).reduce((acc, group) => {
                acc[group.name] = group;
                return acc;
            }, {});

            container.innerHTML = '';

            const renderedNames = new Set();

            const renderGroup = (group) => {
                const name = group.name ?? '';
                if (!name) {
                    return;
                }
                const description = group.description ?? '';
                const maxConcurrent = toInt(group.max_concurrent ?? 1, 1);
                const runningCount = toInt(group.running_count ?? 0, 0);
                const badgeClass = runningCount < maxConcurrent ? 'bg-info' : 'bg-warning';

                const groupHtml = `
                    <div class="card mb-3" data-group="${escapeHtml(name)}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" value="${escapeHtml(name)}" 
                                           placeholder="分组名称" data-field="name">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" value="${escapeHtml(description)}" 
                                           placeholder="分组描述" data-field="description">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" value="${maxConcurrent}" 
                                           min="1" max="20" placeholder="最大并发" data-field="max_concurrent">
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${badgeClass}">${runningCount}/${maxConcurrent}</span>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-outline-danger btn-sm" data-group-name="${escapeHtml(name)}" onclick="removeResourceGroup(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += groupHtml;
                renderedNames.add(name);
            };

            Object.values(groupsStatus).forEach(group => {
                const configGroup = configGroups[group.name] ?? {};
                renderGroup({
                    name: group.name,
                    description: configGroup.description ?? group.description,
                    max_concurrent: configGroup.max_concurrent ?? group.max_concurrent,
                    running_count: group.running_count ?? 0
                });
            });

            (currentConfig?.resource_groups ?? []).forEach(group => {
                if (!renderedNames.has(group.name)) {
                    renderGroup({
                        name: group.name,
                        description: group.description,
                        max_concurrent: group.max_concurrent,
                        running_count: 0
                    });
                }
            });

        } catch (error) {
            console.error('加载资源分组失败:', error);
        }
    }

    // 添加资源分组
    function addResourceGroup() {
        const container = document.getElementById('resource-groups-list');
        const newId = Date.now();
        
        const groupHtml = `
                    <div class="card mb-3" data-group="new-${newId}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" value="" 
                                   placeholder="分组名称" data-field="name">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" value="" 
                                   placeholder="分组描述" data-field="description">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" value="1" 
                                   min="1" max="20" placeholder="最大并发" data-field="max_concurrent">
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-secondary">新建</span>
                        </div>
                        <div class="col-md-1">
                                    <button class="btn btn-outline-danger btn-sm" data-group-name="new-${newId}" onclick="removeResourceGroup(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML += groupHtml;
    }

    // 移除资源分组
    function removeResourceGroup(buttonElement) {
        if (!buttonElement) {
            return;
        }
        const cardElement = buttonElement.closest('[data-group]');
        if (!cardElement) {
            return;
        }
        const groupName = cardElement.dataset.group;
        if (groupName === 'default') {
            showToast('默认资源组无法删除', 'warning');
            return;
        }
        if (confirm(`确定要删除资源分组「${groupName}」吗？`)) {
            cardElement.remove();
        }
    }

    // 保存所有设置
    async function saveAllSettings() {
        try {
            // 收集所有表单数据
            const configData = {};
            
            const updatedConfig = JSON.parse(JSON.stringify(currentConfig || {}));

            if (!updatedConfig.app) updatedConfig.app = {};
            if (!updatedConfig.app.notification) updatedConfig.app.notification = {};
            if (!updatedConfig.web) updatedConfig.web = {};
            if (!updatedConfig.logging) updatedConfig.logging = {};
            if (!updatedConfig.app) updatedConfig.app = {};

            // 基础设置
            const generalForm = document.getElementById('general-settings-form');
            if (generalForm) {
                const formData = new FormData(generalForm);
                updatedConfig.app_name = formData.get('app_name') || updatedConfig.app_name || 'MAA Scheduler';
                updatedConfig.version = formData.get('version') || updatedConfig.version || '0.1.0';
                updatedConfig.web.host = formData.get('web_host') || updatedConfig.web.host || '127.0.0.1';
                updatedConfig.web.port = toInt(formData.get('web_port') ?? updatedConfig.web.port ?? 8080, 8080);
                updatedConfig.web.debug = generalForm.querySelector('input[name="debug"]').checked;
            }

            // 调度器设置
            const schedulerForm = document.getElementById('scheduler-settings-form');
            if (schedulerForm) {
                if (!updatedConfig.scheduler) {
                    updatedConfig.scheduler = {};
                }

                const schedulerEnabledInput = schedulerForm.querySelector('input[name="scheduler_enabled"]');
                const schedulerEnabled = schedulerEnabledInput ? schedulerEnabledInput.checked : true;
                updatedConfig.scheduler.enabled = schedulerEnabled;

                const defaultMode = schedulerForm.querySelector('select[name="default_mode"]').value;
                updatedConfig.app.mode = schedulerEnabled ? (defaultMode || 'scheduler') : 'single_task';

                const maxWorkersInput = schedulerForm.querySelector('input[name="max_workers"]');
                if (maxWorkersInput) {
                    updatedConfig.scheduler.max_workers = toInt(maxWorkersInput.value || updatedConfig.scheduler.max_workers || 1, 1);
                }

                const taskTimeoutInput = schedulerForm.querySelector('input[name="task_timeout"]');
                if (taskTimeoutInput) {
                    updatedConfig.app.task_timeout = toInt(taskTimeoutInput.value || updatedConfig.app.task_timeout || 3600, 3600);
                }

                const queueIntervalInput = schedulerForm.querySelector('input[name="queue_check_interval"]');
                if (queueIntervalInput) {
                    updatedConfig.scheduler.queue_check_interval = toInt(queueIntervalInput.value || updatedConfig.scheduler.queue_check_interval || 5, 5);
                }
            }

            // 通知设置
            const notificationForm = document.getElementById('notification-settings-form');
            if (notificationForm) {
                const notificationEnabled = notificationForm.querySelector('input[name="notification_enabled"]').checked;
                const webhookBaseUrl = notificationForm.querySelector('input[name="webhook_base_url"]').value.trim();
                const webhookUid = notificationForm.querySelector('input[name="webhook_uid"]').value.trim();
                const webhookToken = notificationForm.querySelector('input[name="webhook_token"]').value.trim();

                if (notificationEnabled && webhookBaseUrl && webhookUid && webhookToken) {
                    updatedConfig.webhook = {
                        base_url: webhookBaseUrl,
                        uid: webhookUid,
                        token: webhookToken
                    };
                } else {
                    updatedConfig.webhook = null;
                }

                updatedConfig.app.notification.notify_on_startup = notificationForm.querySelector('input[name="notify_on_startup"]').checked;
                updatedConfig.app.notification.notify_on_shutdown = notificationForm.querySelector('input[name="notify_on_shutdown"]').checked;

                const notifySuccessInput = notificationForm.querySelector('input[name="notify_on_task_success"]');
                if (notifySuccessInput) {
                    updatedConfig.app.notification.notify_on_task_success = notifySuccessInput.checked;
                }

                const notifyFailureInput = notificationForm.querySelector('input[name="notify_on_task_failure"]');
                if (notifyFailureInput) {
                    updatedConfig.app.notification.notify_on_task_failure = notifyFailureInput.checked;
                }
            }

            // 日志设置
            const logForm = document.getElementById('log-settings-form');
            if (logForm) {
                const formData = new FormData(logForm);
                updatedConfig.logging.level = formData.get('log_level') || updatedConfig.logging.level || 'INFO';
                updatedConfig.logging.file = formData.get('log_file') || updatedConfig.logging.file || 'logs/maa_scheduler.log';
                updatedConfig.logging.max_size = formData.get('log_max_size') || updatedConfig.logging.max_size || '10MB';
                const backupCount = formData.get('log_backup_count');
                updatedConfig.logging.backup_count = toInt(backupCount ?? updatedConfig.logging.backup_count ?? 5, 5);
            }

            updatedConfig.resource_groups = collectResourceGroups();

            const adbForm = document.getElementById('adb-settings-form');
            if (adbForm) {
                const adbPathInput = adbForm.querySelector('input[name="adb_path"]');
                updatedConfig.app.adb_path = (adbPathInput?.value || '').trim() || 'adb';
            }

            if (!Array.isArray(updatedConfig.resource_groups) || updatedConfig.resource_groups.length === 0) {
                updatedConfig.resource_groups = [
                    { name: 'default', description: '默认资源组', max_concurrent: 1 }
                ];
            }

            if (!updatedConfig.tasks) {
                updatedConfig.tasks = currentConfig.tasks || [];
            }

            if (!updatedConfig.webhook) {
                delete updatedConfig.webhook;
            }

            const response = await apiRequest('/api/config', {
                method: 'POST',
                body: JSON.stringify(updatedConfig)
            });
            
            const message = response?.message || '设置保存成功！';
            showToast(message, 'success');
            await loadSettings(); // 重新加载以显示最新状态
            
        } catch (error) {
            console.error('保存设置失败:', error);
            showToast('保存设置失败: ' + (error.message || '未知错误'), 'danger');
        }
    }

    function collectResourceGroups() {
        const cards = document.querySelectorAll('#resource-groups-list .card');
        const groups = [];

        cards.forEach(card => {
            const nameInput = card.querySelector('[data-field="name"]');
            const descriptionInput = card.querySelector('[data-field="description"]');
            const maxConcurrentInput = card.querySelector('[data-field="max_concurrent"]');

            if (!nameInput) {
                return;
            }

            const name = nameInput.value.trim();
            if (!name) {
                return;
            }

            const description = descriptionInput ? descriptionInput.value.trim() : '';
            const maxConcurrent = maxConcurrentInput ? toInt(maxConcurrentInput.value || 1, 1) : 1;

            groups.push({
                name,
                description,
                max_concurrent: maxConcurrent
            });
        });

        return groups;
    }

    // 测试通知
    async function testNotification() {
        try {
            await apiRequest('/api/test-notification', { method: 'POST' });
            showToast('测试通知已发送', 'success');
        } catch (error) {
            console.error('发送测试通知失败:', error);
        }
    }

    // 备份配置
    function backupConfig() {
        const configData = JSON.stringify(currentConfig, null, 2);
        const blob = new Blob([configData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `maa-scheduler-config-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('配置备份已下载', 'success');
    }

    // 恢复配置
    function restoreConfig() {
        const fileInput = document.getElementById('config-restore-file');
        const file = fileInput.files[0];
        
        if (!file) {
            showToast('请选择配置文件', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                populateSettings(config);
                showToast('配置恢复成功，请保存设置', 'success');
            } catch (error) {
                showToast('配置文件格式错误', 'danger');
            }
        };
        reader.readAsText(file);
    }

    // 重置设置
    function resetSettings() {
        if (confirm('确定要重置所有设置为默认值吗？此操作不可恢复。')) {
            // 重置为默认值
            populateSettings({
                app: {
                    mode: 'scheduler',
                    task_timeout: 3600,
                    notification: {
                        notify_on_startup: false,
                        notify_on_shutdown: false,
                        notify_on_task_success: false,
                        notify_on_task_failure: false
                    }
                },
                web: {
                    host: '127.0.0.1',
                    port: 8080,
                    debug: false
                },
                logging: {
                    level: 'INFO',
                    file: 'logs/maa_scheduler.log',
                    max_size: '10MB',
                    backup_count: 5
                },
                resource_groups: [
                    { name: 'default', description: '默认资源组', max_concurrent: 1 }
                ]
            });
            showToast('设置已重置为默认值，请保存设置', 'info');
        }
    }

    // 更新系统信息
    function updateSystemInfo() {
        // 模拟系统信息（实际项目中从API获取）
        document.getElementById('python-version').textContent = 'Python 3.11.2';
        document.getElementById('os-info').textContent = 'Linux';
        document.getElementById('start-time').textContent = new Date().toLocaleString();
        
        // 更新运行时间
        setInterval(() => {
            const uptime = Math.floor((Date.now() - Date.now()) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
        }, 60000);
    }
</script>
{% endblock %}