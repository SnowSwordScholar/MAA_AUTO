{% extends "base.html" %}

{% block title %}系统设置 - MAA 任务调度器{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-gear"></i> 系统设置</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-success" onclick="saveAllSettings()">
                <i class="bi bi-check-circle"></i> 保存设置
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadSettings()">
                <i class="bi bi-arrow-clockwise"></i> 重新加载
            </button>
        </div>
    </div>
</div>

<!-- 设置选项卡 -->
<ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
            <i class="bi bi-gear-fill"></i> 基础设置
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler" type="button" role="tab">
            <i class="bi bi-clock"></i> 调度器设置
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification" type="button" role="tab">
            <i class="bi bi-bell"></i> 通知设置
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
            <i class="bi bi-diagram-3"></i> 资源分组
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
            <i class="bi bi-sliders"></i> 高级设置
        </button>
    </li>
</ul>

<div class="tab-content" id="settingsTabContent">
    <!-- 基础设置 -->
    <div class="tab-pane fade show active" id="general" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> 应用信息</h5>
                    </div>
                    <div class="card-body">
                        <form id="general-settings-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">应用名称</label>
                                    <input type="text" class="form-control" name="app_name" value="MAA Scheduler">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">版本号</label>
                                    <input type="text" class="form-control" name="version" value="0.1.0" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Web 服务主机</label>
                                    <input type="text" class="form-control" name="web_host" value="127.0.0.1">
                                    <small class="form-text text-muted">设置为 0.0.0.0 允许外部访问</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Web 服务端口</label>
                                    <input type="number" class="form-control" name="web_port" value="8080" min="1024" max="65535">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="debug" id="debug-mode">
                                    <label class="form-check-label" for="debug-mode">
                                        启用调试模式
                                    </label>
                                    <small class="form-text text-muted d-block">调试模式会显示更详细的日志信息</small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-square"></i> 系统信息</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td>Python 版本:</td>
                                <td id="python-version">--</td>
                            </tr>
                            <tr>
                                <td>操作系统:</td>
                                <td id="os-info">--</td>
                            </tr>
                            <tr>
                                <td>启动时间:</td>
                                <td id="start-time">--</td>
                            </tr>
                            <tr>
                                <td>运行时间:</td>
                                <td id="uptime">--</td>
                            </tr>
                            <tr>
                                <td>配置文件:</td>
                                <td><span class="badge bg-success">正常</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 调度器设置 -->
    <div class="tab-pane fade" id="scheduler" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock"></i> 调度器配置</h5>
            </div>
            <div class="card-body">
                <form id="scheduler-settings-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="scheduler_enabled" id="scheduler-enabled" checked>
                                <label class="form-check-label" for="scheduler-enabled">
                                    启用任务调度器
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">最大工作线程数</label>
                            <input type="number" class="form-control" name="max_workers" value="4" min="1" max="20">
                            <small class="form-text text-muted">建议设置为 CPU 核心数</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">任务超时时间 (秒)</label>
                            <input type="number" class="form-control" name="task_timeout" value="3600" min="60">
                            <small class="form-text text-muted">单个任务的最大执行时间</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">队列检查间隔 (秒)</label>
                            <input type="number" class="form-control" name="queue_check_interval" value="5" min="1" max="60">
                            <small class="form-text text-muted">调度器检查任务队列的间隔</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">默认执行模式</label>
                        <select class="form-select" name="default_mode">
                            <option value="scheduler">自动调度模式</option>
                            <option value="single_task">单任务模式</option>
                        </select>
                        <small class="form-text text-muted">系统启动时的默认模式</small>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 通知设置 -->
    <div class="tab-pane fade" id="notification" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-bell"></i> 通知配置</h5>
            </div>
            <div class="card-body">
                <form id="notification-settings-form">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        通知配置通过环境变量设置，请编辑 <code>.env</code> 文件进行配置。
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Webhook UID</label>
                            <input type="text" class="form-control" id="webhook-uid" readonly>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Webhook URL</label>
                            <input type="text" class="form-control" id="webhook-url" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>通知事件配置</h6>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="notify_on_startup" id="notify-startup" checked>
                                <label class="form-check-label" for="notify-startup">系统启动通知</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="notify_on_shutdown" id="notify-shutdown" checked>
                                <label class="form-check-label" for="notify-shutdown">系统关闭通知</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="notify_on_error" id="notify-error" checked>
                                <label class="form-check-label" for="notify-error">系统错误通知</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">通知发送间隔 (秒)</label>
                            <input type="number" class="form-control" name="notification_interval" value="60" min="10">
                            <small class="form-text text-muted">相同通知的最小发送间隔</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">通知重试次数</label>
                            <input type="number" class="form-control" name="notification_retries" value="3" min="0" max="10">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary" onclick="testNotification()">
                            <i class="bi bi-send"></i> 发送测试通知
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 资源分组 -->
    <div class="tab-pane fade" id="resources" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-diagram-3"></i> 资源分组管理</h5>
                <button type="button" class="btn btn-sm btn-primary" onclick="addResourceGroup()">
                    <i class="bi bi-plus-circle"></i> 添加分组
                </button>
            </div>
            <div class="card-body">
                <div id="resource-groups-list">
                    <!-- 动态加载资源分组 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 高级设置 -->
    <div class="tab-pane fade" id="advanced" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-file-text"></i> 日志设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="log-settings-form">
                            <div class="mb-3">
                                <label class="form-label">日志级别</label>
                                <select class="form-select" name="log_level">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO" selected>INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="CRITICAL">CRITICAL</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">日志文件路径</label>
                                <input type="text" class="form-control" name="log_file" value="logs/maa_scheduler.log">
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">日志文件大小限制</label>
                                    <input type="text" class="form-control" name="log_max_size" value="10MB">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">备份文件数量</label>
                                    <input type="number" class="form-control" name="log_backup_count" value="5" min="0">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-shield-check"></i> 安全设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="security-settings-form">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="enable_api_auth" id="enable-api-auth">
                                    <label class="form-check-label" for="enable-api-auth">
                                        启用 API 认证
                                    </label>
                                </div>
                                <small class="form-text text-muted">开发中功能</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">允许的主机</label>
                                <textarea class="form-control" name="allowed_hosts" rows="3" placeholder="127.0.0.1&#10;localhost&#10;*.example.com">127.0.0.1
localhost</textarea>
                                <small class="form-text text-muted">每行一个主机名或IP</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">API 限流</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="rate_limit" value="100" min="1">
                                    <span class="input-group-text">次/分钟</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据管理 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-database"></i> 数据管理</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>配置备份</h6>
                                <p class="text-muted">备份当前配置文件</p>
                                <button class="btn btn-outline-primary" onclick="backupConfig()">
                                    <i class="bi bi-download"></i> 备份配置
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>配置恢复</h6>
                                <p class="text-muted">从备份文件恢复配置</p>
                                <input type="file" class="form-control mb-2" id="config-restore-file" accept=".yaml,.yml,.json">
                                <button class="btn btn-outline-warning" onclick="restoreConfig()">
                                    <i class="bi bi-upload"></i> 恢复配置
                                </button>
                            </div>
                            <div class="col-md-4">
                                <h6>重置设置</h6>
                                <p class="text-muted">恢复默认设置</p>
                                <button class="btn btn-outline-danger" onclick="resetSettings()">
                                    <i class="bi bi-arrow-clockwise"></i> 重置设置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentConfig = {};

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        updateSystemInfo();
    });

    // 加载设置
    async function loadSettings() {
        try {
            currentConfig = await apiRequest('/api/config');
            populateSettings(currentConfig);
            loadResourceGroups();
        } catch (error) {
            console.error('加载设置失败:', error);
            showToast('加载设置失败', 'danger');
        }
    }

    // 填充设置表单
    function populateSettings(config) {
        // 基础设置
        if (config.app_name) document.querySelector('input[name="app_name"]').value = config.app_name;
        if (config.version) document.querySelector('input[name="version"]').value = config.version;
        if (config.web_host) document.querySelector('input[name="web_host"]').value = config.web_host;
        if (config.web_port) document.querySelector('input[name="web_port"]').value = config.web_port;
        document.querySelector('input[name="debug"]').checked = config.debug || false;

        // 调度器设置
        document.querySelector('input[name="scheduler_enabled"]').checked = config.scheduler_enabled !== false;
        if (config.max_workers) document.querySelector('input[name="max_workers"]').value = config.max_workers;
        if (config.task_timeout) document.querySelector('input[name="task_timeout"]').value = config.task_timeout;

        // 日志设置
        if (config.log_level) document.querySelector('select[name="log_level"]').value = config.log_level;
        if (config.log_file) document.querySelector('input[name="log_file"]').value = config.log_file;
        if (config.log_max_size) document.querySelector('input[name="log_max_size"]').value = config.log_max_size;
        if (config.log_backup_count) document.querySelector('input[name="log_backup_count"]').value = config.log_backup_count;

        // Webhook 设置
        if (config.webhook) {
            document.getElementById('webhook-uid').value = config.webhook.uid || '';
            document.getElementById('webhook-url').value = config.webhook.base_url || '';
        }
    }

    // 加载资源分组
    async function loadResourceGroups() {
        try {
            const groups = await apiRequest('/api/resource-groups');
            const container = document.getElementById('resource-groups-list');
            
            container.innerHTML = '';
            
            Object.values(groups).forEach((group, index) => {
                const groupHtml = `
                    <div class="card mb-3" data-group="${group.name}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <input type="text" class="form-control" value="${group.name}" 
                                           placeholder="分组名称" data-field="name">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" value="${group.description}" 
                                           placeholder="分组描述" data-field="description">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" value="${group.max_concurrent}" 
                                           min="1" max="20" placeholder="最大并发" data-field="max_concurrent">
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-info">${group.running_count}/${group.max_concurrent}</span>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeResourceGroup('${group.name}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += groupHtml;
            });
            
        } catch (error) {
            console.error('加载资源分组失败:', error);
        }
    }

    // 添加资源分组
    function addResourceGroup() {
        const container = document.getElementById('resource-groups-list');
        const newId = Date.now();
        
        const groupHtml = `
            <div class="card mb-3" data-group="new-${newId}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" value="" 
                                   placeholder="分组名称" data-field="name">
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" value="" 
                                   placeholder="分组描述" data-field="description">
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control" value="1" 
                                   min="1" max="20" placeholder="最大并发" data-field="max_concurrent">
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-secondary">新建</span>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-outline-danger btn-sm" onclick="removeResourceGroup('new-${newId}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML += groupHtml;
    }

    // 移除资源分组
    function removeResourceGroup(groupName) {
        if (confirm('确定要删除这个资源分组吗？')) {
            const groupElement = document.querySelector(`[data-group="${groupName}"]`);
            if (groupElement) {
                groupElement.remove();
            }
        }
    }

    // 保存所有设置
    async function saveAllSettings() {
        try {
            // 这里实现保存逻辑
            // 由于当前API不支持配置保存，这里只是演示
            showToast('设置保存功能开发中', 'info');
        } catch (error) {
            console.error('保存设置失败:', error);
            showToast('保存设置失败', 'danger');
        }
    }

    // 测试通知
    async function testNotification() {
        try {
            await apiRequest('/api/test-notification', { method: 'POST' });
            showToast('测试通知已发送', 'success');
        } catch (error) {
            console.error('发送测试通知失败:', error);
        }
    }

    // 备份配置
    function backupConfig() {
        const configData = JSON.stringify(currentConfig, null, 2);
        const blob = new Blob([configData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `maa-scheduler-config-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('配置备份已下载', 'success');
    }

    // 恢复配置
    function restoreConfig() {
        const fileInput = document.getElementById('config-restore-file');
        const file = fileInput.files[0];
        
        if (!file) {
            showToast('请选择配置文件', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                populateSettings(config);
                showToast('配置恢复成功，请保存设置', 'success');
            } catch (error) {
                showToast('配置文件格式错误', 'danger');
            }
        };
        reader.readAsText(file);
    }

    // 重置设置
    function resetSettings() {
        if (confirm('确定要重置所有设置为默认值吗？此操作不可恢复。')) {
            // 重置为默认值
            populateSettings({
                app_name: 'MAA Scheduler',
                version: '0.1.0',
                debug: false,
                web_host: '127.0.0.1',
                web_port: 8080,
                scheduler_enabled: true,
                max_workers: 4,
                task_timeout: 3600,
                log_level: 'INFO',
                log_file: 'logs/maa_scheduler.log',
                log_max_size: '10MB',
                log_backup_count: 5
            });
            showToast('设置已重置为默认值，请保存设置', 'info');
        }
    }

    // 更新系统信息
    function updateSystemInfo() {
        // 模拟系统信息（实际项目中从API获取）
        document.getElementById('python-version').textContent = 'Python 3.11.2';
        document.getElementById('os-info').textContent = 'Linux';
        document.getElementById('start-time').textContent = new Date().toLocaleString();
        
        // 更新运行时间
        setInterval(() => {
            const uptime = Math.floor((Date.now() - Date.now()) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
        }, 60000);
    }
</script>
{% endblock %}