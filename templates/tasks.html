{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle"></i> 任务执行
                </h5>
                <div>
                    <button id="refreshBtn" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>注意:</strong> 直接执行任务可能会与正在运行的MAA服务产生冲突。建议在服务停止时执行，或仅用于测试目的。
                </div>

                <div class="row">
                    <!-- MAA相关任务 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">MAA任务</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary task-btn" data-task="maa_roguelike">
                                        <i class="bi bi-play-fill"></i> 执行MAA肉鸽
                                    </button>
                                    <button class="btn btn-info task-btn" data-task="recruitment">
                                        <i class="bi bi-person-plus"></i> 执行公招任务
                                    </button>
                                </div>
                                <hr>
                                <h6>每日任务</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success task-btn" data-task="clear_stamina">
                                        <i class="bi bi-battery"></i> 清体力任务
                                    </button>
                                    <button class="btn btn-warning task-btn" data-task="clear_materials">
                                        <i class="bi bi-box"></i> 清材料任务
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BAAH任务 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">BAAH任务</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-secondary task-btn" data-task="baah">
                                        <i class="bi bi-robot"></i> 执行BAAH任务
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        BAAH任务会自动切换到1280x720分辨率
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 任务执行历史 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history"></i> 执行历史
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="taskHistory" class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>任务类型</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">暂无执行记录</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务输出模态框 -->
<div class="modal fade" id="taskOutputModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务输出</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>任务类型:</strong> <span id="modalTaskType"></span><br>
                    <strong>执行时间:</strong> <span id="modalExecuteTime"></span><br>
                    <strong>执行状态:</strong> <span id="modalExecuteStatus"></span>
                </div>
                <div class="bg-light p-3 rounded">
                    <pre id="modalTaskOutput" class="mb-0" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let taskHistory = [];

    // 任务名称映射
    const taskNames = {
        'maa_roguelike': 'MAA肉鸽',
        'recruitment': '公招任务',
        'clear_stamina': '清体力任务',
        'clear_materials': '清材料任务',
        'baah': 'BAAH任务'
    };

    // 执行任务
    async function executeTask(taskType) {
        const button = document.querySelector(`[data-task="${taskType}"]`);
        const originalText = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 执行中...';
        
        const startTime = new Date();
        
        try {
            const response = await axios.post(`/api/task/${taskType}`);
            const endTime = new Date();
            
            const historyItem = {
                taskType: taskType,
                taskName: taskNames[taskType] || taskType,
                startTime: startTime,
                endTime: endTime,
                success: response.data.success,
                output: response.data.output
            };
            
            taskHistory.unshift(historyItem);
            updateHistoryTable();
            
            if (response.data.success) {
                showNotification(`${taskNames[taskType]}执行成功！`, 'success');
            } else {
                showNotification(`${taskNames[taskType]}执行失败！`, 'error');
            }
            
            // 显示输出模态框
            showTaskOutput(historyItem);
            
        } catch (error) {
            const endTime = new Date();
            const historyItem = {
                taskType: taskType,
                taskName: taskNames[taskType] || taskType,
                startTime: startTime,
                endTime: endTime,
                success: false,
                output: error.message
            };
            
            taskHistory.unshift(historyItem);
            updateHistoryTable();
            handleError(error);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // 更新历史记录表格
    function updateHistoryTable() {
        const tbody = document.getElementById('historyTableBody');
        
        if (taskHistory.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无执行记录</td></tr>';
            return;
        }
        
        tbody.innerHTML = taskHistory.slice(0, 10).map((item, index) => `
            <tr>
                <td>${item.startTime.toLocaleString('zh-CN')}</td>
                <td>${item.taskName}</td>
                <td>
                    <span class="badge bg-${item.success ? 'success' : 'danger'}">
                        ${item.success ? '成功' : '失败'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showTaskOutput(taskHistory[${index}])">
                        <i class="bi bi-eye"></i> 查看
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // 显示任务输出
    function showTaskOutput(historyItem) {
        document.getElementById('modalTaskType').textContent = historyItem.taskName;
        document.getElementById('modalExecuteTime').textContent = 
            `${historyItem.startTime.toLocaleString('zh-CN')} - ${historyItem.endTime.toLocaleString('zh-CN')}`;
        document.getElementById('modalExecuteStatus').innerHTML = 
            `<span class="badge bg-${historyItem.success ? 'success' : 'danger'}">${historyItem.success ? '成功' : '失败'}</span>`;
        document.getElementById('modalTaskOutput').textContent = historyItem.output || '无输出';
        
        const modal = new bootstrap.Modal(document.getElementById('taskOutputModal'));
        modal.show();
    }

    // 事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        // 任务按钮事件
        document.querySelectorAll('.task-btn').forEach(button => {
            button.addEventListener('click', function() {
                const taskType = this.getAttribute('data-task');
                if (confirm(`确定要执行${taskNames[taskType]}吗？`)) {
                    executeTask(taskType);
                }
            });
        });
        
        // 刷新按钮
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });
        
        updateHistoryTable();
    });
</script>
{% endblock %}