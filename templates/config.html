{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> 系统配置
                </h5>
                <div>
                    <button id="saveBtn" class="btn btn-success">
                        <i class="bi bi-save"></i> 保存配置
                    </button>
                    <button id="resetBtn" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> 重置
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>注意:</strong> 修改配置后需要重启MAA服务才能生效。
                </div>

                <form id="configForm">
                    <!-- MAA基础配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">MAA基础配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="maa_command" class="form-label">MAA命令</label>
                                        <input type="text" class="form-control" id="maa_command" name="MAA.maa_command">
                                    </div>
                                    <div class="mb-3">
                                        <label for="maa_timeout" class="form-label">超时时间(秒)</label>
                                        <input type="number" class="form-control" id="maa_timeout" name="MAA.maa_timeout">
                                    </div>
                                    <div class="mb-3">
                                        <label for="screen_resolution" class="form-label">屏幕分辨率</label>
                                        <input type="text" class="form-control" id="screen_resolution" name="MAA.screen_resolution">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="adb_command" class="form-label">ADB命令</label>
                                        <textarea class="form-control" id="adb_command" name="MAA.adb_command" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 调度配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">调度配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="run_time_start" class="form-label">开始时间</label>
                                        <input type="number" class="form-control" id="run_time_start" name="Schedule.run_time_start" min="0" max="23">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="run_time_end" class="form-label">结束时间</label>
                                        <input type="number" class="form-control" id="run_time_end" name="Schedule.run_time_end" min="0" max="23">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="restart_delay" class="form-label">重启延迟(秒)</label>
                                        <input type="number" class="form-control" id="restart_delay" name="Schedule.restart_delay">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 公招配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">公招配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="recruitment_command" class="form-label">公招命令</label>
                                        <input type="text" class="form-control" id="recruitment_command" name="Recruitment.command">
                                    </div>
                                    <div class="mb-3">
                                        <label for="interval_hours" class="form-label">执行间隔(小时)</label>
                                        <input type="number" class="form-control" id="interval_hours" name="Recruitment.interval_hours" step="0.5" min="0.5">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="senior_operator_keyword" class="form-label">资深干员关键词</label>
                                        <input type="text" class="form-control" id="senior_operator_keyword" name="Recruitment.senior_operator_keyword">
                                    </div>
                                    <div class="mb-3">
                                        <label for="top_operator_keyword" class="form-label">高级资深干员关键词</label>
                                        <input type="text" class="form-control" id="top_operator_keyword" name="Recruitment.top_operator_keyword">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 每日任务配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">每日任务配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>清体力任务</h6>
                                    <div class="mb-3">
                                        <label for="start_day_command" class="form-label">命令</label>
                                        <input type="text" class="form-control" id="start_day_command" name="DailyTasks.start_day_command">
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="start_day_time_start" class="form-label">开始时间</label>
                                                <input type="number" class="form-control" id="start_day_time_start" name="DailyTasks.start_day_time_start" step="0.5">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="start_day_time_end" class="form-label">结束时间</label>
                                                <input type="number" class="form-control" id="start_day_time_end" name="DailyTasks.start_day_time_end" step="0.5">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>清材料任务</h6>
                                    <div class="mb-3">
                                        <label for="end_day_command" class="form-label">命令</label>
                                        <input type="text" class="form-control" id="end_day_command" name="DailyTasks.end_day_command">
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="end_day_time_start" class="form-label">开始时间</label>
                                                <input type="number" class="form-control" id="end_day_time_start" name="DailyTasks.end_day_time_start" step="0.5">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="end_day_time_end" class="form-label">结束时间</label>
                                                <input type="number" class="form-control" id="end_day_time_end" name="DailyTasks.end_day_time_end" step="0.5">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BAAH配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">BAAH配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="baah_command" class="form-label">BAAH命令</label>
                                        <input type="text" class="form-control" id="baah_command" name="BAAH.command">
                                    </div>
                                    <div class="mb-3">
                                        <label for="baah_screen_resolution" class="form-label">屏幕分辨率</label>
                                        <input type="text" class="form-control" id="baah_screen_resolution" name="BAAH.screen_resolution">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="baah_time_start" class="form-label">开始时间</label>
                                                <input type="number" class="form-control" id="baah_time_start" name="BAAH.time_start" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label for="baah_time_end" class="form-label">结束时间</label>
                                                <input type="number" class="form-control" id="baah_time_end" name="BAAH.time_end" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 通知配置 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">通知配置</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="webhook_url" class="form-label">WebHook URL</label>
                                <input type="url" class="form-control" id="webhook_url" name="Notification.webhook_url">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let originalConfig = {};

    // 加载配置
    async function loadConfig() {
        try {
            const response = await axios.get('/api/config');
            originalConfig = response.data;
            
            // 填充表单
            for (const [section, options] of Object.entries(originalConfig)) {
                for (const [key, value] of Object.entries(options)) {
                    const input = document.querySelector(`[name="${section}.${key}"]`);
                    if (input) {
                        input.value = value;
                    }
                }
            }
        } catch (error) {
            handleError(error);
        }
    }

    // 保存配置
    async function saveConfig() {
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.innerHTML;
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 保存中...';
        
        try {
            const formData = new FormData(document.getElementById('configForm'));
            const config = {};
            
            for (const [key, value] of formData.entries()) {
                const [section, option] = key.split('.');
                if (!config[section]) {
                    config[section] = {};
                }
                config[section][option] = value;
            }
            
            const response = await axios.post('/api/config', config);
            
            if (response.data.success) {
                showNotification('配置保存成功！需要重启服务才能生效。', 'success');
                originalConfig = config;
            } else {
                showNotification(response.data.message, 'error');
            }
        } catch (error) {
            handleError(error);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // 重置配置
    function resetConfig() {
        if (confirm('确定要重置所有配置到上次保存的状态吗？')) {
            for (const [section, options] of Object.entries(originalConfig)) {
                for (const [key, value] of Object.entries(options)) {
                    const input = document.querySelector(`[name="${section}.${key}"]`);
                    if (input) {
                        input.value = value;
                    }
                }
            }
            showNotification('配置已重置', 'success');
        }
    }

    // 事件监听器
    document.getElementById('saveBtn').addEventListener('click', saveConfig);
    document.getElementById('resetBtn').addEventListener('click', resetConfig);

    // 初始化
    document.addEventListener('DOMContentLoaded', loadConfig);
</script>
{% endblock %}