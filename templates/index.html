{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card status-card {{ 'stopped' if not status.active else '' }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-circle-fill text-{{ 'success' if status.active else 'danger' }}"></i>
                    服务状态: {{ '运行中' if status.active else '已停止' }}
                </h5>
                <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>服务信息</h6>
                        <ul class="list-unstyled">
                            <li><strong>服务名称:</strong> maa-auto</li>
                            <li><strong>当前状态:</strong> 
                                <span class="badge bg-{{ 'success' if status.active else 'danger' }}">
                                    {{ status.status }}
                                </span>
                            </li>
                            <li><strong>最后更新:</strong> <span id="lastUpdate"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>快速操作</h6>
                        <div class="btn-group-vertical d-grid gap-2">
                            <button id="startBtn" class="btn btn-success" {{ 'disabled' if status.active else '' }}>
                                <i class="bi bi-play-circle"></i> 启动服务
                            </button>
                            <button id="stopBtn" class="btn btn-danger" {{ 'disabled' if not status.active else '' }}>
                                <i class="bi bi-stop-circle"></i> 停止服务
                            </button>
                            <button id="restartBtn" class="btn btn-warning">
                                <i class="bi bi-arrow-clockwise"></i> 重启服务
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-file-text"></i> 最近日志
                </h5>
            </div>
            <div class="card-body">
                <div id="logContainer" class="log-container p-3">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('logs_page') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> 查看完整日志
                    </a>
                    <button id="refreshLogsBtn" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> 刷新日志
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-task"></i> 快速任务
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('tasks_page') }}" class="btn btn-primary">
                        <i class="bi bi-play-circle"></i> 执行任务
                    </a>
                    <a href="{{ url_for('config_page') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-gear"></i> 修改配置
                    </a>
                    <a href="{{ url_for('logs_page') }}" class="btn btn-outline-info">
                        <i class="bi bi-file-text"></i> 查看日志
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> 系统信息
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><strong>配置文件:</strong> config.ini</li>
                    <li><strong>日志文件:</strong> logs/maa_auto.log</li>
                    <li><strong>Python版本:</strong> <span id="pythonVersion">检测中...</span></li>
                    <li><strong>当前时间:</strong> <span id="currentTime"></span></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let refreshInterval;

    // 更新当前时间
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
    }

    // 更新最后更新时间
    function updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleString('zh-CN');
    }

    // 加载状态
    async function loadStatus() {
        try {
            const response = await axios.get('/api/status');
            const status = response.data;
            
            // 更新状态显示
            const statusCard = document.querySelector('.status-card');
            const statusBadge = document.querySelector('.badge');
            const statusText = document.querySelector('.card-header h5');
            
            if (status.active) {
                statusCard.classList.remove('stopped');
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = status.status;
                statusText.innerHTML = '<i class="bi bi-circle-fill text-success"></i> 服务状态: 运行中';
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
            } else {
                statusCard.classList.add('stopped');
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = status.status;
                statusText.innerHTML = '<i class="bi bi-circle-fill text-danger"></i> 服务状态: 已停止';
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
            
            updateLastUpdateTime();
        } catch (error) {
            handleError(error);
        }
    }

    // 加载日志
    async function loadLogs() {
        try {
            const response = await axios.get('/api/logs?lines=20');
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<pre>' + response.data.logs + '</pre>';
            logContainer.scrollTop = logContainer.scrollHeight;
        } catch (error) {
            document.getElementById('logContainer').innerHTML = '<div class="text-danger">加载日志失败</div>';
        }
    }

    // 服务控制
    async function controlService(action) {
        const button = document.getElementById(action + 'Btn');
        const originalText = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 执行中...';
        
        try {
            const response = await axios.post(`/api/service/${action}`);
            if (response.data.success) {
                showNotification(response.data.message, 'success');
                setTimeout(loadStatus, 2000);  // 2秒后刷新状态
            } else {
                showNotification(response.data.message, 'error');
            }
        } catch (error) {
            handleError(error);
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // 事件监听器
    document.getElementById('startBtn').addEventListener('click', () => controlService('start'));
    document.getElementById('stopBtn').addEventListener('click', () => controlService('stop'));
    document.getElementById('restartBtn').addEventListener('click', () => controlService('restart'));
    document.getElementById('refreshBtn').addEventListener('click', loadStatus);
    document.getElementById('refreshLogsBtn').addEventListener('click', loadLogs);

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        loadStatus();
        loadLogs();
        
        // 定期刷新状态和日志
        refreshInterval = setInterval(() => {
            loadStatus();
            loadLogs();
        }, 30000); // 30秒刷新一次
    });

    // 页面离开时清理定时器
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}