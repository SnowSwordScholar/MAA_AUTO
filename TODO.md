# MAA 自动化任务调度器 - TODO

> 内部开发备忘，记录开发计划和进度。

## 🎯 下一步核心开发任务

### 1. **调度器逻辑重构**
- [x] **触发器实现调整**:
  - [x] **定时执行 (`scheduled`)**: 确保任务只在设定的时间段内（如 09:00-18:00）被触发。
  - [x] **间隔执行 (`interval`)**: 触发逻辑改为从【上一次任务执行完毕】后开始计算间隔。
  - [x] **随机时间执行 (`random_time`)**: 在设定的时间段内（如 10:00-12:00）随机选择一个时间点执行。
- [x] **任务队列与优先级**:
  - [x] 实现基于优先级的任务排队。
  - [x] 处理任务冲突（如资源组占用），实现任务的暂停和重新排队。

### 2. **执行器功能增强**
- [x] **前置任务**:
  - [x] **模拟器任务**: 集成 ADB 命令，实现自动唤醒屏幕。
  - [ ] (暂缓) 分辨率设置和应用启动。
- [x] **后置任务**:
  - [x] **日志关键词抓取**: 实现对临时任务日志的关键词扫描。
  - [x] **自定义通知**: 根据关键词匹配结果，发送包含自定义标题、Tag和内容的通知。

### 3. **Web 界面功能**
- [x] **实现设置保存**:
  - [x] 后端提供 `/api/config` 接口，支持 GET/POST 将修改持久化到 `config.yaml`。
  - [x] 前端设置页面的“保存”按钮支持提交配置并展示提示状态。
- [x] **任务编辑器完善**:
  - [x] 调整表单以匹配新的触发器配置（时间段、随机区间等）。
  - [x] 新增 ADB 唤醒、日志和推送通知的配置项。
- [x] **任务实时日志与通知分类**:
  - [x] 前端新增实时日志侧边栏并接入自动刷新。
  - [x] 异常关键词和任务结果推送分类展示。

### 4. **配置系统完善**
- [x] **模型更新**:
  - [x] 更新 `config.py` 中的 Pydantic 模型以匹配新的任务流程。
- [x] **通知开关**:
  - [x] 在 `config.yaml` 中增加 `notify_on_startup` 和 `notify_on_shutdown` 开关。
  - [x] 在主程序中根据配置决定是否发送启动/关闭通知。

### 5. **测试**
- [x] 现有 CLI/调度流程的基础回归脚本。
- [ ] 将历史异步脚本迁移到统一的 pytest + asyncio 测试框架。
- [ ] 为手动运行与实时日志补充集成测试用例。

### 6. **调度器控制增强**
- [x] 手动运行任务遵守资源组约束，支持在停止调度器后单次执行。
- [x] 暴露 `/api/scheduler/start|stop|mode` 接口供前端控制调度模式。
- [x] 持久化调度模式状态并在前端 UI 中实时同步。
- [ ] 优化资源组占用检测，避免多次加载配置导致状态抹除。

### 7. **运行与部署**
- [ ] 编写面向 `uv run` 的一键开发/调试指南。
- [ ] 整理 `start.sh` 与 `scripts/dev_start.sh`，减少重复配置。

---

## ✅ 已完成/待清理的功能

- [x] **系统基础架构**: CLI、Web服务、基本调度循环。
- [x] **基础Web界面**: 仪表板、任务列表、监控、日志、设置页面框架。
- [x] **基础通知**: 系统启动/关闭、任务成功/失败的 Webhook 推送。
- [x] **资源分组概念**: 已有基本模型，待实现调度逻辑。
- [x] **日志系统**: 已支持全局和临时日志记录。
- [x] **修复 `AttributeError`**: 解决了由于代码重复和不正确的配置调用导致的一系列启动错误。
- [x] **修复通知服务错误**: 解决了由于占位符 URL 导致的 `ClientConnectorDNSError`。
- [x] **修复资源组警告**: 将任务配置文件中的 `general` 资源组更正为 `default`。


# 很重要不要覆盖：使用 uv run 运行项目